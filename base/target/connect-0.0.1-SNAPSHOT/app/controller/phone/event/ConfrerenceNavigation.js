Ext.define("Personify.controller.phone.event.ConfrerenceNavigation",{extend:"Personify.base.Controller",config:{menuStore:null,countLoad:0,maxCountLoad:2},control:{confrerenceNavigationView:true,menueventPanelPhone:{live:true,listeners:{requestchangeview:"onRequestChangeView",requestopendetail:"openView",backtoevent:"onBackToEvent"}}},init:function(){this.getMenueventPanelPhone().getController().setRecord(this.getView().getRecord());this.onLoadMenuStore();this.onLoadSponsorEvents()},onLoadSponsorEvents:function(){var c=this,a=this.getView().getRecord(),b=a.SponsorListEvent;Personify.utils.ItemUtil.getSponsorListFromJsonFile(Personify.utils.Configuration.getConfiguration().getAt(0).EventsStore.get("sponsorEvents"),a.get("productID"),b,function(){c.getMenueventPanelPhone().getController().setDataSponsorCarousel(b)})},onLoadMenuStore:function(){var a=this.getView().getRecord();var d=this;var e=Ext.create("Personify.store.base.EventMenu");var b="data/SimpleEventMenuPhone.json";if(a.get("isConference")==true){b="data/ComplexEventMenuPhone.json"}var c={type:"ajax",url:b,reader:{type:"json",rootProperty:"menu"}};e.setProxy(c);e.load({callback:function(g,f,h){d.setMenuStore(e);if(a.get("isConference")){d.getAllDataOfChild()}else{d.getMenueventPanelPhone().getController().onUpdateValue(a,e,"Event Home");d.getMenueventPanelPhone().getController().updateMenu(a)}}})},openView:function(a,c){if(typeof a=="string"){a=Ext.create(a,c)}a.addListener("back",this.onBack,this);a.addListener("backtomain",this.onBackToMain,this);a.addListener("requestchangeview",this.onRequestChangeView,this);a.addListener("requestopendetail",this.openView,this);a.addListener("removeagenda",this.onRemoveAgenda,this);a.addListener("addagenda",this.onAddAgenda,this);a.addListener("refreshagenda",this.onRefreshAgenda,this);a.addListener("updatecurrentuser",this.onUpdateCurrentUser,this);if(c&&c!=null){var d=c.record.get("listeners");if(d){for(var e in d){this.getView().addListener(e,d[e],a)}}}var b=this.getConfrerenceNavigationView();if(b.getActiveItem().xtype!=a.xtype){b.push(a)}},onRequestChangeView:function(a,b){this.getView().fireEvent("requestchangeview",a,b)},onBack:function(){this.getConfrerenceNavigationView().pop()},onBackToMenu:function(){var c=this,a=c.getConfrerenceNavigationView(),b=a.getInnerItems().length;if(b>1){a.popToRoot()}},onBackToMain:function(){this.getView().fireEvent("backtomain")},onBackToEvent:function(){this.getView().fireEvent("back")},onRemoveAgenda:function(a,b){this.getView().fireEvent("removeagenda",a,b)},onRefreshAgenda:function(a,b,c){this.getView().fireEvent("refreshagenda",c)},onUpdateCurrentUser:function(a,c){var b=this;this.getView().fireEvent("updatecurrentuser",a,function(){b.getAllDataOfChild();b.onBackToMenu()})},getAllDataOfChild:function(){var c=this.getView().getRecord();var a=Personify.utils.Configuration.getCurrentUser();var d="";this.setCountLoad(0);if(Ext.Viewport.getOrientation()=="landscape"){d="p-phone-loading-normal-events-landscape"}else{d="p-phone-loading-normal-events-portrait"}var b={xtype:"loadmask",message:"Loading..",fullscreen:true,centered:true,cls:d};Ext.Viewport.setMasked(b);this.onGetSesstionListData();this.onGetExhibitorData()},removeMask:function(){var c=this.getMaxCountLoad();this.setCountLoad(this.getCountLoad()+1);if(this.getCountLoad()>=c){var a=this.getView().getRecord();var b=this.getMenuStore();this.getMenueventPanelPhone().getController().onUpdateValue(a,b,a.getData().shortName);this.getMenueventPanelPhone().getController().updateMenu(a);Ext.Viewport.setMasked(false)}},onGetSesstionListData:function(){var f=this;var c=this.getView().getRecord();var a=Personify.utils.Configuration.getCurrentUser();var d={MeetingID:c.get("productID"),IsStaffMember:a?a.isStaffMember().toString():false,IsMember:a?a.isMember().toString():false,ItemsPerPage:"100000",StartIndex:"0"};var g=Personify.utils.ServiceManager.getStoreManager();var b=g.getSessionStore();var e=Ext.create(b);e.setDataRequest(d);c.SessionStore=e;e.load({scope:f,callback:function(){f.removeMask();if(a&&a.isLogged()){this.setMaxCountLoad(4);this.onGetMeetingAgendaData();this.onGetMeetingRegistrantData()}else{this.setMaxCountLoad(2)}}})},onGetMeetingAgendaData:function(){var h=this;var d=this.getView().getRecord();var b=Personify.utils.Configuration.getCurrentUser();if(b&&b.isLogged()){var i=b.get("masterCustomerId");var g=b.get("subCustomerId");var c={SubCustomerID:g,MeetingID:d.get("productID"),MasterCustomerID:i};var a=Personify.utils.ServiceManager.getStoreManager();var f=a.getAgendaStore();var e=Ext.create(f);e.setDataRequest(c);d.MeetingAgendaStore=e;e.load({scope:h,callback:function(){var p=h.getView().getRecord().SessionStore;var n=h.getView().getRecord().MeetingAgendaStore;for(var l=0;l<p.getCount();l++){var o=p.getAt(l);for(var k=0;k<n.getCount();k++){var m=n.getAt(k);if(m&&m!=""&&m!="0"){if(o.get("sessionID")==m.get("sessionID")){o.set("appointmentId",m.get("appointmentId"));o.set("isAdded",true);break}}}}h.removeMask()}})}},onGetMeetingRegistrantData:function(){var d=this;var b=this.getView().getRecord();var a=Personify.utils.Configuration.getCurrentUser();var c={IsStaffMember:a?a.isStaffMember().toString():false,ItemsPerPage:"10000",MasterCustomerID:a?a.get("masterCustomerId"):"",SubCustomerID:a?a.get("subCustomerId"):"",ProductID:b.get("productID"),StartIndex:"0"};var g=Personify.utils.ServiceManager.getStoreManager();var f=g.getAttendeeStore();var e=Ext.create(f);e.setDataRequest(c);b.MeetingRegistrantStore=e;e.load({scope:d,callback:d.removeMask})},onGetExhibitorData:function(){var e=this;var c=this.getView().getRecord();var b=Personify.utils.Configuration.getCurrentUser();var d={ItemsPerPage:"100000",XbtID:c.get("xbtProductID"),XbtParentProduct:c.get("xbtParentProduct"),StartIndex:"0",XbtProductCode:c.get("xbtProductCode")};var h=Personify.utils.ServiceManager.getStoreManager();var f=h.getExhibitorStore();var g=Ext.create(f);var a=Ext.create(f);g.setDataRequest(d);c.ExhibitorStore=g;g.load({scope:e,callback:function(j,i,k){e.getAllExhibitorFromSql(c,b,g);e.removeMask()}})},getAllExhibitorFromSql:function(g,d,b){var i=this;var a=Personify.utils.ServiceManager.getStoreManager();var c=a.getExhibitorStore();var f=Ext.create(c);var e=g.get("productID")||null;var j=d.get("masterCustomerId");var h=d.get("subCustomerId");Personify.utils.Sqlite.getMyExhibitor(e,j,h,function(k){if(typeof k=="object"&&k.length>0){b.each(function(m){for(var l=0;l<k.length;l++){if(k[l].exhibitorId==m.get("recordId")){if(!m.get("isAdded")){m.set("isAdded",true)}f.add(m);break}}})}g.MyExhibitorStore=f})},onRemoveAgenda:function(a,b){this.getView().fireEvent("removeagenda",a,b)},onAddAgenda:function(a,b,c){this.getView().fireEvent("addagenda",a,b,c)}});