Ext.define("Personify.controller.phone.event.EventPanel",{extend:"Personify.controller.event.Event",inject:"personify",config:{location:null,topic:null,searchText:null,eventRecord:null,flagSelected:false,futureEvents:null,currentStore:null,itemSelected:false,expandEvent:null,indexExpandEvent:null,isSelectAll:false},control:{eventToolbar:{onNavigationButtonTap:"onBack",actionButtonTap:"addPersonalEvent"},eventListFilter:{gotomyschedule:"goToMySchedule",locationbtntap:"onLocationbtnTap",topicbtntap:"onTopicbtnTap",seachkeyup:"onTapSearchButton",clearicontap:"onClearIconTap"},selectEventItem:{eventitemtap:"onEventItemTap",select:"onSelectEventItem"},selectEventPanel:true,locationList:{itemtap:"onItemLocationTap"},filterTopicList:{onsubmitfilter:"onSubmitFilterTopic"},locationListPanel:true,clearLocationButton:{tap:"clearLocationSelectTap"}},init:function(){var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){this.getEventToolbar().getController().setActionText(" + Add")}else{this.getEventToolbar().getController().setActionText("Login")}},updateRecordForSelectItems:function(c){var a=Personify.utils.Configuration.getCurrentUser();var b=a.getEventMonthStore(c);if(b.getCount()<=0){this.getSelectEventItem().setDeferEmptyText(false);this.getSelectEventItem().setEmptyText('<div style = "color: black; font-size: 13px;" class = "emptyText">No events found with your search criteria.</div>')}this.getSelectEventItem().setStore(b);this.getSelectEventPanel().setStore(c)},onGetData:function(){var a=this;a.getView().setMasked({xtype:"loadmask"});Ext.callback(function(){var d=Ext.getStore("meetingListtingMain");var c=Ext.getStore("iCalendarStoreMain");var e=c?c.getAt(0):null;if(e!=null){a.getLocationList().setStore(e.LocationListCountStore);a.getFilterTopicList().setStore(e.TopicListCountStore)}if(d&&d.getCount()>0){var h=Personify.utils.ServiceManager.getStoreManager();var b=h.getEventListStore();var g=Ext.create(b);var f=Ext.getStore("agendaStoreListMain");d.each(function(j){if(f){for(var k=0;k<f.getCount();k++){var l=f.getAt(k);if(l.get("type")!="PERSONAL"){if(!l.get("sessionID")||l.get("sessionID")==""||l.get("sessionID")=="0"){if(l.get("meetingId")==j.get("productID")){if(!j.get("appointmentId")||j.get("appointmentId")==""){j.set("appointmentId",l.get("appointmentId"))}if(!j.get("isAdded")){j.set("isAdded",true)}break}}}else{if(l.get("meetingId")==j.get("productID")){if(!j.get("isAdded")){j.set("isAdded",true)}}}}}g.add(j)});a.updateRecordForSelectItems(g);a.getView().setMasked(false)}else{a.onUpdateEventList()}},a,[],1)},onEventItemTap:function(b){var a=this;Ext.callback(function(){a.openView(b)},a,[],1)},openView:function(a){this.getView().fireEvent("requestopendetail","Personify.view.phone.event.EventDetail",{record:a})},onUpdateEventList:function(){var g=this;var b=g.getSelectEventItem();var c=Personify.utils.Configuration.getCurrentUser();if(c&&c.isLogged()){this.getEventToolbar().getController().setActionText(" + Add")}else{this.getEventToolbar().getController().setActionText("Login")}var e={IsStaffMember:c?c.isStaffMember().toString():false,IsMember:true,FromMonth:"1",ToMonth:"12",OrgID:c.get("organizationId"),OrgUnitID:c.get("organizationUnitId"),MasterCustomerID:(c&&c.isLogged())?c.get("masterCustomerId"):"",SubCustomerID:(c&&c.isLogged())?c.get("subCustomerId"):"0"};var a=Personify.utils.ServiceManager.getStoreManager();var d=a.getICalendarStore();var j=Ext.create(d);var h=Ext.create(d);var k=a.getEventListStore();var i=Ext.create(k);var f=Ext.getStore("agendaStoreListMain");i.setStoreId("meetingListtingMain");h.setStoreId("iCalendarStoreMain");j.setDataRequest(e);j.load({callback:function(m,l,o){g.getView().setMasked(false);if(o){j.getAt(0).EventListStore.each(function(p){if(f){for(var q=0;q<f.getCount();q++){var r=f.getAt(q);if(r.get("type")!="PERSONAL"){if(!r.get("sessionID")||r.get("sessionID")==""||r.get("sessionID")=="0"){if(r.get("meetingId")==p.get("productID")){if(!p.get("appointmentId")||p.get("appointmentId")==""){p.set("appointmentId",r.get("appointmentId"))}if(!p.get("isAdded")){p.set("isAdded",true)}break}}}}}i.add(p)});j.each(function(p){h.add(p)});g.updateRecordForSelectItems(i);var n=j.getAt(0);g.getLocationList().setStore(n.LocationListCountStore);g.getFilterTopicList().setStore(n.TopicListCountStore)}},scope:this})},onBack:function(){this.getView().fireEvent("backtomain",this)},goToMySchedule:function(){var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){this.getView().fireEvent("requestchangeview","Personify.view.phone.Schedule",null)}else{this.getView().fireEvent("requestopendetail","Personify.view.phone.login.LoginPhone",null)}},onItemLocationTap:function(g,b,f,a,d,c){this.getLocationListPanel().hide();this.filterByLocation(a)},filterByLocation:function(a){this.setLocation(null);this.checkAndCompileFilter();var b=this.getSelectEventPanel().getStore();b.filter(function(c){if(c.get("locationState")==a.get("code")){return c}});this.setLocation(a);this.getEventListFilter().getController().setSearchViewText("Location: "+a.get("description"));this.updateRecordForSelectItems(b);this.setIsSelectAll(true);this.getSelectEventItem().selectAll();this.setIsSelectAll(false)},onSubmitFilterTopic:function(f){this.setTopic(null);this.checkAndCompileFilter();var b=this.getSelectEventPanel().getStore();var a=0;if(f&&f.getCount()>0){var c=new Array();var e=new Array();f.each(function(h){if(h.get("checked")=="checked"){c.push(h.get("code"));var i=new Array();if(h.SubcodeListEvent){h.SubcodeListEvent.each(function(j){if(j.get("checked")=="checked"){i.push(j.get("code"))}})}e.push(i)}});if(c.length>0){b.filter(function(h){var i=false;var j=h.TopicListEvent;j.each(function(l){var m=Ext.Array.indexOf(c,l.get("code"));if(m>=0){var k=e[m];if(k&&k.length>0){var n=l.SubcodeListEvent;n.each(function(o){if(Ext.Array.contains(k,o.get("code"))){i=true}})}else{i=true}}});if(i&&j.getAllCount()>0){return h}});this.setTopic(f)}this.updateRecordForSelectItems(b);this.getSelectEventItem().deselectAll(true);var g=this.getSelectEventItem().getStore().getCount();for(var d=a;d<g;d++){if(Ext.get(this.getSelectEventItem().getViewItems()[d].id.trim()).down(".p-filter-button-new")){this.getSelectEventItem().select(d)}}}else{this.setTopic(null)}},onLocationbtnTap:function(a){this.getLocationListPanel().showBy(a)},onTopicbtnTap:function(a){this.getFilterTopicList().showBy(a)},onTapSearchButton:function(b){this.setSearchText(null);this.checkAndCompileFilter();if(b.trim()!=""){var a=this.getSelectEventPanel().getStore();a.filter(function(d){didMatch=(d.get("shortName").trim().toLowerCase()+" "+d.get("shortDescription").trim().toLowerCase()+" "+d.get("eventType").trim().toLowerCase()+" "+d.get("location").trim().toLowerCase()).match(b.trim().toLowerCase());var c=d.SpeakersListEvent;c.each(function(e){didMatch=didMatch||e.get("name").trim().toLowerCase().match(b.trim().toLowerCase())});if(didMatch){return d}});this.setSearchText(b);this.updateRecordForSelectItems(a);this.setIsSelectAll(true);this.getSelectEventItem().selectAll();this.setIsSelectAll(false)}},clearFilter:function(){var d=Personify.utils.ServiceManager.getStoreManager();var a=d.getEventListStore();var c=Ext.create(a);var b=Ext.getStore("meetingListtingMain");b.each(function(e){c.add(e)});c.clearFilter();this.updateRecordForSelectItems(c)},checkAndCompileFilter:function(){this.clearFilter();if(this.getLocation()!=null){this.filterByLocation(this.getLocation())}if(this.getSearchText()!=null){this.onTapSearchButton(this.getSearchText())}if(this.getTopic()!=null){this.onSubmitFilterTopic(this.getTopic())}},addPersonalEvent:function(){var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){this.getView().fireEvent("requestopendetail","Personify.view.phone.addevent.AddEvent",null)}else{this.getView().fireEvent("requestopendetail","Personify.view.phone.login.LoginPhone",null)}},onClearIconTap:function(){this.setSearchText(null);var a=Ext.getStore("meetingListtingMain");this.getSelectEventPanel().setStore(a);if(this.getLocation()!=null){this.filterByLocation(this.getLocation())}if(this.getSearchText()!=null){this.onTapSearchButton(this.getSearchText())}if(this.getTopic()!=null){this.onSubmitFilterTopic(this.getTopic())}a=this.getSelectEventPanel().getStore();this.updateRecordForSelectItems(a)},clearLocationSelectTap:function(){this.getLocationListPanel().hide();this.getLocationList().deselectAll();this.setLocation(null);this.getEventListFilter().getController().setSearchViewText("");this.checkAndCompileFilter()},removeItemsInnerSelectItem:function(){var b=this.getSelectEventItem().getViewItems();for(var c=0;c<b.length;c++){var a=Ext.get(b[c].id);if(a.eventList){a.eventList.destroy();a.eventList=null}}},onSelectEventItem:function(b,a){if(this.getIsSelectAll()&&!a.get("expanded")){a.set("expanded",true)}}});