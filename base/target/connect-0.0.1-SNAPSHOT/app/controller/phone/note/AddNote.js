Ext.define("Personify.controller.phone.note.AddNote",{extend:"Personify.base.Controller",control:{inputTitleNote:{keyup:"onTitleChange",clearicontap:"onTitleChange"},inputDescriptionNote:{keyup:"onTextChange",change:"onTextChange",show:"onShow",clearicontap:"onClearText"},eventToolbar:{onNavigationButtonTap:"onBack"},view:{updaterecord:"onUpdateRecord",painted:"onPainted"},shareCurrentButton:{tap:"onShareCurrentNote"},deleteNoteButton:{tap:"onDeleteNoteButton"}},config:{noteId:null},init:function(){this.getEventToolbar().getController().setHiddenActionButton(true);if(this.getView().getIsNoteList()){this.onUpdateRecord();this.hiddenDeleteNoteButton(false)}if(this.getView().getIsAddNew()){var a=this.getView().getTitle();this.setNoteTitle(a);this.hiddenDeleteNoteButton(true)}},onPainted:function(){var a=this;if(window.plugins.applicationPreferences){window.plugins.applicationPreferences.get("noteDescriptionHeight",function(b){var c=parseInt(b);var d=a.getInputDescriptionNote().getValue();if(c>0&&d.length){a.getInputDescriptionNote().setHeight(c)}else{a.getInputDescriptionNote().setHeight(82)}},function(){a.getInputDescriptionNote().setHeight(82)})}},onShow:function(){this.getInputDescriptionNote().getParent().getScrollable().getScroller().scrollToTop();this.setConfigChangeView()},onAutoSaveNote:function(){var e=this;var a=this.getView().getRecord();var g=e.getInputTitleNote().getValue();var d=e.getInputDescriptionNote().getValue();var c=e.getView().getEventId();var f=e.getView().getSessionId()||"";var b=null;e.getInputTitleNote().blur();e.getInputDescriptionNote().blur();if(a){b=a.get("noteId")}if(d.length){Ext.Viewport.setMasked({xtype:"loadmask"});Personify.utils.Sqlite.insertTableNotes(g,d,f,c,b,function(h){Ext.Viewport.setMasked(false);if(h){}else{Ext.Msg.alert("","Cannot add this note.",Ext.emptyFn)}})}},onUpdateRecord:function(){var a=this.getView().getRecord();if(a){this.getInputTitleNote().setValue(a.get("title"));this.getInputDescriptionNote().setValue(a.get("description"))}},onTextChange:function(g){var b=Ext.DomQuery.select("textarea",g.element.dom)[0];var e=b.scrollHeight;var c=b.clientHeight;var f=b.selectionEnd;var d=b.textLength;if(c<e){this.getInputDescriptionNote().setHeight(e);if(window.plugins.applicationPreferences){window.plugins.applicationPreferences.set("noteDescriptionHeight",e,Ext.emptyFn,Ext.emptyFn)}if(f==d){this.getInputDescriptionNote().getParent().getScrollable().getScroller().scrollToEnd()}else{var a=this.getInputDescriptionNote().getParent().getScrollable().getScroller();a.scrollBy(0,e-c)}}this.setConfigChangeView()},onClearText:function(){this.getInputDescriptionNote().setHeight(82);this.getInputDescriptionNote().getParent().getScrollable().getScroller().scrollToTop();this.setConfigChangeView()},onBack:function(){this.getInputTitleNote().blur();this.getInputDescriptionNote().blur();if(Personify.utils.Configuration.getAllowChangeView()){this.onAutoSaveNote();if(this.getView().getIsNoteList()){this.getView().fireEvent("back")}else{this.getView().fireEvent("backtomenu",this)}}else{Ext.Msg.alert("","Please enter the note title.",Ext.emptyFn)}},setContent:function(b,a){this.getInputTitleNote().setValue(b);this.getInputDescriptionNote().setValue(a)},onClearTextFields:function(){this.getInputTitleNote().setValue("");this.getInputDescriptionNote().setValue("")},setConfigChangeView:function(){var b=this.getInputTitleNote().getValue();var a=this.getInputDescriptionNote().getValue();if(a.length>0){if(b.length==0){Personify.utils.Configuration.setAllowChangeView(false)}else{Personify.utils.Configuration.setAllowChangeView(true)}}else{Personify.utils.Configuration.setAllowChangeView(true)}},onTitleChange:function(){this.setConfigChangeView()},setNoteTitle:function(a){this.getInputTitleNote().setValue(a)},onShareCurrentNote:function(){this.getInputTitleNote().blur();this.getInputDescriptionNote().blur();if(Personify.utils.Configuration.getAllowChangeView()){var a=this;if(window.plugins.social&&window.plugins.social.available){window.plugins.social.available(function(b){if(b==1){var e=a.getInputTitleNote().getValue()||"";var d=a.getInputDescriptionNote().getValue()||"";var c="Title: "+e+"\nNote: "+d+"\n";window.plugins.social.share(c,"","")}else{Ext.Msg.alert("","Social network plugins is not supported.",Ext.emptyFn)}})}}else{Ext.Msg.alert("","Please enter the note title.",Ext.emptyFn)}},onDeleteNoteButton:function(){var b=this;b.getInputTitleNote().blur();b.getInputDescriptionNote().blur();Ext.Msg.confirm("","Do you want to delete the note?",a);function a(e){if(e=="yes"){var c=b.getView().getRecord();var d=null;if(c){d=c.get("noteId")}if(d){Personify.utils.Sqlite.deleteMyNote(d,function(f){if(f){c.set("noteId",null);b.hiddenDeleteNoteButton(true);b.onClearTextFields();b.setNoteTitle(b.getView().getTitle());Ext.Msg.alert("","The note has been deleted.",Ext.emptyFn)}})}Personify.utils.Configuration.setAllowChangeView(true)}}},hiddenDeleteNoteButton:function(a){this.getDeleteNoteButton().setHidden(a)}});