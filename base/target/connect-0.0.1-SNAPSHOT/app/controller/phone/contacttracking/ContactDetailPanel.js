Ext.define("Personify.controller.phone.contacttracking.ContactDetailPanel",{extend:"Personify.controller.profile.ContactDetailPanel",requires:["Personify.view.phone.contacttracking.InquiryPanel"],config:{delegate:null,callSubjectList:null,staffList:null,callTopicList:null,callSubjectList:{},callTypeList:null,currentContact:null},control:{contactTrackingDetailToolbar:{onNavigationButtonTap:"onBack",actionButtonTap:"onEditTrackingDetailButtonTap"},followUpRecordsHeader:{},contactDetailView:{},followUpList:{itemtap:"onFollowUpItemTap"},callTypeCodeText:{},activityText:{},topicText:{},subjectText:{},contactedText:{},ownerText:{},addFollowUpButton:{tap:"onAddFollowUpButtonTap"}},init:function(){this.callParent(arguments);var a=this.getView().config;var e=a.record;var d=a.request;var h=a.delegate;var g=a.currentContact;this.setCurrentContact(g);this.setDelegate(h);if(d=="view followup details"){this.setUIForViewFollowUpDetail()}var i=a.staffList;var f=a.callTopicList;var b=a.callSubjectList;var c=a.callTypeList;this.setStaffList(i);this.setCallTopicList(f);this.setCallSubjectList(b);this.setCallTypeList(c);this.setRecord(e)},onEditTrackingDetailButtonTap:function(){var d=this;var a;var b;var c;if(this.getView().getCurrentContact()){a=this.getView().getCurrentContact()}if(this.getView().getRecord()&&this.getView().getRecord().ContactDetailStore){b=this.getView().getRecord().ContactDetailStore.getAt(0)}else{b=this.getView().getRecord();c=this.getView().getRecord().get("parentActivityId")}this.getView().fireEvent("requestchangeview","Personify.view.phone.contacttracking.InquiryPanel",{parentActivityId:c,trackingDetailRecord:b,record:a,currentContact:d.getView().getCurrentContact(),delegate:this.getDelegate(),staffList:d.getStaffList(),callTopicList:d.getCallTopicList(),callTypeList:d.getCallTypeList(),callSubjectList:d.getCallSubjectList()})},onAddFollowUpButtonTap:function(){var b;if(this.getView().getRecord()){b=this.getView().getRecord().ContactDetailStore.getAt(0).get("activityId")}var a;if(this.getView().getCurrentContact()){a=this.getView().getCurrentContact()}this.getView().fireEvent("requestchangeview","Personify.view.phone.contacttracking.InquiryPanel",{parentActivityId:b,trackingDetailRecord:null,record:a,currentContact:null,delegate:this.getDelegate(),staffList:this.getStaffList(),callTopicList:this.getCallTopicList(),callTypeList:this.getCallTypeList(),callSubjectList:this.getCallSubjectList()})},setRecord:function(g){if(this.getView()){if(g.ContactDetailStore){var e=g.ContactDetailStore.getAt(0)}else{var e=g}var i=this;i.getActivityText().setHtml(e.get("activityText"));i.getTopicText().setHtml('<span class="p-phone-directory-contact-tracking-detail-title">Topic:</span>');i.getSubjectText().setHtml('<span class="p-phone-directory-contact-tracking-detail-title">Subject:</span>');i.getContactedText().setHtml('<span class="p-phone-directory-contact-tracking-detail-title">Contacted:</span><span class="p-phone-directory-contact-tracking-detail-info">'+e.get("personContacted")+"</span>");i.getOwnerText().setHtml('<span class="title">Owner:</span>');var d=this.getStaffList();if(d){d.each(function(o){if(o&&o.get("staffId")==e.get("staffUserId")){i.getOwnerText().setHtml('<span class="p-phone-directory-contact-tracking-detail-title">Owner:</span><span class="p-phone-directory-contact-tracking-detail-info">'+o.get("staffName")+"</span>")}})}var m=this.getCallTypeList();if(m){m.each(function(o){if(o&&o.get("code")==e.get("callTypeCode")){i.getCallTypeCodeText().setHtml(o.get("description"))}})}var c;var b=this.getCallTopicList();if(b){b.each(function(o){if(o&&o.get("code")==e.get("topic")){i.getTopicText().setHtml('<span class="p-phone-directory-contact-tracking-detail-title">Topic:</span><span class="p-phone-directory-contact-tracking-detail-info">'+o.get("description")+"</span>");c=e.get("topic")}})}if(c){var l=i.getCallSubjectList();var k;if(l[c]){k=l[c];var j=new Array();j.push({text:"",value:""});k.each(function(o){if(o&&o.get("subcode")==e.get("subject")){i.getSubjectText().setHtml('<span class="p-phone-directory-contact-tracking-detail-title">Subject:</span><span class="p-phone-directory-contact-tracking-detail-info">'+o.get("description")+"</span>")}})}else{var i=this;i.getView().setMasked({xtype:"loadmask"});var j=new Array();j.push({text:"",value:""});var a=Personify.utils.ServiceManager.getStoreManager();var n=a.getCallSubjectStore();var k=Ext.create(n);var h={type:"rest",url:Personify.utils.ServiceManager.getUrlWS("utilCallSubject")+"?$filter=Subsystem eq 'MRM' and Type eq ('CALL_TOPIC') and Code eq ('"+c+"')",headers:Personify.utils.ServiceManager.getHeaders(),reader:{implicitIncludes:true,type:"json",rootProperty:"d"}};k.setProxy(h);k.load({callback:function(p,o,q){if(q){if(k){k.each(function(r){if(r&&r.get("subcode")==e.get("subject")){i.getSubjectText().setHtml('<span class="p-phone-directory-contact-tracking-detail-title">Subject:</span><span class="p-phone-directory-contact-tracking-detail-info">'+r.get("description")+"</span>")}})}i.getCallSubjectList()[c]=k}i.getView().setMasked(false)}})}}if(g.FollowupStore){var f=g.FollowupStore;f.each(function(o){if(b){b.each(function(p){if(p&&p.get("code")==o.get("topic")){o.set("topicString",p.get("description"))}})}});this.getFollowUpList().setStore(f)}}},onFollowUpItemTap:function(f,b,h,a,g,c){var d=this;this.getView().fireEvent("requestchangeview","Personify.view.phone.contacttracking.ContactDetailPanel",{record:a,currentContact:d.getView().getCurrentContact(),delegate:d.getDelegate(),staffList:d.getStaffList(),callTopicList:d.getCallTopicList(),callTypeList:d.getCallTypeList(),callSubjectList:d.getCallSubjectList(),request:"view followup details"})},passDataToChildView:function(a){a.setStaffList(this.getView().getStaffList());a.setCallTopicList(this.getView().getCallTopicList());a.setCallTypeList(this.getView().getCallTypeList());a.setCallSubjectList(this.getView().getCallSubjectList())},setUIForViewFollowUpDetail:function(){this.getContactTrackingDetailToolbar().setTitle("Follow-up Detail");this.getAddFollowUpButton().setHidden(true);this.getFollowUpRecordsHeader().setHidden(true)},onBack:function(){var b=this;var c=b.getView();var a={};a.subjectList=this.getCallSubjectList();c.fireEvent("back",b,a)},refreshRecordAfterEditing:function(e){if(e){if(e.subjectList){this.getView().config.callSubjectList=e.subjectList;this.setCallSubjectList(e.subjectList)}if(e.refresh==true){if(e.activityId){var d=Personify.utils.Configuration.getCurrentUser();var b=this.getCurrentContact();if(b){var f={MasterCustomerId:b.get("masterCustomerId"),SubCustomerId:b.get("subCustomerId"),StaffId:(d.get("id")!=null)?d.get("id"):"",ActivityId:e.activityId}}var i=this;var a=Personify.utils.ServiceManager.getStoreManager();var j=a.getProfileContactTrackingStore();var c=Ext.create(j,{dataRequest:f});c.load({callback:function(l,k,n){if(n&&l.length){var m=l[0];i.setRecord(m);i.getView().config.record=m}},scope:i})}else{var h=this.getView().config.record;if(h.ContactDetailStore){var g=h.ContactDetailStore.getAt(0)}else{var g=h}g.set("activityText",e.activityText);g.set("staffUserId",e.assignTo);g.set("callTypeCode",e.callType);g.set("topic",e.topic);g.set("subject",e.subject);this.setRecord(this.getView().config.record)}}}}});