Ext.define("Personify.controller.Profile",{extend:"Personify.base.Controller",inject:["countryListStore","currentUser"],requires:["Personify.view.profile.ContactInfo","Personify.view.profile.PurchaseHistory","Personify.view.profile.ParticipationHistory","Personify.view.profile.Logout","Personify.store.base.profile.ProfileDisplayOption","Personify.view.profile.ConnectTwitter","Personify.view.profile.ConnectedTwitter","Personify.utils.storemanager.StoreOfflineManager"],config:{countryListStore:null,currentRecord:null,currentUser:null},control:{displayOptionPanel:{tapOnDisplayOptionItem:"onTapOnDisplayOptionItem"},contactInfoPanel:{changeview:"onChangeView"},contactInfoManagement:{live:true,listeners:{updateContactFail:"onUpdateContactFail",editRecord:"onEditRecord",updatedContact:"onUpdatedContact"}},view:{painted:"onPainted"},optionList:{}},init:function(){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("My Profile")}var a=this;this.getCountryList(function(){var b=a.getContactInfoManagement();b.getController().updateEnableEditToolBox(true);b.getController().setListOfInfo(Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("listInfo"));b.setCanedit(true)})},onTapOnDisplayOptionItem:function(c){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}var b=c.get("view");nameView=c.get("name");if(nameView=="Change Password"){Ext.Msg.alert("Personify","Please contact your association representative for assistance in changing your password",Ext.emptyFn());return}if(nameView=="Connect Twitter"){if(TMA.Twitter.isAuthorized()){b="Personify.view.profile.ConnectedTwitter"}}if(b&&b!=""){this.getContactInfoPanel().removeAll(true,true);var d=Ext.create(b);if(nameView=="Contact Information"){d.getController().updateEnableEditToolBox(true);var e=this.getCountryListStore();d.setCountryListStore(e);d.getController().setListOfInfo(Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("listInfo"));if(this.getView().getStore()){var a=this.getCurrentRecord();if(a){d.setRecord(a)}else{d.setRecord(this.getView().getStore().getAt(0))}}else{this.getData()}}else{if(nameView!="Connect Twitter"){d.getController().loadContactData(Personify.utils.Configuration.getCurrentUser())}}this.getContactInfoPanel().animateActiveItem(d,{type:"slide",direction:"left"})}},onPainted:function(){},getData:function(d){var g=this,h=g.getView(),e=g.getContactInfoManagement(),j=Ext.create("Personify.utils.storemanager.StoreOfflineManager"),a=Ext.create(j.getProfileStore()),b=Personify.utils.Configuration.getCurrentUser(),k=b.getProfileDisplayOptionStore(),f=g.getOptionList();f.setStore(k);var i=b.isStaffMember(),c={MasterCustomerId:b.get("masterCustomerId"),SubCustomerId:b.get("subCustomerId"),ReqMasterCustomerId:b.get("masterCustomerId"),ReqSubCustomerId:b.get("subCustomerId"),IsStaff:i,RecordType:""};Ext.Viewport.setMasked({xtype:"loadmask"});a.setDataRequest(c);a.on("load",function(o,n){if(o.getCount()==0||d){var p=Personify.utils.ServiceManager.getStoreManager(),m=Ext.create(p.getProfileStore());if(m.getCount()==0){m.setDataRequest(c);Ext.Viewport.setMasked({xtype:"loadmask"});m.on("load",function(s,r){if(s.getCount()){var q=s.first();e.setRecord(q);if(q.EntryProfile.getCount()){g.getDisplayOptionPanel().getController().setRecord(q.EntryProfile.first())}else{g.getDisplayOptionPanel().getController().setRecord(null)}}else{g.getDisplayOptionPanel().getController().setRecord(null)}h.setStore(s);g.setSelectDisplayOption(0);Ext.Viewport.setMasked(false)});m.load()}else{g.setSelectDisplayOption(0);e.setRecord(m.getAt(0))}}else{var l=o.first();e.setRecord(l);if(l.EntryProfile.getCount()){g.getDisplayOptionPanel().getController().setRecord(l.EntryProfile.first())}else{g.getDisplayOptionPanel().getController().setRecord(null)}h.setStore(o);g.setSelectDisplayOption(0);Ext.Viewport.setMasked(false)}});a.load()},setSelectDisplayOption:function(a){var b=this,c=b.getOptionList();c.select(a)},onUpdateContactFail:function(){this.getData()},onEditRecord:function(){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Profile Edit")}},getCountryList:function(b){var a=this;if(a.getView()&&!a.getView().isDestroyed){if(this.getCountryListStore().getCount()>0){a.getContactInfoManagement().setCountryListStore(this.getCountryListStore());Ext.Viewport.setMasked(false);a.getData();if(typeof b=="function"){b()}}else{Personify.utils.Configuration.loadCountryList().then({success:function(c){a.getContactInfoManagement().setCountryListStore(c);Ext.Viewport.setMasked(false);a.getData();if(typeof b=="function"){b()}},failure:function(){Ext.Viewport.setMasked(false)}})}}},onUpdatedContact:function(a){this.getData();this.setCurrentRecord(a)},onChangeView:function(a){if(a&&a!=""){this.getContactInfoPanel().removeAll(true,true);var b=Ext.create(a);this.getContactInfoPanel().animateActiveItem(b,{type:"slide",direction:"left"})}}});