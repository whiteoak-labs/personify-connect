Ext.define("Personify.controller.profile.ContactInfoManagement",{extend:"Personify.base.Controller",inject:["currentUser"],control:{editToolBox:{},editRecordButton:{tap:"onTapEditRecordButton"},cancelEditButton:{tap:"onTapCancelEditButton"},doneEditButton:{tap:"onTapDoneEditButton"},contactinfo:{updatedContact:"onUpdatedContact",updateContactFail:"onUpdateContactFail",closeinfopanel:"onCloseInfoPanel"},addToMyProfileButton:{live:true,listeners:{tap:"onAddToMyProfileButtonTap"}}},config:{recordProfile:null,currentUser:null,countryListStore:null},setListOfInfo:function(a){this.getContactinfo().setListOfInfo(a)},addButtonAddToMyAddressBook:function(a){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Directory Add To Address Book")}if(a==true){this.getView().add(Ext.create("Ext.Button",{itemId:"addToMyProfileButton",xtype:"button",text:"Add to my address book",cls:"p-button-big",disabledCls:"p-button-big-disabled",hidden:false}))}},onTapEditRecordButton:function(){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}this.getView().fireEvent("editRecord");this.getView().fireEvent("hideStaffFunction");this.getContactinfo().setEditmode(true);if(this.getAddToMyProfileButton()){this.getAddToMyProfileButton().hide()}},onTapDoneEditButton:function(){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}this.getView().fireEvent("showStaffFunction");if(this.getAddToMyProfileButton()){this.getAddToMyProfileButton().show()}if(this.getContactinfo().getController().saveData()){this.getEditToolBox().getController().reset()}},onTapCancelEditButton:function(){this.getContactinfo().setEditmode(false);this.getEditToolBox().getController().reset();this.getView().fireEvent("showStaffFunction");if(this.getAddToMyProfileButton()){this.getAddToMyProfileButton().show()}},setRecord:function(b,f){var c=f?false:true;var a=this.getView();var d=this;if(a&&a.destroy!=Ext.emptyFn){this.setCanedit(false);if(b){if(c){this.setRecordProfile(b);var e=a.getCountryListStore();this.getContactinfo().setRecord(b);this.getContactinfo().getController().setCountryListStore(e);if(!this.getCurrentUser().isStaffMember()){if(!this.getCurrentUser().isStaffMember()){this.updateEnableEditToolBox(b.EntryProfile.getAt(0).get("entryId")==Personify.utils.Configuration.getCurrentUser().get("id"))}}this.resetToolbox()}else{this.getContactinfo().setRecord(b);this.setRecordProfile(b)}}}this.setCanedit(true)},setCountryListStore:function(a){},setPresenterRecord:function(b){var a=this.getView();if(a&&a.destroy!=Ext.emptyFn){if(b){this.setRecordProfile(b);this.getContactinfo().setPresenterRecord(b)}}},setCanedit:function(c){var b=this.getView();if(b&&b.destroy!=Ext.emptyFn){var d=this.getEditRecordButton();var a=this.getAddToMyProfileButton();if(c==true){d.enable();if(a){this.getAddToMyProfileButton().enable()}}else{d.disable();if(a){this.getAddToMyProfileButton().disable()}}}},setEditmode:function(a){if(this.getView()){this.getContactinfo().setEditmode(a)}},updateEnableEditToolBox:function(a){if(this.getView()){if(a===true){this.getEditToolBox().show()}else{this.getEditToolBox().hide()}}},onAddToMyProfileButtonTap:function(){var w=this,d=w.getRecordProfile(),u=d.EntryProfile.getAt(0),t=u.NameProfile.getAt(0)||null,e=u.PhoneNumbersProfile||null,q=u.AddressesProfile||null,c=u.EmailsProfile||null,s=u.UrlsProfile||null,f=navigator.contacts.create();f.displayName=u.get("displayName");f.name={formatted:t.get("formatted"),familyName:t.get("familyName"),givenName:t.get("givenName"),middleName:t.get("middleName"),honorificPrefix:t.get("honorificPrefix"),honorificSuffix:t.get("honorificSuffix")};f.nickname="";var h=e.getCount(),v=[],i;for(var j=0;j<h;j++){var m=e.getAt(j);i=new ContactField(m.get("type"),m.get("value"),false);v.push(i)}f.phoneNumbers=v;var n=c.getCount(),k=[],o;for(var j=0;j<n;j++){var x=c.getAt(j);o=new ContactField(x.get("type"),x.get("value"),false);k.push(o)}f.emails=k;var l=q.getCount(),b=[];for(var j=0;j<l;j++){var a=q.getAt(j);var p=a.get("streetAddress");if(a.get("address")){p+=", "+a.get("address")}if(a.get("address2")){p+=", "+a.get("address2")}if(a.get("address3")){p+=", "+a.get("address3")}if(a.get("address4")){p+=", "+a.get("address4")}var g=new ContactAddress();g.streetAddress=p;g.locality=a.get("locality");g.postalCode=a.get("postalCode");g.country=a.get("country");g.region=a.get("region");g.type=a.get("type");b.push(g)}f.addresses=b;var r=[];for(var j=0;j<s.getAllCount();j++){url=new ContactField(s.getAt(j).get("type"),s.getAt(j).get("value"),false);r.push(url)}f.urls=r;f.save(w.onSuccess,w.onError)},onSuccess:function(){Ext.Msg.alert("Address Book","Added to address book",Ext.emptyFn)},onError:function(){if(Ext.os.is.Android){Ext.Msg.alert("Address Book","This contact already exists in your device's contact list.",Ext.emptyFn)}else{Ext.Msg.alert("Address Book","To use this function, you have to allow this mobile application to access your contacts by changing iOS settings in Settings > Privacy > Contacts",Ext.emptyFn)}},onUpdatedContact:function(a){this.getView().fireEvent("updatedContact",a)},onUpdateContactFail:function(){this.getView().fireEvent("updateContactFail")},resetToolbox:function(){this.getEditToolBox().reset()},hideCloseButton:function(a){this.getContactinfo().getController().getCloseContactPanel().setHidden(a)},onCloseInfoPanel:function(){this.getView().fireEvent("closeinfopanel")}});