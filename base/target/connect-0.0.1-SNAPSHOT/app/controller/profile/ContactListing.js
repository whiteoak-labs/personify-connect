Ext.define("Personify.controller.profile.ContactListing",{extend:"Personify.base.Controller",control:{contactList:{itemtap:"onItemTap",scrollend:"onNextButtonTap"},newContactInquiry:{tap:"onNewContactInquiry"}},config:{params:null,currentContact:null,selectedRecord:null,totalContactTrackingResult:0},init:function(){this.resetParams()},resetParams:function(){this.setParams({MasterCustomerId:"",SubCustomerId:"",StartIndex:1,ItemsPerPage:Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("itemPerPage"),StaffId:""})},loadContactData:function(e,f){if(e){var c=Personify.utils.Configuration.getCurrentUser();var b=Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore;var g=this;g.setCurrentContact(e);var d=g.getParams();d.MasterCustomerId=e.get("masterCustomerId");d.SubCustomerId=e.get("subCustomerId");d.StaffId=(c.get("id")!=null)?c.get("id"):"";g.getView().setMasked({xtype:"loadmask"});var a=Personify.utils.ServiceManager.getStoreManager();var i=a.getProfileContactListingStore();var h=Ext.create(i,{dataRequest:d});h.load({callback:function(l,k,n){if(n&&l.length&&!g.getView().isDestroyed){var m=l[0];if(f&&f==true){g.getContactList().setStore(m.ContactListStore);g.getView().setMasked(false)}else{var j=this.getContactList().getStore();if(j){j.each(function(o){o.set("details",null)},g);j.suspendEvents();m.ContactListStore.each(function(o){j.add(o)},g);j.sync();j.resumeEvents(true);g.getContactList().refresh()}else{g.getContactList().setStore(m.ContactListStore);j=m.ContactListStore}if(m){g.setTotalContactTrackingResult(m.get("totalResults"))}g.getView().setMasked(false)}}},scope:g},g)}},onNextButtonTap:function(){var c=this.getCurrentContact();var a=this.getContactList().getStore();var b=0;if(a){b=a.getCount()}if(c&&b<this.getTotalContactTrackingResult()){this.getParams()["StartIndex"]=this.getParams()["StartIndex"]+(Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("itemPerPage"));this.loadContactData(c)}},setLoadedStore:function(a){this.getPurchaseHistoryList().setStore(a.getPurchaseListStore());this.getPurchaseHistoryPagingPanel().getController().setPagingNavigationPanel(a.getAt(0).get("startIndex"),a.getAt(0).get("totalResults"),Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("itemPerPage"));this.getPurchaseHistoryPagingPanel().setHidden(a.getPurchaseListStore().getCount()==0)},onNewContactInquiry:function(){var a=Ext.create("Personify.view.profile.contactlisting.InquiryPanel");this.passDataToChildView(a);a.getController().setOptionsForPickLists();a.getController().setRecord(this.getCurrentContact());a.getController().setDelegate(this);Ext.Viewport.add(a);a.show()},onItemTap:function(l,i,j,h,k,m){Ext.Viewport.setMasked({xtype:"loadmask",zIndex:10});if(h){this.setSelectedRecord(h)}else{if(this.getSelectedRecord()){h=this.getSelectedRecord();h.set("details",null)}}var n=this;if(h.get("details")){var a=Ext.create("Personify.view.profile.contactlisting.ContactDetailPanel");a.getController().setDelegate(n);n.passDataToChildView(a);a.setRecord(h.get("details"));a.setCurrentContact(n.getCurrentContact());Ext.Viewport.add(a);a.show()}else{var f=Personify.utils.Configuration.getCurrentUser();var d=this.getCurrentContact();if(d){var g={MasterCustomerId:d.get("masterCustomerId"),SubCustomerId:d.get("subCustomerId"),StaffId:(f.get("id")!=null)?f.get("id"):"",ActivityId:h.get("activityId")}}var b=Personify.utils.ServiceManager.getStoreManager();var o=b.getProfileContactTrackingStore();var c=Ext.create(o,{dataRequest:g});c.load({callback:function(q,p,s){if(s&&q.length){var r=q[0];var e=Ext.create("Personify.view.profile.contactlisting.ContactDetailPanel");e.getController().setDelegate(n);n.passDataToChildView(e);if(r){e.setRecord(r);h.set("details",r)}e.setCurrentContact(n.getCurrentContact());Ext.Viewport.add(e);e.show()}else{Ext.Viewport.setMasked(false)}},scope:n})}},passDataToChildView:function(a){a.setStaffList(this.getView().getStaffList());a.setCallTopicList(this.getView().getCallTopicList());a.setCallSubjectList(this.getView().getCallSubjectList());a.setCallTypeList(this.getView().getCallTypeList())}});