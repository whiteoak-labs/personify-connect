Ext.define("Personify.controller.tablet.schedule.Schedule",{extend:"Personify.base.Controller",config:{calendarFilter:false,calendarDate:null,selectDate:null,valueSearch:null,hidePast:true,eventRecord:null,flagSelected:false,futureEvents:null,currentStore:null,itemSelected:false,expandEvent:null,indexExpandEvent:null},control:{searchEventPanel:{tapsearchbutton:"onTapSearchButton",onsearchtextchange:"onTapSearchButton",seachclearicontap:"onSeachClearIconTap"},personalButton:{tap:"onButtonPersonalTap"},allEventButton:{tap:"onAllEventButtonTap"},selectScheduleItem:{eventitemtap:"onScheduleItemTap",eventitemlistselect:"scheduleItemListSelect",removeagenda:"removeAgenda"},selectSchedulePanel:{},calendarPanel:{selectiondatechange:"onSelectionDateChange",onchangecalendarview:"onChangeCalendarView"},clearFilter:{tap:"clearFilterButtonTap"},bigEventPanel:{onEventItemTapped:"onEventItemOpen"}},init:function(){this.callParent(arguments);this.checkIsLoadEventList();this.getClearFilter().setDisabled(true);this.getSearchEventPanel().getController().setPlaceHolder("Search Titles and Presenters")},onScheduleItemTap:function(b){var a=this;Ext.Viewport.setMasked({xtype:"loadmask"});Ext.callback(function(){a.getView().fireEvent("eventitemlistselect",b);Ext.Viewport.setMasked(false)},a,[],50)},scheduleItemListSelect:function(b){var a=this;a.getView().fireEvent("eventitemlistselect",b)},removeAgenda:function(d){var c=this;var b=Personify.utils.ItemUtil.getMessageMatchTypeOfEvent(d);Ext.Msg.confirm("",b.msg,a);function a(e){Ext.Msg.hide();if(e=="yes"){c.getView().fireEvent("removeagenda",d,b.msgSuccess)}}},checkIsLoadEventList:function(){var c=Ext.getStore("agendaStoreListMain");var b=Ext.getStore("iCalendarStoreMain");var a=b?b.getAt(0):null;if(c&&a!=null){var f=Personify.utils.ServiceManager.getStoreManager();var d=f.getAgendaStore();var e=Ext.create(d);c.each(function(g){e.add(g)});this.removeItemsInnerSelectItem();this.updateRecordForSelectItems(e,f);this.getView().setRecord(a)}else{this.onGetData()}},updateRecordForSelectItems:function(c,d){var a=Personify.utils.Configuration.getCurrentUser();var b=a.getScheduleMonthStore(c);if(b.getCount()<=0){this.getSelectScheduleItem().setDeferEmptyText(false);this.getSelectScheduleItem().setEmptyText('<div class = "emptyText">Currently, there are no events in your schedule. <br> You may add an event by selecting an event and choosing Add to My Schedule</div>')}this.getSelectSchedulePanel().setStore(c);this.getSelectScheduleItem().setStore(b)},onGetData:function(){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Agenda List")}var e=this;var h=e.getSelectScheduleItem();var f=e.getCalendarPanel();h.setMasked({xtype:"loadmask"});var a=Personify.utils.Configuration.getCurrentUser();var c={MasterCustomerID:a?a.get("masterCustomerId"):"",SubCustomerID:a?a.get("subCustomerId"):"",MeetingID:""};var g=Personify.utils.ServiceManager.getStoreManager();var d=g.getAgendaStore();var b=Ext.create(d);b.setDataRequest(c);b.load({callback:function(j,i,k){if(k){e.getView().fireEvent("copyagendalist",b);if(j.length>=0){e.removeItemsInnerSelectItem();e.updateRecordForSelectItems(b,g)}}else{Personify.utils.ItemUtil.cantLoadEvent()}h.setMasked(false)},scope:this})},onTapFieldButtonSchedule:function(f,b,e,a,d,c){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}this.setExpandEvent(b);if(!this.getFlagSelected()&&!this.getItemSelected()){this.addData(a,e.getId())}this.setItemSelected(false);this.setFlagSelected(false)},onSelectFieldButtonSchedule:function(h,b,e){if(!this.getItemSelected()){var c=h.getStore(),g=h.getSelection()[0],a=c.indexOf(g),d=h.getViewItems(),f=d[a];if(a===-1){a=this.getExpandEvent();d=h.getViewItems();f=d[a];this.addData(b.getAt(0),f.id)}else{this.addData(b,f.id)}this.setFlagSelected(true)}this.setItemSelected(false)},addData:function(a,c){var f=this;var e=Ext.get(c.trim());var d=null;if(e.down(".p-filter-button-new-enabled")){if(e.eventList){e.eventList.destroy();e.eventList=null}if(e.down(".newsFeedItem")){e.down(".newsFeedItem").destroy()}e.down(".p-filter-button-new-enabled").replaceCls("p-filter-button-new-enabled","p-filter-button-new")}else{if(a.get("startDateTime")!=null){d=f.getEventRecord()[Personify.utils.ItemUtil.getSelectDateTimeValue(a.get("startDateTime"))];d.sort({sorterFn:function(i,h){var g=i.get("startDateTime");var l=h.get("startDateTime");var k=parseInt(Ext.Date.format(g,"j"),10);var j=parseInt(Ext.Date.format(l,"j"),10);return k>j?1:(k==j?0:-1)},direction:"ASC"});var b=Ext.create("Personify.view.schedule.ScheduleListItem",{store:d,listeners:{itemtap:function(g,i,j,h,k,l){f.setFlagSelected(true);f.setItemSelected(true);f.setIndexExpandEvent(i);k.preventDefault();var n=g.getStore();if(k.target.className.indexOf("x-button")>=0){f.setFlagSelected(true);f.setItemSelected(true);if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}var o=Personify.utils.ItemUtil.getMessageMatchTypeOfEvent(h);Ext.Msg.confirm("",o.msg,m);function m(p){Ext.Msg.hide();if(p=="yes"){f.getView().fireEvent("removeagenda",h,o.msgSuccess)}}}else{f.setFlagSelected(true);f.setItemSelected(true);f.getView().fireEvent("eventitemlistselect",h)}}}});e.eventList=b;e.down(".p-filter-button-new").replaceCls("p-filter-button-new","p-filter-button-new-enabled");b.element.appendTo(e)}}},onTapSearchButton:function(e){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Event Search")}this.setValueSearch(null);if(e){var g=this.getEventRecord();this.checkAndCombineFilter();var c=this.getSelectSchedulePanel().getStore();var h=Personify.utils.ServiceManager.getStoreManager();var a=h.getAgendaStore();var f=Ext.create(a);c.each(function(i){f.add(i)});f.filter(function(j){didMatch=(j.get("title").trim().toLowerCase()+" "+j.get("description").trim().toLowerCase()+" "+j.get("type").trim().toLowerCase()+" "+j.get("speakerName").trim().toLowerCase()).match(e.trim().toLowerCase());if(j.eventData){var i=j.eventData.SpeakersListEvent;i.each(function(k){didMatch=didMatch||k.get("name").trim().toLowerCase().match(e.trim().toLowerCase())})}if(didMatch){return j}});this.removeItemsInnerSelectItem();this.updateRecordForSelectItems(f,h);var b=this.getSelectScheduleItem().getStore().getCount();this.getSelectScheduleItem().deselectAll(true);for(var d=0;d<b;d++){if(Ext.get(this.getSelectScheduleItem().getViewItems()[d].id.trim()).down(".p-filter-button-new")){this.getSelectScheduleItem().select(d)}}this.setValueSearch(e);this.getClearFilter().setDisabled(false)}},onButtonPersonalTap:function(){var b=this;if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Event Add To Calendar")}var a=Ext.Viewport.add([{xtype:"addevent",listeners:{refreshagenda:function(){b.refreshData()}}}]);a.show()},onAllEventButtonTap:function(){this.getView().fireEvent("gotomyevent")},onScheduleItemSelect:function(a){this.getView().fireEvent("eventitemlistselect",a)},onShowPastEvent:function(){this.checkAndCombineFilter()},onSelectionDateChange:function(b){this.setCalendarDate(null);this.setCalendarFilter(false);this.setSelectDate(null);var e=Personify.utils.ServiceManager.getStoreManager();this.checkAndCombineFilter();var d=this.getSelectSchedulePanel().getStore();if(b){d.filter(function(g){var f=g.get("startDateTime");f.setHours(0,0,0,0);var h=g.get("endDateTime");if(f<=b&&h>=b){return g}})}this.removeItemsInnerSelectItem();this.updateRecordForSelectItems(d,e);var a=this.getSelectScheduleItem().getStore().getCount();this.getSelectScheduleItem().deselectAll(true);for(var c=0;c<a;c++){if(Ext.get(this.getSelectScheduleItem().getViewItems()[c].id.trim()).down(".p-filter-button-new")){this.getSelectScheduleItem().select(c)}}this.setSelectDate(b);this.getClearFilter().setDisabled(false)},onChangeCalendarView:function(c){this.setSelectDate(null);this.setCalendarDate(null);this.setCalendarFilter(false);this.getCalendarPanel().getController().onRemoveSelectDate();var g=Personify.utils.ServiceManager.getStoreManager();var a=g.getEventListStore();var f=Ext.create(a);this.checkAndCombineFilter();var d=this.getSelectSchedulePanel().getStore();d.each(function(h){f.add(h)});if(c){f.filter(function(i){var h=i.get("startDateTime");var j=i.get("endDateTime");if(h.getFullYear()*100+h.getMonth()<=c.getFullYear()*100+c.getMonth()&&c.getFullYear()*100+c.getMonth()<=j.getFullYear()*100+j.getMonth()){return i}})}this.removeItemsInnerSelectItem();this.updateRecordForSelectItems(f,g);var b=this.getSelectScheduleItem().getStore().getCount();this.getSelectScheduleItem().deselectAll(true);for(var e=0;e<b;e++){if(Ext.get(this.getSelectScheduleItem().getViewItems()[e].id.trim()).down(".p-filter-button-new")){this.getSelectScheduleItem().select(e)}}this.setCalendarFilter(true);this.setCalendarDate(c);this.getClearFilter().setDisabled(false)},clearFilter:function(){var e=Personify.utils.ServiceManager.getStoreManager();var c=e.getAgendaStore();var d=Ext.create(c);var b=Ext.getStore("agendaStoreListMain");b.each(function(f){d.add(f)});d.clearFilter();this.removeItemsInnerSelectItem();this.updateRecordForSelectItems(d,e);var a=this.getSelectScheduleItem().getStore().getCount();this.getSelectScheduleItem().deselectAll(true);this.getClearFilter().setDisabled(true)},checkAndCombineFilter:function(){this.combineFilter()},combineFilter:function(){this.clearFilter();if(this.getValueSearch()){this.onTapSearchButton(this.getValueSearch())}if(this.getCalendarFilter()){var a=this.getCalendarDate();this.onChangeCalendarView(a)}if(this.getSelectDate()){this.onSelectionDateChange(this.getSelectDate())}},clearFilterButtonTap:function(){this.setCalendarFilter(false);this.setCalendarDate(null);this.setValueSearch(null);this.setSelectDate(null);this.getSearchEventPanel().down("#searchField").setValue("");this.getCalendarPanel().getController().onBackCurrentDate();this.clearFilter();this.getClearFilter().setDisabled(true)},refreshData:function(a){this.onGetData();this.combineFilter()},onRemoveAgenda:function(a,b){this.getView().fireEvent("removeagenda",a,b)},onSeachClearIconTap:function(){this.clearFilter()},removeItemsInnerSelectItem:function(){var b=this.getSelectScheduleItem().getViewItems();for(var c=0;c<b.length;c++){var a=Ext.get(b[c].id);if(a.eventList){a.eventList.destroy();a.eventList=null}}},onEventItemOpen:function(c){var b=this.getView().getParent().getParent().getParent();var a=c.get("isConference");var d=c.get("shortName");var e=a?"Personify.view.event.complexevent.ComplexEvent":"Personify.view.event.simpleEvent.SimpleEvent";b.getController().onRequestChangeView(e,{record:c,listeners:{userlogin:"refresh"}},d,"")}});