Ext.define("Personify.controller.event.complexevent.detailsession.SessionDetail",{extend:"Personify.base.Controller",inject:["currentUser"],requires:["Personify.utils.ItemUtil"],config:{currentUser:null},control:{headerDetailEvent:{onmaptap:"onMapButtonTap",oninmyscheduletap:"onInMyScheduleTap"},sessionMenuList:{itemtap:"onSessionMenuListTap"},ratePanel:{live:true,listeners:{close:"onCloseSubPanel"}},notePanel:{live:true,listeners:{close:"onCloseSubPanel"}},cardMainDetailContainer:true,sponsorPanel:true,sessionPresenterList:{live:true,listeners:{showPresenterDetails:"onShowPresenterDetails"}},presenterSessionInfo:{live:true,listeners:{closeinfopanel:"onButtonClosePresenterDetailsTap"}},view:{show:"onShow",deactivate:"onDeactivateView",activeitemchange:"onDetailItemChange"}},init:function(){var a=Personify.utils.Configuration.getCurrentUser();if(a.isLogged()){this.getSessionMenuList().setData([{title:"Description",component:"sessionDetailDescription"},{title:"Materials",component:"materialPanel"},{title:"Presenters",component:"presenterlistdetail"},{title:"Notes",component:"sessionnotes"},{title:"Rate",component:"sessionrate"}]);this.getSessionMenuList().setItemCls("item-session-menu-list")}else{this.getSessionMenuList().setData([{title:"Description",component:"sessionDetailDescription"},{title:"Materials",component:"materialPanel"},{title:"Presenters",component:"presenterlistdetail"},{title:"Notes",component:"sessionnotes"}]);this.getSessionMenuList().setItemCls("item-session-menu-list-without-rate")}var b=this.getView().getRecord();var d=this;if(b!=null){this.setLocationDescription(b.get("locationDescription"))}var e=this.getView().getMeetingRecord();if(e!=null){var c=e.SponsorListEvent;Personify.utils.ItemUtil.getSponsorListFromJsonFile(Personify.utils.Configuration.getConfiguration().getAt(0).EventsStore.get("sponsorEvents"),b.get("productID"),c,function(){if(c.getCount()>0){if(d.getSponsorPanel){d.getSponsorPanel().getController().setStore(c);d.getSponsorPanel().show()}}else{if(d.getSponsorPanel){d.getSponsorPanel().hide()}}})}},onShow:function(){this.getView().setActiveItem(0);var b=this,c=this.getView().getMeetingRecord();if(c!=null){var a=c.SponsorListEvent;if(a.getCount()>0){if(b.getSponsorPanel){b.getSponsorPanel().getController().setStore(a);b.getSponsorPanel().show()}}else{if(b.getSponsorPanel){b.getSponsorPanel().hide()}}}},onDetailItemChange:function(){var b=this.getView();var a=b.getInnerItems().indexOf(b.getActiveItem());if(a==0){b.removeAt(1)}},onCloseSubPanel:function(){this.getView().setActiveItem(0)},setRecord:function(b){var e=this;var a=Personify.utils.Configuration.getCurrentUser();var d={sessionID:b.get("sessionID"),MasterCustomerID:a?a.get("masterCustomerId"):"",SubCustomerID:a?a.get("subCustomerId"):"0"};var g=Personify.utils.ServiceManager.getStoreManager();var f=g.getSessionDetailStore();var c=Ext.create(f);c.setDataRequest(d);c.load({callback:function(i,h,j){if(j){e.onUpdateData(c)}else{Ext.Msg.alert("","Error occurred while loading session detail.")}},scope:this})},onUpdateData:function(e){var b=this.getView().getRecord();if(!b){return}var a=b.get("startDateTime");var c=b.get("endDateTime");var f=b.get("isAdded");var g=this.getView().getMeetingRecord();if(e.getCount()>0){b=e.getAt(0);if(b.get("isAdded")!=f){b.set("isAdded",f)}b.set("appointmentId",b.get("appointmentId"));b.set("startDateTime",a);b.set("endDateTime",c);b.set("locationDescription",this.getView().getRecord().get("locationDescription"))}b.set("timeZoneCode",g.get("timeZoneCode"));this.getHeaderDetailEvent().getController().setRecord(b);this.getSessionMenuList().select(0);var d={xtype:"sessionDetailDescription",record:b};var h=this.getCardMainDetailContainer();h.removeAll(true,true);h.add(d)},onSessionMenuListTap:function(c,e,f,d){if(Personify.utils.Configuration.getAllowChangeView()){var b=this.getView().getRecord();var a=this.getView().getMeetingRecord();var h=(d.component)?d.component:d.get("component");var i={xtype:h,record:b,meetingRecord:a,sessionId:b.get("sessionID"),eventId:a.get("productID")};var g=this.getCardMainDetailContainer();if(h=="presenterlistdetail"){if(b.SpeakerSession&&b.SpeakerSession.getCount()==1){this.onShowPresenterDetails(b.SpeakerSession.getAt(0),false)}else{i.itemId="sessionPresenterList",g.removeAll(true,true);g.add(i)}}else{if(h=="sessionrate"){this.getSessionMenuList().select(0);this.onSessionMenuListTap(c,0,null,{title:"Description",component:"sessionDetailDescription"});me=this;Ext.Function.defer(function(){Ext.apply(i,{itemId:"ratePanel",showCloseButton:true});me.getView().add(i);me.getView().setActiveItem(1)},400)}else{if(h=="sessionnotes"){this.getSessionMenuList().select(0);this.onSessionMenuListTap(c,0,null,{title:"Description",component:"sessionDetailDescription"});Ext.apply(i,{itemId:"notePanel",showCloseButton:true});this.getView().add(i);this.getView().setActiveItem(1)}else{g.removeAll(true,true);g.add(i)}}}}else{Ext.Msg.alert("","Please enter the note title.",Ext.emptyFn)}},onMapButtonTap:function(){var a=this.getView().getRecord();this.getView().fireEvent("buttonmapittap",a)},onInMyScheduleTap:function(){var c=this.getView().getRecord();var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){var b=this.getView();var d=b.getRecord().get("isAdded");if(d){b.fireEvent("deletesession",c,b)}else{this.getView().fireEvent("addsessiontoagenda",c,b)}}else{Personify.utils.ItemUtil.needToLogin();return}},onShowPresenterDetails:function(a,d){if(a){var f=Personify.utils.ServiceManager.getStoreManager();var c=f.getCustomerBiographyStore();var b=Ext.create(c);b.setDataRequest(a);this.getView().setMasked({xtype:"loadmask"});var e=this;b.load({callback:function(h,g,j){var i=e.getCardMainDetailContainer();if(j){var k=Ext.create("Personify.view.profile.ContactInfo",{itemId:"presenterSessionInfo"});k.setListOfInfo(Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("listinfoPresenter"));if(d==false){k.getController().getCloseContactPanel().hide()}else{k.getController().getCloseContactPanel().show()}if(h.length){k.getController().setBioInfo(h[0])}k.getController().setPresenterRecord(a);i.removeAll(true,true);i.add(k)}this.getView().setMasked(false)},scope:this})}},onButtonClosePresenterDetailsTap:function(){var a={component:"presenterlistdetail"};this.onSessionMenuListTap(null,null,null,a);Ext.Viewport.setMasked(false)},onDeactivateView:function(){this.getSponsorPanel().getController().onHideImage()}});