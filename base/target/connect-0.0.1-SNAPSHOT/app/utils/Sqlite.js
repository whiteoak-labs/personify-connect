Ext.define("Personify.utils.Sqlite",{db:null,statics:{init:function(){Personify.utils.Sqlite.db=window.sqlitePlugin.openDatabase("Personify","1.0","Personify",-1);Personify.utils.Sqlite.createTableData()},initNotes:function(){Personify.utils.Sqlite.db=window.sqlitePlugin.openDatabase("Personify","1.0","Personify",-1);Personify.utils.Sqlite.createTableNotes()},initExhibitor:function(){Personify.utils.Sqlite.db=window.sqlitePlugin.openDatabase("Personify","1.0","Personify",-1);Personify.utils.Sqlite.createTableExhibitor()},initNotification:function(){Personify.utils.Sqlite.db=window.sqlitePlugin.openDatabase("Personify","1.0","Personify",-1);Personify.utils.Sqlite.createTableNotification()},initImage:function(){Personify.utils.Sqlite.db=window.sqlitePlugin.openDatabase("Personify","1.0","Personify",-1);Personify.utils.Sqlite.createTableImage()},createTableData:function(){Personify.utils.Sqlite.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS DataCache (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, date TEXT, datarequest TEXT, url TEXT, data TEXT, currentUser TEXT, isInvalid INTEGER DEFAULT 0)")})},createTableImage:function(){Personify.utils.Sqlite.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS Image (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, url TEXT, name TEXT, uuid TEXT)")})},createTableNotes:function(){Personify.utils.Sqlite.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS Notes (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, title TEXT, description TEXT, date TEXT, sessionId TEXT, eventId TEXT)")})},createTableExhibitor:function(){Personify.utils.Sqlite.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS Exhibitor (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, exhibitorId TEXT, eventId TEXT, customerId TEXT, subcustomerId TEXT)")})},createTableNotification:function(){Personify.utils.Sqlite.db.transaction(function(a){a.executeSql("CREATE TABLE IF NOT EXISTS Notification (id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, messageId INTEGER, isDeleted INTEGER)")})},insertTableData:function(e,d,f){Personify.utils.Sqlite.init();var c=new Date();var a=Personify.utils.Configuration.getCurrentProfileUser();if(!a){a=Personify.utils.Configuration.getCurrentUser()}var b="";if(a){b=a.get("masterCustomerId")+":"+a.get("subCustomerId")}Personify.utils.Sqlite.db.transaction(function(g){g.executeSql("INSERT INTO DataCache (date, datarequest, url, data, currentUser) VALUES(?,?,?,?,?)",[c,e,d,f,b],function(h,i){},function(h){throw h})})},getTableData:function(b,a,c){Personify.utils.Sqlite.init();Personify.utils.Sqlite.db.transaction(function(d){d.executeSql("SELECT * FROM DataCache WHERE url = ? AND datarequest = ? ORDER BY id DESC LIMIT 1",[b,a],function(e,f){if(f.rows.length>0){c(f.rows.item(0).data)}else{c(false)}},function(f){c(false)})})},invalidateProfileCache:function(){Personify.utils.Sqlite.init();var d=Personify.utils.ServiceManager.getUrlWS("profileGet"),c=Personify.utils.ServiceManager.getUrlWS("profileUpdate");var a=Personify.utils.Configuration.getCurrentUser();var b="";if(a){b=a.get("masterCustomerId")+":"+a.get("subCustomerId")}Personify.utils.Sqlite.db.transaction(function(e){e.executeSql("UPDATE DataCache SET isInvalid = 1 WHERE (url = ?  OR url = ?) AND currentUser = ?",[d,c,b],function(f,g){},function(f){})})},getProfileData:function(c,f){Personify.utils.Sqlite.init();var e=Personify.utils.ServiceManager.getUrlWS("profileGet"),d=Personify.utils.ServiceManager.getUrlWS("profileUpdate");var a=Personify.utils.Configuration.getCurrentProfileUser();if(!a){a=Personify.utils.Configuration.getCurrentUser()}var b="";if(a){b=a.get("masterCustomerId")+":"+a.get("subCustomerId")}Personify.utils.Sqlite.db.transaction(function(g){g.executeSql("SELECT * FROM DataCache WHERE ((url = ? AND datarequest = ?) OR url =?) AND currentUser = ? AND isInvalid = 0 ORDER BY id DESC LIMIT 1",[e,c,d,b],function(i,k){if(k.rows.length>0){var l=k.rows.item(0).date;var j=Date.parse(l);if(j){var h=(new Date()-new Date(j))/3600000;if(h<24){f(k.rows.item(0).data)}else{f(false)}}else{f(false)}}else{f(false)}},function(h){f(false)})})},insertTableNotes:function(f,d,e,c,b,g){Personify.utils.Sqlite.initNotes();if(b){var a=new Date();Personify.utils.Sqlite.db.transaction(function(h){h.executeSql("UPDATE Notes SET title = ?, description = ?, date = ? WHERE id = ?",[f,d,a,b],function(i,j){g(true)},function(i){g(false)})})}else{var a=new Date();Personify.utils.Sqlite.db.transaction(function(h){h.executeSql("INSERT INTO Notes (title, description, date, sessionId, eventId) VALUES(?,?,?,?,?)",[f,d,a,e,c],function(i,j){g(true)},function(i){g(false)})})}},getAllNotes:function(b,a,c){Personify.utils.Sqlite.initNotes();Personify.utils.Sqlite.db.transaction(function(d){if(b){d.executeSql("SELECT * FROM Notes WHERE sessionId = ? AND eventId = ?",[b,a],function(e,g){var h=[];for(var f=0;f<g.rows.length;f++){h.push(g.rows.item(f))}c(h)},function(f){c(false)})}else{d.executeSql("SELECT * FROM Notes WHERE eventId = ?",[a],function(e,g){var h=[];for(var f=0;f<g.rows.length;f++){h.push(g.rows.item(f))}c(h)},function(f){c(false)})}})},deleteMyNote:function(a,b){Personify.utils.Sqlite.initNotes();Personify.utils.Sqlite.db.transaction(function(c){c.executeSql("DELETE FROM Notes WHERE id = ?",[a],function(d,e){b(true)},function(d){b(false)})})},insertTableExhibitor:function(e,b,c,a,d){Personify.utils.Sqlite.initExhibitor();Personify.utils.Sqlite.db.transaction(function(f){f.executeSql("INSERT INTO Exhibitor (exhibitorId, eventId, customerId, subcustomerId) VALUES(?,?,?,?)",[e,b,c,a],function(g,h){if(typeof d=="function"){d(true)}},function(g){if(typeof d=="function"){d(false)}})})},getMyExhibitor:function(b,c,a,d){Personify.utils.Sqlite.initExhibitor();Personify.utils.Sqlite.db.transaction(function(e){e.executeSql("SELECT * FROM Exhibitor WHERE eventId = ? AND customerId = ? AND subcustomerId = ?",[b,c,a],function(f,h){if(typeof d=="function"){var j=[];for(var g=0;g<h.rows.length;g++){j.push(h.rows.item(g))}d(j)}},function(f){if(typeof d=="function"){d(false)}})})},deleteMyExhibitor:function(e,b,c,a,d){Personify.utils.Sqlite.initExhibitor();Personify.utils.Sqlite.db.transaction(function(f){f.executeSql("DELETE FROM Exhibitor WHERE exhibitorId = ? AND eventId = ? AND customerId = ? AND subcustomerId = ?",[e,b,c,a],function(g,h){d(true)},function(g){d(false)})})},insertTableNotification:function(a,b,c){Personify.utils.Sqlite.initNotification();Personify.utils.Sqlite.getCountNotificationByMessageId(a,function(d){if(d>0){Personify.utils.Sqlite.updateNotification(a,b,function(e){if(e){if(typeof c=="function"){c(true)}}else{if(typeof c=="function"){c(false)}}})}else{Personify.utils.Sqlite.db.transaction(function(e){e.executeSql("INSERT INTO Notification (messageId, isDeleted) VALUES (?,?)",[a,b],function(f,g){if(typeof c=="function"){c(true)}},function(f){if(typeof c=="function"){c(false)}})})}})},getNotification:function(a){Personify.utils.Sqlite.initNotification();Personify.utils.Sqlite.db.transaction(function(b){b.executeSql("SELECT * FROM Notification",[],function(c,e){if(typeof a=="function"){var f=[];for(var d=0;d<e.rows.length;d++){f.push(e.rows.item(d))}a(f)}},function(c){if(typeof a=="function"){a(false)}})})},updateNotification:function(a,b,c){Personify.utils.Sqlite.initNotification();Personify.utils.Sqlite.db.transaction(function(d){d.executeSql("UPDATE Notification SET isDeleted = ? WHERE messageId = ?",[b,a],function(e,f){if(typeof c=="function"){c(true)}},function(f){if(typeof c=="function"){c(false)}})})},getCountNotificationByMessageId:function(a,b){Personify.utils.Sqlite.initNotification();Personify.utils.Sqlite.db.transaction(function(c){c.executeSql("SELECT * FROM Notification WHERE messageId = ?",[a],function(d,e){if(typeof b=="function"){b(e.rows.length)}},function(d){if(typeof b=="function"){b(0)}})})},getCountNotes:function(b,a,c){Personify.utils.Sqlite.initNotes();Personify.utils.Sqlite.db.transaction(function(d){d.executeSql("SELECT * FROM Notes WHERE sessionId = ? AND eventId = ?",[b,a],function(e,f){if(typeof c=="function"){c(f.rows.length)}},function(f){if(typeof c=="function"){c(0)}})})},insertTableImage:function(b,a,c){Personify.utils.Sqlite.initImage();Personify.utils.Sqlite.db.transaction(function(d){d.executeSql("INSERT INTO Image (url, name, uuid) VALUES (?,?,?)",[b,a,c],function(e,f){},function(f){})})},getTableImage:function(a,b){Personify.utils.Sqlite.initImage();Personify.utils.Sqlite.db.transaction(function(c){c.executeSql("SELECT * FROM Image WHERE url = ?",[a],function(d,f){if(typeof b=="function"){var g=[];for(var e=0;e<f.rows.length;e++){g.push(f.rows.item(e))}b(g)}},function(d){})})},}});