Ext.define("Ext.data.proxy.Sql",{alias:"proxy.sql",extend:"Ext.data.proxy.Client",alternateClassName:"Ext.data.proxy.SQL",isSQLProxy:true,config:{reader:null,writer:null,table:null,database:"Sencha",columns:"",uniqueIdStrategy:false,tableExists:false,defaultDateFormat:"Y-m-d H:i:s.u"},updateModel:function(b){if(b){var a=b.modelName,d=this.getDefaultDateFormat(),c=a.slice(a.lastIndexOf(".")+1);b.getFields().each(function(e){if(e.getType().type==="date"&&!e.getDateFormat()){e.setDateFormat(d)}});this.setUniqueIdStrategy(b.getIdentifier().isUnique);if(!this.getTable()){this.setTable(c)}this.setColumns(this.getPersistedModelColumns(b))}this.callParent(arguments)},setException:function(a,b){a.setException(b)},create:function(c,g,d){var e=this,b=e.getDatabaseObject(),a=c.getRecords(),f=e.getTableExists();c.setStarted();b.transaction(function(h){if(!f){e.createTable(h)}e.insertRecords(a,h,function(j,i){if(c.process(c.getAction(),j)===false){e.fireEvent("exception",e,c)}if(i){c.setException(i)}},e)},function(i,h){e.setException(c,h);if(typeof g=="function"){g.call(d||e,c)}},function(h){if(typeof g=="function"){g.call(d||e,c)}})},read:function(m,f,b){var s=this,r=s.getDatabaseObject(),d=s.getModel(),j=d.getIdProperty(),c=s.getTableExists(),q=m.getParams()||{},n=q[j],a=m.getSorters(),l=m.getFilters(),g=m.getPage(),e=m.getStart(),p=m.getLimit(),h,o,k;q=Ext.apply(q,{page:g,start:e,limit:p,sorters:a,filters:l});m.setStarted();r.transaction(function(i){if(!c){s.createTable(i)}s.selectRecords(i,n!==undefined?n:q,function(u,t){if(m.process(m.getAction(),u)===false){s.fireEvent("exception",s,m)}if(t){m.setException(t)}if(l&&l.length){h=Ext.create("Ext.util.Collection",function(v){return v.getId()});h.setFilterRoot("data");for(o=0,k=l.length;o<k;o++){if(l[o].getProperty()===null){h.addFilter(l[o])}}h.addAll(m.getRecords());m.setRecords(h.items.slice());u.setRecords(m.getRecords());u.setCount(h.items.length);u.setTotal(h.items.length)}})},function(t,i){s.setException(m,i);if(typeof f=="function"){f.call(b||s,m)}},function(i){if(typeof f=="function"){f.call(b||s,m)}})},update:function(c,g,d){var e=this,b=c.getRecords(),a=e.getDatabaseObject(),f=e.getTableExists();c.setStarted();a.transaction(function(h){if(!f){e.createTable(h)}e.updateRecords(h,b,function(i,j){if(c.process(c.getAction(),i)===false){e.fireEvent("exception",e,c)}if(j){c.setException(j)}})},function(i,h){e.setException(c,h);if(typeof g=="function"){g.call(d||e,c)}},function(h){if(typeof g=="function"){g.call(d||e,c)}})},destroy:function(c,g,d){var e=this,b=c.getRecords(),a=e.getDatabaseObject(),f=e.getTableExists();c.setStarted();a.transaction(function(h){if(!f){e.createTable(h)}e.destroyRecords(h,b,function(j,i){if(c.process(c.getAction(),j)===false){e.fireEvent("exception",e,c)}if(i){c.setException(i)}})},function(i,h){e.setException(c,h);if(typeof g=="function"){g.call(d||e,c)}},function(h){if(typeof g=="function"){g.call(d||e,c)}})},createTable:function(a){a.executeSql("CREATE TABLE IF NOT EXISTS "+this.getTable()+" ("+this.getSchemaString()+")");this.setTableExists(true)},insertRecords:function(b,a,o,q){var m=this,p=m.getTable(),c=m.getColumns(),l=b.length,f=0,e=[],h=[],n=[],g=m.getUniqueIdStrategy(),d,j,k,r;r=new Ext.data.ResultSet({records:h,success:true});for(d=0,j=c.length;d<j;d++){e.push("?")}k=e.join(", ");Ext.each(b,function(i){var u=i.getId(),t=m.getRecordData(i),s=m.getColumnValues(c,t);a.executeSql("INSERT INTO "+p+" ("+c.join(", ")+") VALUES ("+k+")",s,function(w,v){f++;h.push({clientId:u,id:g?u:v.insertId,data:t,node:t});if(f===l&&typeof o=="function"){o.call(q||m,r,n.length>0?n:null)}},function(w,v){f++;n.push({clientId:u,error:v});if(f===l&&typeof o=="function"){o.call(q||m,r,n)}})})},selectRecords:function(p,t,c,b){var u=this,s=u.getTable(),f=u.getModel().getIdProperty(),r="SELECT * FROM "+s,q=[],a=" WHERE ",l=" ORDER BY ",o,g,v,k,e,h,j,n,d,m;k=new Ext.data.ResultSet({records:q,success:true});if(!Ext.isObject(t)){r+=a+f+" = "+t}else{g=t.filters&&t.filters.length;if(g){for(o=0;o<g;o++){j=t.filters[o];d=j.getProperty();m=j.getValue();if(d!==null){r+=a+d+" "+(j.getAnyMatch()?("LIKE '%"+m+"%'"):("= '"+m+"'"));a=" AND "}}}g=t.sorters&&t.sorters.length;if(g){for(o=0;o<g;o++){n=t.sorters[o];d=n.getProperty();if(d!==null){r+=l+d+" "+n.getDirection();l=", "}}}if(t.page!==undefined){r+=" LIMIT "+parseInt(t.start,10)+", "+parseInt(t.limit,10)}}p.executeSql(r,null,function(w,i){h=i.rows;e=h.length;for(o=0,g=e;o<g;o++){v=h.item(o);q.push({clientId:null,id:v[f],data:v,node:v})}k.setSuccess(true);k.setTotal(e);k.setCount(e);if(typeof c=="function"){c.call(b||u,k)}},function(w,i){k.setSuccess(false);k.setTotal(0);k.setCount(0);if(typeof c=="function"){c.call(b||u,k,i)}})},updateRecords:function(a,b,l,o){var j=this,n=j.getTable(),d=j.getColumns(),h=b.length,m=j.getModel().getIdProperty(),f=0,c=[],k=[],e,g,p;p=new Ext.data.ResultSet({records:c,success:true});Ext.each(b,function(i){var t=i.getId(),r=j.getRecordData(i),q=j.getColumnValues(d,r),s=[];for(e=0,g=d.length;e<g;e++){s.push(d[e]+" = ?")}a.executeSql("UPDATE "+n+" SET "+s.join(", ")+" WHERE "+m+" = ?",q.concat(t),function(v,u){f++;c.push({clientId:t,id:t,data:r,node:r});if(f===h&&typeof l=="function"){l.call(o||j,p,k.length>0?k:null)}},function(v,u){f++;k.push({clientId:t,error:u});if(f===h&&typeof l=="function"){l.call(o||j,p,k)}})})},destroyRecords:function(b,c,k,m){var h=this,l=h.getTable(),n=h.getModel().getIdProperty(),a=[],j=[],d=[],e,g,o,f;for(e=0,g=c.length;e<g;e++){a.push(n+" = ?");j.push(c[e].getId())}o=new Ext.data.ResultSet({records:d,success:true});b.executeSql("DELETE FROM "+l+" WHERE "+a.join(" OR "),j,function(p,i){for(e=0,g=c.length;e<g;e++){f=c[e];d.push({id:f.getId()})}if(typeof k=="function"){k.call(m||h,o)}},function(p,i){if(typeof k=="function"){k.call(m||h,o,i)}})},getRecordData:function(b){var f=this,a=b.getFields(),d=b.getIdProperty(),e=f.getUniqueIdStrategy(),h={},c,g;a.each(function(i){if(i.getPersist()){c=i.getName();if(c===d&&!e){return}g=b.get(c);if(i.getType().type=="date"){g=f.writeDate(i,g)}h[c]=g}},f);return h},getColumnValues:function(c,g){var e=c.length,a=[],b,d,f;for(b=0;b<e;b++){d=c[b];f=g[d];if(f!==undefined){a.push(f)}}return a},getSchemaString:function(){var j=this,b=[],d=j.getModel(),l=d.getIdProperty(),f=d.getFields().items,e=j.getUniqueIdStrategy(),g=f.length,c,k,h,a;for(c=0;c<g;c++){k=f[c];h=k.getType().type;a=k.getName();if(a===l){if(e){h=j.convertToSqlType(h);b.unshift(l+" "+h)}else{b.unshift(l+" INTEGER PRIMARY KEY AUTOINCREMENT")}}else{h=j.convertToSqlType(h);b.push(a+" "+h)}}return b.join(", ")},getPersistedModelColumns:function(d){var f=d.getFields().items,e=this.getUniqueIdStrategy(),j=d.getIdProperty(),b=[],g=f.length,c,h,a;for(c=0;c<g;c++){h=f[c];a=h.getName();if(a===j&&!e){continue}if(h.getPersist()){b.push(h.getName())}}return b},convertToSqlType:function(a){switch(a.toLowerCase()){case"date":case"string":case"auto":return"TEXT";case"int":return"INTEGER";case"float":return"REAL";case"bool":return"NUMERIC"}},writeDate:function(c,b){if(Ext.isEmpty(b)){return null}var a=c.getDateFormat()||this.getDefaultDateFormat();switch(a){case"timestamp":return b.getTime()/1000;case"time":return b.getTime();default:return Ext.Date.format(b,a)}},dropTable:function(b){var e=this,d=e.getTable(),f=b?b.callback:null,c=b?b.scope||e:null,a=e.getDatabaseObject();a.transaction(function(g){g.executeSql("DROP TABLE "+d)},function(h,g){if(typeof f=="function"){f.call(c||e,false,d,g)}},function(g){if(typeof f=="function"){f.call(c||e,true,d)}});e.setTableExists(false)},getDatabaseObject:function(){return openDatabase(this.getDatabase(),"1.0","Sencha Database",5*1024*1024)}});