Ext.define("Ext.data.plugin.Buffered",{alias:"plugin.storebuffered",extend:"Ext.Evented",requires:["Ext.util.BufferedCollection"],config:{store:null,trailingBufferZone:25,leadingBufferZone:50,purgePageCount:5,viewSize:0,bufferedCollection:{}},init:function(a){this.setStore(a);this.pageRequests={}},applyBufferedCollection:function(a){return Ext.factory(a,Ext.util.BufferedCollection,this.getBufferedCollection())},updateBufferedCollection:function(b){var a=this.getStore();if(a){Ext.destroy(a.data);a.data=b}},updateStore:function(a){if(a){a.setRemoteSort(true);a.setRemoteFilter(true);a.setRemoteGroup(true);a.setPageSize(this.getViewSize());this.updateBufferedCollection(this.getBufferedCollection());Ext.Function.interceptBefore(a,"add",function(){Ext.Error.raise({msg:"add method may not be called on a buffered store"})});Ext.apply(a,{load:Ext.Function.bind(this.load,this),buffered:this})}},updateViewSize:function(b){var a=this.getStore();if(a){a.setPageSize(b);this.getBufferedCollection().setPageSize(b)}},requestRange:function(d,a,c,b){if(this.isRangeCached(d,a)){c.call(b||this,this.getBufferedCollection().getRange(d,a))}else{this.loadPrefetch({start:d,limit:a-d,callback:c,scope:b||this})}},load:function(b,d){var a=this.getStore(),c=a.currentPage,e=this.getViewSize();b=b||{};if(Ext.isFunction(b)){b={callback:b,scope:d||this}}Ext.applyIf(b,{sorters:a.getSorters(),filters:a.getFilters(),grouper:a.getGrouper(),page:c,start:(c-1)*e,limit:e,addRecords:false,action:"read",model:a.getModel()});this.loadPrefetch(b)},loadPrefetch:function(p){var k=this,m=p.start,g=p.start+p.limit-1,e=k.getTrailingBufferZone(),f=k.getLeadingBufferZone(),h=k.getPageFromRecordIndex(Math.max(m-e,0)),o=k.getPageFromRecordIndex(g+f),j=k.getBufferedCollection(),l=k.getStore(),b=Ext.apply({},p),c,n,d,a;c=function(){if(k.isRangeCached(m,g)){l.loading=false;j.un("pageadded",c);a=j.getRange(m,g);if(p.callback){p.callback.call(p.scope||k,a,m,g,p)}}};delete b.callback;l.on("prefetch",function(q,i,r){if(r){n=q.getTotalCount();if(n){j.on("pageadded",c);g=Math.min(g,n-1);o=k.getPageFromRecordIndex(Math.min(g+f,n-1));for(d=h+1;d<=o;++d){k.prefetchPage(d,b)}}}},this,{single:true});k.prefetchPage(h,b)},prefetchPage:function(c,a){var b=this,d=b.getViewSize();b.prefetch(Ext.applyIf({page:c,start:(c-1)*d,limit:d},a))},prefetch:function(d){var e=this,a=e.getViewSize(),c=e.getStore(),b;if(!d.page){d.page=e.getPageFromRecordIndex(d.start);d.start=(d.page-1)*a;d.limit=Math.ceil(d.limit/a)*a}if(!e.pageRequests[d.page]){d=Ext.applyIf({action:"read",sorters:c.getSorters(),filters:c.getFilters(),grouper:c.getGrouper()},d);b=Ext.create("Ext.data.Operation",d);if(c.fireEvent("beforeprefetch",e,b)!==false){e.pageRequests[d.page]=c.getProxy().read(b,e.onProxyPrefetch,e)}}return e},onProxyPrefetch:function(b){var f=this,h=b.getResultSet(),a=b.getRecords(),c=b.wasSuccessful(),i=f.getStore(),d=f.getBufferedCollection(),e=b.getPage(),g;if(h){g=h.getTotal();if(g!==i.getTotalCount()){i.setTotalCount(g);d.setTotalCount(g);i.fireEvent("totalcountchange",i,g)}}i.loading=false;if(c){f.cachePage(a,e)}i.fireEvent("prefetch",i,a,c,b);Ext.callback(b.callback,b.scope||f,[a,b,c])},cachePage:function(a,e){var d=this,f=d.getBufferedCollection(),c=a.length,b;for(b=0;b<c;b++){a[b].join(d)}f.addPage(e,a)},getPageFromRecordIndex:function(a){return Math.floor(a/this.getViewSize())+1},isRangeCached:function(b,a){return this.getBufferedCollection().hasRange(b,a)}});