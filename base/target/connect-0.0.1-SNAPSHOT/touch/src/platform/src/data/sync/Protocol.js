Ext.data.Protocol=Ext.extend(Object,{constructor:function(a){this.remote=a.remoteStorageProxy;this.remote.on("exception",function(c,d,b){console.log("EXCEPTION");console.log(d);console.log(b)})},sync:function(a,c,b){if(c===undefined){c=function(){}}this.send_create_database(a.definition,function(e){var d=e.response;switch(d.r){case"ok":var f=d.csv;a.addReplicaNumbers(f);this.sync_datastore(a,f,c,b);break;case"new_replica_number":a.setReplicaNumber(d.replica_number,function(){this.sync(a,c,b)},this);break;case"new_generation_number":if(d.generation>a.definition.generation){a.definition.set({generation:d.generation},function(){a.clear(function(){this.sync(a,c,b)},this)},this)}else{}break;default:c.call(b);break}},this)},sync_datastore:function(a,d,c,b){a.getUpdates(d,function(e){this.put_database_updates(a.definition,e,function(f){if(d.dominates(a.csv)){this.get_database_updates(a,c,b)}else{c.call(b)}},this)},this)},send_create_database:function(a,d,b){var c=a.encode();this.sendRequest(a.database_name,"edit",c,function(f){var e=f.response;if(e.csv){e.csv=new Ext.data.CSV().decode(e.csv)}d.call(b,f)},this)},put_database_updates:function(a,c,e,b){var d=c.chunks(1000);Ext.data.array.forEachYielding(d,function(g,f,h){this.send_put_database_updates(a,g,function(i){f.call(h)},this)},this,e,b)},send_put_database_updates:function(b,e,f,c){if(!e.isEmpty()){var d={updates:Ext.encode(e.encode())};this.sendRequest(b.database_name,"put_updates",d,f,c)}else{var a=this.encodeRequest({});a.response={r:"ok"};f.call(c,a)}},get_database_updates:function(a,c,b){this.send_get_database_updates(a.definition,a.csv,function(e){var d=e.response;if(d.r=="ok"){a.putUpdates(d.updates,function(){if(d.remaining>0&&!d.updates.isEmpty()){this.get_database_updates(a,c,b)}else{c.call(b)}},this)}else{c.call(b)}},this)},send_get_database_updates:function(b,a,e,c){var d={csv:a.encode()};this.sendRequest(b.database_name,"get_updates",d,function(g){var f=g.response;f.updates=new Ext.data.Updates().decode(f.updates);e.call(c,g)},this)},sendRequest:function(a,g,e,f,d){var c=this.encodeRequest(a,g,e);var b=true;if(b){console.log("local ->",this.remote.url,g,Ext.encode(e))}this.remote.read(c,function(h){if(b){console.log("  sent",h.request.url.length,"bytes -",h.request.url);console.log("  <= ",g,Ext.encode(h.response))}f.call(d,h)},this)},encodeRequest:function(a,e,c){var d=Ext.encode(c);var b=this.remote.url+"database/"+a+"/"+e;return new Ext.data.Operation({filters:[],action:"read",url:b,params:c});return operation}});