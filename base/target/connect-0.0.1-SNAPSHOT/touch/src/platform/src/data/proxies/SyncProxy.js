Ext.data.SyncProxy=Ext.extend(Ext.data.Proxy,{definition:undefined,csv:undefined,generator:undefined,model:undefined,store:undefined,idProperty:undefined,idDefaultProperty:undefined,constructor:function(a,c,b){Ext.data.utilities.check("SyncProxy","constructor","config",a,["store","database_name","key"]);Ext.data.SyncProxy.superclass.constructor.call(this,a);this.store=a.store;this.store.readValue("Sencha.Sync.system_name",function(d){a.system_name=d||Ext.data.UUIDGenerator.generate();this.store.writeValue("Sencha.Sync.system_name",a.system_name,function(){Ext.data.utilities.apply(this,["readConfig_DatabaseDefinition","readConfig_CSV","readConfig_Generator"],[a],function(){if(this.definition.system_name===undefined){this.definition.set({system_name:Ext.data.UUIDGenerator.generate()})}console.log("SyncProxy - Opened database '"+a.key+"/"+a.database_name+"/"+a.datastore_name+"'");if(c){c.call(b,this)}},this)},this)},this)},create:function(b,d,c){b.records.forEach(function(e){e.setCreateState(this.makeGenerator());if(e.get(this.idProperty)===this.idPropertyDefaultValue){var f=e.getPair(Ext.data.SyncModel.OID);e.data[this.idProperty]=f.v}},this);var a=this.encodeRecords(b.records);return this.store.create(a,function(){this.indexCreatedRecords(a,function(){this.doCallback(d,c,b)},this)},this)},read:function(b,e,d){function c(g,f,h){f=this.decodeRecords(f);f=Ext.data.array.select(f,function(i){return i.isNotDestroyed()&&!i.phantom&&(!h||!i.isSystemModel())},this);g.resultSet=new Ext.data.ResultSet({records:f,total:f.length,loaded:true})}if(b.id!==undefined){this.store.indexLookup(b.id,function(f){this.store.read(f,function(g){c.call(this,b,[g],true);this.doCallback(e,d,b)},this)},this)}else{if(b[Ext.data.SyncModel.OID]!==undefined){this.store.read(b[Ext.data.SyncModel.OID],function(f){c.call(this,b,[f],false);this.doCallback(e,d,b)},this)}else{var a=[];this.store.forEachRecordAsync(function(g,f,h){a.push(g);f.call(h)},this,function(){c.call(this,b,a,true);this.doCallback(e,d,b)},this)}}},update:function(b,d,c){b.records.forEach(function(e){e.setUpdateState(this.makeGenerator())},this);var a=this.encodeRecords(b.records);return this.store.update(a,function(e){this.doCallback(d,c,e)},this)},destroy:function(b,d,c){var a=[];Ext.data.array.forEachAsync(b.records,function(f,e,h){f.setDestroyState(this.makeGenerator());var g=f.oid();if(!g){var i=f.data[this.idProperty];this.store.indexLookup(i,function(j){if(j){f.data[Ext.data.SyncModel.OID]=j;a.push(f)}e.call(h)},this)}else{a.push(f);e.call(h)}},this,function(){a=this.encodeRecords(a);this.store.update(a,function(e){e.action="destroy";this.indexDestroyedRecords(a,function(){this.doCallback(d,c,e)},this)},this)},this)},clear:function(b,a){this.store.clear(b,a)},setModel:function(b,d){this.model=b;this.idProperty=this.model.prototype.idProperty;var a=this.model.prototype.fields.items,e=a.length,f,c;for(c=0;c<e;c++){f=a[c];if(f.name===this.idProperty){this.idPropertyDefaultValue=f.defaultValue}}this.definition.set({idProperty:this.idProperty,idPropertyDefaultValue:this.idPropertyDefaultValue},function(){},this);Ext.apply(b.prototype,Ext.data.SyncModel);this.storageModel=b.prototype.createReplStorageModel(this.modelName);this.store.setModel(this.storageModel,d)},replicaNumber:function(){return this.generator.r},addReplicaNumbers:function(a,c,b){this.csv.addReplicaNumbers(a,c,b)},setReplicaNumber:function(c,d,b){if(!d){throw"ERROR - SyncProxy - setReplicaNumber - no callback provided."}var a=this.replicaNumber();console.log("SyncProxy.setReplicaNumber from",a,"to",c);this.changeReplicaNumber(a,c,function(){this.definition.setReplicaNumber(c,function(){this.csv.changeReplicaNumber(a,c,function(){this.generator.setReplicaNumber(c,d,b)},this)},this)},this)},changeReplicaNumber:function(a,c,d,b){console.log("SyncProxy.changeReplicaNumber from",a,"to",c);if(!d){throw"ERROR - SyncProxy - changeReplicaNumber - no callback provided."}this.forEachRecordAsync(function(g,e,i){if(!g.isSystemModel()){var f=g.oid();if(g.changeReplicaNumber(a,c)){var h=this.encodeRecords([g]);this.store.create(h,function(){this.indexCreatedRecords(h,function(){this.store.destroy(f,e,i)},this)},this)}else{e.call(i)}}else{e.call(i)}},this,d,b)},getUpdates:function(a,c,b){this.csv.addReplicaNumbers(a,function(){a.addReplicaNumbers(this.csv,function(){var d=[];this.forEachRecordAsync(function(f,e,g){d=d.concat(f.getUpdates(a));e.call(g)},this,function(){c.call(b,new Ext.data.Updates(d))},this)},this)},this)},putUpdates:function(b,d,a){var c=b.chunks(10);Ext.data.array.forEachYielding(c,function(f,e,g){Ext.data.array.forEachAsync(f.updates,function(j,i,h){this.applyUpdate(j,function(){this.generator.seen(j.c);this.csv.add(j.c,i,h)},this)},this,e,g)},this,d,a)},applyUpdate:function(d,c,a,b){if(b){console.log("ref ==> ",this.us(d))}else{console.log("applyUpdate",this.us(d))}this.store.read(d.i,function(e){if(e){var f=e.ref();if(f&&d.p[0]!="_"){if(d.i===f){console.log("Error - applyUpdate - Infinite loop following reference. ",f);c.call(a)}else{d.i=f;this.applyUpdate(d,c,a,f)}}else{if(d.p===this.idProperty){this.applyUpdateToRecordForUniqueID(e,d,c,a)}else{this.applyUpdateToRecord(e,d,c,a)}}}else{this.applyUpdateCreatingNewRecord(d,c,a)}},this)},applyUpdateCreatingNewRecord:function(d,c,b){if(d.p===Ext.data.SyncModel.OID){var a=this.createNewRecord(d.v,d.c);this.store.create([a],c,b)}else{console.log("Warning - Update received for unknown record "+d.i,d);var a=this.createNewRecord(d.i,d.i);a.setPair(d.p,d.v,d.c);this.store.create([a],c,b)}},applyUpdateToRecordForUniqueID:function(a,d,c,b){if(a.data[d.p]===d.v){this.applyUpdateToRecordForUniqueId(a,d,c,b)}else{this.store.indexLookup(d.v,function(e){if(e){this.readById(d.v,e,function(f){this.applyUpdateToRecordForUniqueId(a,d,function(){var i=new Ext.data.CS(a.oid());var j=new Ext.data.CS(f.oid());var g,h;if(i.greaterThan(j)){g=f;h=a}else{g=a;h=f}this.resolveUniqueIDConflict(g,h,function(){this.store.indexUpdate(d.v,g.oid(),c,b)},this)},this)},this)}else{this.applyUpdateToRecordForUniqueId(a,d,c,b)}},this)}},applyUpdatesToRecord:function(a,c,d,b){if(c.length>0){Ext.data.array.forEachAsync(c,function(g,e,f){this.applyUpdateToRecord(a,g,e,f)},this,d,b)}else{d.call(b)}},applyUpdateToRecordForUniqueId:function(a,f,e,c){var d=a.data[f.p];var b=f.v;this.applyUpdateToRecord(a,f,function(g){if(g){this.store.indexUpdate(b,a.oid(),function(){if(d){this.store.indexUpdate(d,undefined,function(){e.call(c,g)},this)}else{e.call(c,g)}},this)}else{e.call(c,g)}},this)},applyUpdateToRecord:function(a,d,c,b){if(a.putUpdate(d)){this.store.update([a],function(){c.call(b,true)},b)}else{c.call(b,false)}},readById:function(d,b,c,a){this.store.read(b,function(e){if(e){c.call(a,e)}else{console.log("ERROR - SyncProxy - applyUpdateToUniqueID - ID Index refers to an non-existant object:",d,"=>",b,"(This should not be possible.)")}},this)},resolveUniqueIDConflict:function(b,a,e,c){var d=this.updatesForMergeRecords(b,a);this.applyUpdatesToRecord(b,d,function(){var f=this.updatesForMakeReference(a,b);this.applyUpdatesToRecord(a,f,function(){e.call(c)},this)},this)},updatesForMergeRecords:function(d,b){var a=d.getCSV();var f=b.getUpdates(a);var e=[];var c=d.oid();f.forEach(function(g){if(g.p!==this.idProperty&&g.p!==Ext.data.SyncModel.OID){g.i=c;e.push(g)}},this);return e},updatesForMakeReference:function(b,a){if(b.oid()===a.oid()){console.log("updatesForMakeReference",b.data,a.data);throw"Error - SyncProxy - Tried to create reference to self."}var d=this.generateChangeStamp();var c=this.generateChangeStamp();var e=[{i:b.oid(),p:Ext.data.SyncModel.REF,v:a.oid(),c:d},{i:b.oid(),p:Ext.data.SyncModel.TOMBSTONE,v:c.to_s(),c:c}];return e},createNewRecord:function(c,b){var a=new this.storageModel();a.phantom=false;Ext.apply(a,Ext.data.SyncModel);a.setPair(Ext.data.SyncModel.OID,c,b);return a},indexCreatedRecords:function(a,c,b){Ext.data.array.forEachAsync(a,function(e,d,g){var f=e.data[this.idProperty];if(f){this.store.indexUpdate(f,e.data[Ext.data.SyncModel.OID],d,g)}else{d.call(g)}},this,c,b)},indexDestroyedRecords:function(a,c,b){Ext.data.array.forEachAsync(a,function(e,d,g){var f=e.data[this.idProperty];if(f){this.store.indexUpdate(f,undefined,d,g)}else{d.call(g)}},this,c,b)},makeGenerator:function(){var a=this;return function(){return a.generateChangeStamp()}},generateChangeStamp:function(){var a=this.generator.get();this.csv.add(a);return a},equals:function(a,c,b){if(this.csv.equals(a.csv)){this.hasSameRecords(a,function(d){if(d){a.hasSameRecords(this,c,b)}else{c.call(b,false)}},this)}else{c.call(b,false)}},hasSameRecords:function(a,c,b){this.forEachRecordAsync(function(e,d,f){this.store.read(e.oid(),function(g){if(g){var h=e.equals(g);if(h){d.call(f)}else{console.log("hasSameRecords - false - ",this.replicaNumber(),a.replicaNumber());c.call(b,false)}}else{console.log("hasSameRecords - false - ",this.replicaNumber(),a.replicaNumber());c.call(b,false)}},this)},this,function(){c.call(b,true)},this)},console_log:function(b,c,a){console.log("---- ",b);this.forEachRecordAsync(function(e,d,f){console.log(Ext.encode(e.data));d.call(f)},this,function(){console.log("----");c.call(a)},this)},forEachRecordAsync:function(e,c,a,b){var d=this.model;this.store.forEachRecordAsync(function(g,f,h){e.call(c,new d(g.data),f,h)},this,a,b)},encodeRecords:function(a){var b=this.storageModel;return Ext.data.array.collect(a,function(){var c=new b(this.data);c.internalId=this.internalId;c.phantom=false;return c})},decodeRecords:function(a){var b=this.model;return Ext.data.array.collect(a,function(){var c=new b(this.data);c.internalId=this.internalId;c.phantom=false;return c})},readConfig_DatabaseDefinition:function(b,e,d){var c={key:b.key,system_name:b.system_name,generation:0,replica_number:0};var a={database_name:b.database_name,replica_type:b.replica_type};this.readConfig(Ext.data.DatabaseDefinition,"definition",c,a,function(f){this.definition=f;e.call(d)},this)},readConfig_Generator:function(b,d,c){var a={r:this.definition.replica_number,clock:b.clock};this.readConfig(Ext.data.CSGenerator,"generator",{},a,function(e){this.generator=e;d.call(c)},this)},readConfig_CSV:function(a,c,b){this.readConfig(Ext.data.CSV,"csv",{},{},function(d){this.csv=d;c.call(b)},this)},writeConfig:function(d,a,c,b){this.store.writeConfig(d,a.as_data(),function(e){a.set(e);c.call(b)},this)},readConfig:function(e,h,c,a,g,d){var f,b;this.store.readConfig(h,function(j){if(c!==undefined){if(j===undefined){j=c}else{for(b in c){if(j[b]===undefined){j[b]=c[b];f=true}}}}if(a!==undefined){if(j===undefined){j=a}else{for(b in a){if(j[b]!==a[b]){j[b]=a[b];f=true}}}}var i=this;j.config_id=h;j.write_fn=function(k,l,m){i.writeConfig.call(i,h,k,l,m)};g.call(d,new e(j))},this)},doCallback:function(c,b,a){if(typeof c=="function"){c.call(b||this,a)}},us:function(b){var c=Ext.isArray(b.p)?b.p.join():b.p;var a=b.v;switch(typeof b.v){case"object":a=Ext.encode(b.v)}return"("+b.i+" . "+c+" = '"+a+"' @ "+b.c.to_s()+")"}});