Ext.define("Ext.direct.RemotingProvider",{alias:"direct.remotingprovider",extend:"Ext.direct.JsonProvider",requires:["Ext.util.MixedCollection","Ext.util.DelayedTask","Ext.direct.Transaction","Ext.direct.RemotingMethod"],config:{namespace:undefined,url:null,enableUrlEncode:null,enableBuffer:10,maxRetries:1,timeout:undefined,actions:{}},constructor:function(a){var b=this;b.callParent(arguments);b.transactions=Ext.create("Ext.util.Collection",function(c){return c.getId()});b.callBuffer=[]},applyNamespace:function(a){if(Ext.isString(a)){return Ext.ns(a)}return a||window},initAPI:function(){var g=this.getActions(),d=this.getNamespace(),f,a,b,c,e,h;for(f in g){if(g.hasOwnProperty(f)){a=d[f];if(!a){a=d[f]={}}b=g[f];for(c=0,e=b.length;c<e;++c){h=Ext.create("Ext.direct.RemotingMethod",b[c]);a[h.getName()]=this.createHandler(f,h)}}}},createHandler:function(c,d){var b=this,a;if(!d.getFormHandler()){a=function(){b.configureRequest(c,d,Array.prototype.slice.call(arguments,0))}}else{a=function(f,g,e){b.configureFormRequest(c,d,f,g,e)}}a.directCfg={action:c,method:d};return a},isConnected:function(){return !!this.connected},connect:function(){var a=this;if(a.getUrl()){a.initAPI();a.connected=true;a.fireEvent("connect",a)}else{Ext.Error.raise("Error initializing RemotingProvider, no url configured.")}},disconnect:function(){var a=this;if(a.connected){a.connected=false;a.fireEvent("disconnect",a)}},runCallback:function(e,b){var d=!!b.getStatus(),c=d?"success":"failure",f=e&&e.getCallback(),a;if(f){a=b.getResult();if(Ext.isFunction(f)){f(a,b,d)}else{Ext.callback(f[c],f.scope,[a,b,d]);Ext.callback(f.callback,f.scope,[a,b,d])}}},onData:function(k,h,c){var f=this,d=0,e,j,a,b,g;if(h){j=f.createEvents(c);for(e=j.length;d<e;++d){a=j[d];b=f.getTransaction(a);f.fireEvent("data",f,a);if(b){f.runCallback(b,a,true);Ext.direct.Manager.removeTransaction(b)}}}else{g=[].concat(k.transaction);for(e=g.length;d<e;++d){b=f.getTransaction(g[d]);if(b&&b.getRetryCount()<f.getMaxRetries()){b.retry()}else{a=Ext.create("Ext.direct.ExceptionEvent",{data:null,transaction:b,code:Ext.direct.Manager.exceptions.TRANSPORT,message:"Unable to connect to the server.",xhr:c});f.fireEvent("data",f,a);if(b){f.runCallback(b,a,false);Ext.direct.Manager.removeTransaction(b)}}}}},getTransaction:function(a){return a&&a.getTid?Ext.direct.Manager.getTransaction(a.getTid()):null},configureRequest:function(d,a,f){var g=this,c=a.getCallData(f),e=c.data,h=c.callback,i=c.scope,b;b=Ext.create("Ext.direct.Transaction",{provider:g,args:f,action:d,method:a.getName(),data:e,callback:i&&Ext.isFunction(h)?Ext.Function.bind(h,i):h});if(g.fireEvent("beforecall",g,b,a)!==false){Ext.direct.Manager.addTransaction(b);g.queueTransaction(b);g.fireEvent("call",g,b,a)}},getCallData:function(a){return{action:a.getAction(),method:a.getMethod(),data:a.getData(),type:"rpc",tid:a.getId()}},sendRequest:function(g){var f=this,e={url:f.getUrl(),callback:f.onData,scope:f,transaction:g,timeout:f.getTimeout()},a,c=f.getEnableUrlEncode(),b=0,d,h;if(Ext.isArray(g)){a=[];for(d=g.length;b<d;++b){a.push(f.getCallData(g[b]))}}else{a=f.getCallData(g)}if(c){h={};h[Ext.isString(c)?c:"data"]=Ext.encode(a);e.params=h}else{e.jsonData=a}Ext.Ajax.request(e)},queueTransaction:function(c){var b=this,a=b.getEnableBuffer();if(c.getForm()){b.sendFormRequest(c);return}b.callBuffer.push(c);if(a){if(!b.callTask){b.callTask=Ext.create("Ext.util.DelayedTask",b.combineAndSend,b)}b.callTask.delay(Ext.isNumber(a)?a:10)}else{b.combineAndSend()}},combineAndSend:function(){var a=this.callBuffer,b=a.length;if(b>0){this.sendRequest(b==1?a[0]:a);this.callBuffer=[]}},configureFormRequest:function(e,a,b,h,i){var g=this,c,f,d;c=new Ext.direct.Transaction({provider:g,action:e,method:a.getName(),args:[b,h,i],callback:i&&Ext.isFunction(h)?Ext.Function.bind(h,i):h,isForm:true});if(g.fireEvent("beforecall",g,c,a)!==false){Ext.direct.Manager.addTransaction(c);f=String(b.getAttribute("enctype")).toLowerCase()=="multipart/form-data";d={extTID:c.id,extAction:e,extMethod:a.getName(),extType:"rpc",extUpload:String(f)};Ext.apply(c,{form:Ext.getDom(b),isUpload:f,params:h&&Ext.isObject(h.params)?Ext.apply(d,h.params):d});g.fireEvent("call",g,c,a);g.sendFormRequest(c)}},sendFormRequest:function(b){var a=this;Ext.Ajax.request({url:a.getUrl(),params:b.params,callback:a.onData,scope:a,form:b.form,isUpload:b.isUpload,transaction:b})}});