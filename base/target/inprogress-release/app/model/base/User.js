Ext.define("Personify.model.base.User",{extend:"Personify.base.Model",requires:["Personify.model.base.user.Address","Personify.model.base.user.Role","Personify.model.base.user.Email","Personify.model.base.user.Name","Personify.store.base.ModuleConfiguration"],config:{useCache:false,viewModuleStore:null,storeProfileDisplayOption:null,fields:[{name:"id",type:"string"},{name:"masterCustomerId",type:"string",defaultValue:""},{name:"subCustomerId",type:"string",defaultValue:"0"},{name:"encrMasterCustomerId",type:"string"},{name:"encrSubCustomerId",type:"string"},{name:"displayName",type:"string"},{name:"preferredCurrency",type:"string"},{name:"cCType",type:"string"},{name:"cCNumber",type:"string"},{name:"entryReference",type:"string"},{name:"organizationId",type:"string",defaultValue:"NASE"},{name:"organizationUnitId",type:"string",defaultValue:"NASE"},{name:"userKey",type:"string"}],associations:[{type:"hasMany",model:"Personify.model.base.user.Address",storeName:"UserAddress",name:"ProfileAddresses",associationKey:"ProfileAddresses",reader:{type:"json",rootProperty:"ProfileAddresses",record:"MobileProfileAddresses"}},{type:"hasMany",model:"Personify.model.base.user.Role",storeName:"UserRole",name:"ProfileRoles",associationKey:"ProfileRoles",reader:{type:"json",rootProperty:"ProfileRoles",record:"MobileNameValues"}},{type:"hasMany",model:"Personify.model.base.user.Email",storeName:"UserEmail",name:"ProfileEmails",associationKey:"ProfileEmails",reader:{type:"json",rootProperty:"ProfileEmails",record:"MobileNameValues"}},{type:"hasMany",model:"Personify.model.base.user.Name",storeName:"UserName",name:"ProfileName",associationKey:"ProfileName",reader:{type:"json",rootProperty:"ProfileName",record:"MobileProfileName"}}],userName:null,password:null,profileUrl:null,shoppingCartUrl:null},isLogged:function(){return this.getId()!=this.id},get:function(b){if(b==="organizationId"){if(this.isLogged()){return this.callParent(arguments)}else{var a=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);return a.get("orgId")}}else{if(b==="organizationUnitId"){if(this.isLogged()){return this.callParent(arguments)}else{var a=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);return a.get("orgUnitId")}}else{return this.callParent(arguments)}}},modulesConfigurationLoad:function(e,g,i){var d=this,f=Ext.getStore("moduleConfiguration");var a=Personify.utils.Configuration.getConfiguration().getAt(0).HomeStore.get("modulesUrl");if(!e){e="tablet"}var c="moduleconfiguration."+e;var h=function(k){if(!k||k==""){b(null);return}var j=Ext.JSON.decode(k);f.setConfig({data:j,proxy:{type:"memory",reader:{type:"json",rootProperty:c}}});d.onLoadModule(f,g,i)};var b=function(j){alert("error");f.getProxy().setUrl(a);f.getProxy().setReader({type:"json",rootProperty:c});d.onLoadModule(f,g,i)};if(window.plugins.app47){window.plugins.app47.getFileValue("HomeModule","modules-url",h,b)}else{b(null)}return f},onLoadModule:function(d,c,a){var b=this;if(!b.isLogged()){d.clearFilter();d.filter([{property:"notLogged",value:true}])}else{d.clearFilter();d.filter([{property:"logged",value:true}])}if(typeof c=="function"){c.call(a,d)}},getProfileDisplayOptionStore:function(){var b=this;var c=Personify.utils.ServiceManager.getStoreManager();var a=c.getProfileDisplayOptionStore();storeProfileDisplayOption=Ext.create(a);data=null;if(b.internalId!=b.id){data=[{name:"Contact Information",view:"Personify.view.profile.ContactInfoManagement",cls:""},{name:"Purchase History",view:"Personify.view.profile.PurchaseHistory",cls:""},{name:"Participation History",view:"Personify.view.profile.ParticipationHistory",cls:""},{name:"Connect Twitter",view:"Personify.view.profile.ConnectTwitter",cls:""}]}storeProfileDisplayOption.setData(data);return storeProfileDisplayOption},isStaffMember:function(){var d=this,b=false,e=d.userRole;if(e){for(var c=0;c<e.getCount();c++){var a=e.getAt(c);if(a.get("id")=="STAFF"){b=a.get("value");break}}}return b},isMember:function(){var c=this,e=false,d=c.userRole;if(d){for(var b=0;b<d.getCount();b++){var a=d.getAt(b);if(a.get("id")=="MEMBER"){e=a.get("value");break}}}return e},isExpiredMember:function(){if(this.isLogged()&&!this.isMember()){return true}else{return false}},getEventMonthStore:function(m){var b=new Date(),h=Ext.Date.format(b,"m"),l=Personify.utils.ItemUtil.getYearEventView(b),k={},e={};m.sort({sorterFn:function(r,q){var t=Personify.utils.ItemUtil.convertStringToDate(r.get("startDateTimeString"));var s=Personify.utils.ItemUtil.convertStringToDate(q.get("startDateTimeString"));var x=Ext.Date.format(t,"U");var v=Ext.Date.format(s,"U");var w=parseInt(Ext.Date.format(t,"g:i"),10);var u=parseInt(Ext.Date.format(s,"g:i"),10);var i=r.get("shortName");var y=q.get("shortName");return x>v?1:(x==v?(w>u?1:(w==u?(i>y?1:(i==y?0:-1)):-1)):-1)},direction:"ASC"});m.each(function(q){var i=Personify.utils.ItemUtil.convertStringToDate(q.get("startDateTimeString"));var r=i.getFullYear();var t=i.getMonth();var s=Ext.Date.format(i,"m");if(k[t+"-"+r]){k[t+"-"+r].push(q)}else{k[t+"-"+r]=[q];if(l<r||(l==r&&h<=s)){e[t+"-"+r]={isFuture:true,month:t,year:r}}else{e[t+"-"+r]={isFuture:false,month:t,year:r}}}});var a=Personify.utils.ServiceManager.getStoreManager();var n=Personify.utils.ServiceManager.getModelManager();var p=n.getEventMonth();var f=Ext.create(a.getEventMonthStore());for(var g=0,d=Object.keys(k).length,c=Object.keys(k);g<d;g++){var j=e[c[g]];var o=Ext.create(p,{expanded:j.isFuture,month:j.month,year:j.year,events:k[c[g]]});f.add(o)}return f},getScheduleMonthStore:function(o){var b=new Date(),h=Ext.Date.format(b,"m"),l=Personify.utils.ItemUtil.getYearEventView(b),k={},e={};o.sort({sorterFn:function(s,r){var i=s.get("startDateTime");var v=r.get("startDateTime");var u=Ext.Date.format(i,"U");var t=Ext.Date.format(v,"U");return u>t?1:(u==t?0:-1)},direction:"ASC"});var n=Ext.getStore("meetingListtingMain");o.each(function(s){var r=Personify.utils.ItemUtil.convertStringToDate(s.get("startDateTimeString"));var v=r.getFullYear();var x=r.getMonth();var w=Ext.Date.format(r,"m");if(k[x+"-"+v]){k[x+"-"+v].push(s)}else{k[x+"-"+v]=[s];if(l<v||(l==v&&h<=w)){e[x+"-"+v]={isFuture:true,month:x,year:v}}else{e[x+"-"+v]={isFuture:false,month:x,year:v}}}if(n){for(var t=0;t<n.getCount();t++){var u=n.getAt(t);if(s.get("meetingId")==u.get("productID")){s.eventData=u;break}}}});var a=Personify.utils.ServiceManager.getStoreManager();var m=Personify.utils.ServiceManager.getModelManager();var q=m.getEventMonth();var f=Ext.create(a.getEventMonthStore());for(var g=0,d=Object.keys(k).length,c=Object.keys(k);g<d;g++){var j=e[c[g]];var p=Ext.create(q,{expanded:j.isFuture,month:j.month,year:j.year,events:k[c[g]]});f.add(p)}return f},loadProfileUrl:function(){var a=Ext.create("Deft.promise.Deferred");if(this.getProfileUrl()){a.resolve(this.getProfileUrl())}else{var c=this;var e=Personify.utils.ServiceManager.getStoreManager();var b=Ext.create(e.getProfileAuthenticationUrl());var d={MasterCustomerId:this.get("masterCustomerId"),SubCustomerId:this.get("subCustomerId"),UserName:this.getUserName(),Password:this.getPassword(),PageKey:"ProfileURL",InputURL:""};b.setDataRequest(d);b.load({callback:function(g,f,h){if(h&&g.length>0){c.setProfileUrl(g[0].get("outputUrl"));a.resolve(c.getProfileUrl())}else{a.reject()}}})}return a.promise},loadShoppingCartUrl:function(){var a=Ext.create("Deft.promise.Deferred");if(this.getShoppingCartUrl()){a.resolve(this.getShoppingCartUrl())}else{var d=this;var e=Personify.utils.ServiceManager.getStoreManager();var b=Ext.create(e.getProfileAuthenticationUrl());var c={MasterCustomerId:this.get("masterCustomerId"),SubCustomerId:this.get("subCustomerId"),UserName:this.getUserName(),Password:this.getPassword(),PageKey:"ShoppingCartURL",InputURL:""};b.setDataRequest(c);b.load({callback:function(g,f,h){if(h&&g.length>0){d.setShoppingCartUrl(g[0].get("outputUrl"));a.resolve(d.getShoppingCartUrl())}else{a.reject()}}})}return a.promise},confirmEventOrder:function(b,a){return this.confirmOrder(b.get("productId"),1,"","",a)},confirmProductOrder:function(c,d,a,b){return this.confirmOrder(c.get("productID"),d,a.get("addressesId"),a.get("type"),b)},confirmOrder:function(g,b,f,e,h){var i=Ext.create("Deft.promise.Deferred");var a=Personify.utils.ServiceManager.getStoreManager();var c=null;if(h){c=Ext.create(a.getOrderTrue())}else{c=Ext.create(a.getOrderFalse())}var d={MasterCustomerID:this.get("masterCustomerId"),SubCustomerID:this.get("subCustomerId"),OrgID:this.get("organizationId")?this.get("organizationId"):config.get("orgId"),OrgUnitID:this.get("organizationUnitId")?this.get("organizationUnitId"):config.get("orgUnitId"),CusAddressID:f,CusAddressType:e,ProductID:g,Quantity:b,CustomPrice:"",ConfirmOrder:h};c.setDataRequest(d);c.load({callback:function(k,j,l){if(l&&k.length){c.each(function(m){var n=m.get("baseAmount");m.set("baseAmount",n*b)});i.resolve(c)}else{i.reject()}}});return i.promise},addToMySchedule:function(j,l,d,g,k,i,a,e,f){var h=this;var m=Ext.create("Deft.promise.Deferred");var b=Personify.utils.ServiceManager.getStoreManager();var c=Ext.create(b.getCustomerMeetingAgenda());a=a||0;e=e||0;f=f||0;c.load({callback:function(o,n,r){if(r&&o.length>0){var s=o[0];var q={EntityGUID:s.get("entityGUID"),AppointmentId:s.get("appointmentId"),OrganizationId:s.get("organizationId"),OrganizationUnitId:s.get("organizationUnitId"),MasterCustomerId:h.get("masterCustomerId"),SubCustomerId:h.get("subCustomerId"),AddedBy:s.get("addedBy"),AddedOn:s.get("addedOn"),AppointmentDescription:l,AppointmentEndDateTime:g,AppointmentStartDateTime:d,AppointmentTitle:j,AppointmentTypeCodeString:i,AvailableToOrders:s.get("availableToOrders"),ChangedBy:s.get("changedBy"),ChangedOn:Ext.Date.format(new Date(),"c"),ConcurrencyId:s.get("concurrencyId"),MeetingProductId:a,SessionFee:f,sessionLocation:k,SessionProductId:e};var p=Ext.create(b.getSaveCustomerMeetingAgenda());p.setDataRequest(q);p.load({callback:function(u,t,v){if(v&&u.length>0){m.resolve(u[0])}else{m.reject()}}})}else{m.reject()}}});return m.promise},addPersonalEvent:function(f,d,a,e,b,c){return this.addToMySchedule(f,d,a,e,b,"Personal",c)},addEventToSchedule:function(f){var h=f.get("shortName");var e=f.get("shortDescription");var a=f.get("startDateTime");var g=f.get("endDateTime");var b=f.get("location");var c=f.get("productID");var d=f.get("price");return this.addToMySchedule(h,e,a,g,b,"Meeting",c,null,d)},addSessionToSchedule:function(f,a){var g=f.get("title");var i=f.get("description");var b=f.get("startDateTime");var e=f.get("endDateTime");var h=f.get("location");var c=f.get("sessionID");var d=f.get("price");return this.addToMySchedule(g,i,b,e,h,"Meeting",a,c,d)}});