Ext.define("Personify.controller.event.complexevent.ComplexEvent",{extend:"Personify.base.Controller",config:{countLoad:0,maxCountLoad:1,defaultView:"sessionsAndDetail",fromSchedule:false,curSchedule:null,fromMain:false},control:{twitterPanel:true,menuPanel:{onMenuItemTapped:"onEventMenuItemSelected"},complexEventScheduleContent:{gotoAttendeeProfile:"gotoAttendeeProfile",addsessiontoagenda:"addNewCustomerMeetingAgenda",deletesession:"getObjectDelectMeetingAgenda",refreshmyschedule:"refreshDataAgenda",openaddpersonal:"onAddPersonalTap"},registeredText:{},backToEventButton:{tap:"onBackToEventTap"}},init:function(){var a=this.getView().getRecord();if(a){this.getAllDataOfChild(a)}},initView:function(){var c=this.getView().getRecord();if(this.getView().getFromMain()){this.setFromMain(this.getView().getFromMain())}if(c.MeetingAgendaStore){c.MeetingAgendaStore.each(function(d){for(var e=c.SessionStore.getCount()-1;e>=0;e--){var f=c.SessionStore.getAt(e);if(d.get("sessionID")==f.get("sessionID")){f.set("appointmentId",d.get("appointmentId"));break}}})}this.getTwitterPanel().updateRecord(c);if(c.get("registered")){this.getRegisteredText().show()}else{this.getRegisteredText().hide()}this.onloadMenu(c,c.get("registered"));Ext.Viewport.setMasked(false);var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){if(!c.MeetingRegistrantStore){this.onGetMeetingRegistrantData(c,a)}}if(!c.ExhibitorStore){this.onGetExhibitorData(c,a)}var b=this.getComplexEventScheduleContent().getActiveItem();if(b.getItemId()=="sessionsAndDetail"){b.getController().setRecord(c,c)}},getAllDataOfChild:function(c,b){if(b){this.setDefaultView(b)}this.setFromSchedule(false);var a=Personify.utils.Configuration.getCurrentUser();var d=1;if(a&&a.isLogged()){if(c.get("registered")){d=2}else{d=3}}this.setMaxCountLoad(d);this.setCountLoad(0);if(c.SessionStore){this.removeMask()}else{this.onGetSesstionListData(c,a)}if(a&&a.isLogged()){this.onGetMeetingAgendaData(c,a);if(!c.get("registered")){this.onGetIsUserRegistered(c,a)}}},getAllDataOfChildAndGoToSession:function(d,c,b){var f=this;if(c){this.setDefaultView(c)}this.setFromSchedule(true);this.setCurSchedule(b);var a=Personify.utils.Configuration.getCurrentUser();var e=1;if(a&&a.isLogged()){if(d.get("registered")){e=2}else{e=3}}this.setMaxCountLoad(e);this.setCountLoad(0);if(d.SessionStore){if(b.get("sessionID")){var g=d.SessionStore;g.each(function(h){if(h.get("sessionID")&&h.get("sessionID")==b.get("sessionID")){f.setCurSchedule(h)}})}f.removeMask()}else{this.onGetSesstionListData(d,a,b)}if(a&&a.isLogged()){this.onGetMeetingAgendaData(d,a);if(!d.get("registered")){this.onGetIsUserRegistered(d,a)}}},removeMask:function(){var a=this.getMaxCountLoad();this.setCountLoad(this.getCountLoad()+1);if(this.getCountLoad()==a){this.initView()}},onGetSesstionListData:function(c,a,e){var g=this;var d={MeetingID:c.get("productID"),IsStaffMember:a?a.isStaffMember().toString():false,IsMember:a?a.isMember().toString():false,ItemsPerPage:"100000",StartIndex:"0",MasterCustomerID:a?a.get("masterCustomerId"):"",SubCustomerID:a?a.get("subCustomerId"):"0"};var h=Personify.utils.ServiceManager.getStoreManager();var b=h.getSessionStore();var f=Ext.create(b);f.setDataRequest(d);c.SessionStore=f;f.load({scope:g,callback:function(){if(e){if(e.get("sessionID")){f.each(function(i){if(i.get("sessionID")&&i.get("sessionID")==e.get("sessionID")){g.setCurSchedule(i)}})}}g.removeMask()}})},onGetMeetingAgendaData:function(d,b){var h=this;if(b&&b.isLogged()){var i=b.get("masterCustomerId");var g=b.get("subCustomerId");var c={SubCustomerID:g,MeetingID:d.get("productID"),MasterCustomerID:i};var a=Personify.utils.ServiceManager.getStoreManager();var f=a.getAgendaStore();var e=Ext.create(f);e.setDataRequest(c);d.MeetingAgendaStore=e;e.load({scope:h,callback:h.removeMask})}},onGetMeetingRegistrantData:function(b,a){var d=this;var c={IsStaffMember:a?a.isStaffMember().toString():false,ItemsPerPage:"10000",MasterCustomerID:a?a.get("masterCustomerId"):"",SubCustomerID:a?a.get("subCustomerId"):"",ProductID:b.get("productID"),StartIndex:"0"};var g=Personify.utils.ServiceManager.getStoreManager();var f=g.getAttendeeStore();var e=Ext.create(f);e.setDataRequest(c);b.MeetingRegistrantStore=e;e.load()},onGetExhibitorData:function(c,b){if(!c.ExhibitorStore){var e=this;var d={ItemsPerPage:"100000",XbtID:c.get("xbtProductID"),XbtParentProduct:c.get("xbtParentProduct"),StartIndex:"0",XbtProductCode:c.get("xbtProductCode")};var h=Personify.utils.ServiceManager.getStoreManager();var f=h.getExhibitorStore();var g=Ext.create(f);var a=Ext.create(f);g.setDataRequest(d);c.ExhibitorStore=g;g.load({scope:e,callback:function(j,i,k){e.getAllExhibitorFromSql(c,b,g)}})}},getAllExhibitorFromSql:function(g,d,b){var i=this;var a=Personify.utils.ServiceManager.getStoreManager();var c=a.getExhibitorStore();var f=Ext.create(c);var e=g.get("productID")||null;var j=d.get("masterCustomerId");var h=d.get("subCustomerId");Personify.utils.Sqlite.getMyExhibitor(e,j,h,function(k){if(typeof k=="object"&&k.length>0){b.each(function(m){for(var l=0;l<k.length;l++){if(k[l].exhibitorId==m.get("recordId")){if(!m.get("isAdded")){m.set("isAdded",true)}f.add(m);break}}})}g.MyExhibitorStore=f})},onGetIsUserRegistered:function(b,a){var e=this;var c={ProductID:b.get("productID"),MasterCustomerID:a?a.get("masterCustomerId"):"0",SubCustomerID:a?a.get("subCustomerId"):"0"};var f=Personify.utils.ServiceManager.getStoreManager();var d=f.getIsUserRegisterStore();isUserRegisterStore=Ext.create(d);isUserRegisterStore.setDataRequest(c);isUserRegisterStore.load({callback:function(h,g,i){if(h.length>0){b.set("registered",h[0].get("userRegistered"))}e.removeMask(b)},scope:this})},onloadMenu:function(d,a){var g=this;var c=this.getMenuPanel();var b=Personify.utils.Configuration.getCurrentUser();var h=b?b.isStaffMember():false;var e=Ext.create("Personify.store.base.EventMenu");var i=[];if(d){var f={type:"ajax",url:"data/ComplexEventMenu.json",reader:{type:"json",rootProperty:"menu"}};e.setProxy(f);e.load({callback:function(l,o,v){var n=g.getMenu(l,"Sessions");if(n!=null){i.push(n)}if(a||h){var r=g.getMenu(l,"Attendees");if(r!=null){i.push(r)}}var j=g.getMenu(l,"Exhibitors");if(j!=null){i.push(j)}var u=g.getMenu(l,"Map");if(u!=null){i.push(u)}if(d.get("badgeData")!=""){var q=g.getMenu(l,"Badge");if(q!=null){i.push(q)}}var m=g.getMenu(l,"Notes");if(m!=null){i.push(m)}var j=g.getMenu(l,"Presenters");if(j){i.push(j)}var p=g.getMenu(l,"Discussions");if(p!=null){i.push(p)}var j=g.getMenu(l,"Materials");if(j!=null){i.push(j)}var k=g.getMenu(l,"Event Description");if(k!=null){i.push(k)}e.setData(i);c.getController().setStore(e);g.setDefaultView("sessionsAndDetail");c.getController().getEventMenuList().select(0);if(e.first()){g.onEventMenuItemSelected(e.first())}var s=g.getComplexEventScheduleContent();var t=s.getActiveItem();t.setMasked({xtype:"loadmask"});Ext.callback(function(){if(t.getController()["setRecord"]){t.getController().setRecord(d,d)}if(g.getFromSchedule()){if(g.getCurSchedule()){s.getActiveItem().getController().onOpenDetailPage(this.getCurSchedule())}}t.setMasked(false)},g,[],1)},scope:this})}},getMenu:function(c,a){for(var b=0;b<c.length;b++){if(c[b].get("name")==a){return c[b]}}return null},onEventMenuItemSelected:function(c){var f=this.getView().getRecord();var e=this;var d={xtype:c.get("view"),itemId:c.get("view"),record:f,meetingRecord:f};var a=e.getComplexEventScheduleContent();var b=this.getComplexEventScheduleContent().getActiveItem();if(c.get("view")=="notepanel"||c.get("view")=="mapevent"){d={xtype:c.get("view"),itemId:c.get("view"),record:f,meetingRecord:f}}if(typeof b==="object"){if(b.getItemId()=="sessionsAndDetail"&&c.get("view")=="sessionsAndDetail"){b.getController().onOpenSessionPage()}else{if(b.getItemId()=="exhibitorAndDetail"&&c.get("view")=="exhibitorAndDetail"){b.getController().onOpenExhibitorPage()}else{if(b.getItemId()===c.get("view")){b.setActiveItem(0)}else{this.setDefaultView(c.get("view"));a.removeAll(true,true);a.add(d)}}}}else{this.setDefaultView(c.get("view"));a.removeAll(true,true);a.add(d);if(this.getFromSchedule()){if(this.getCurSchedule()){a.getActiveItem().getController().onOpenDetailPage(this.getCurSchedule())}}}},gotoAttendeeProfile:function(b){var d=this;var c={xtype:"attendees",record:b};var a=d.getComplexEventScheduleContent();a.removeAll(true,true);a.add(c)},refreshData:function(e){var c=this.getView().getRecord();var a=Personify.utils.Configuration.getCurrentUser();if(Ext.Viewport.getOrientation()=="landscape"){var b={xtype:"loadmask",message:"Loading..",fullscreen:true,centered:true,cls:"p-loading-ipad-landscape"}}else{var b={xtype:"loadmask",message:"Loading..",fullscreen:true,centered:true,cls:"p-loading-ipad-portrait"}}if(c){Ext.Viewport.setMasked(b);var d=Ext.getStore("agendaStoreListMain");if(d){for(var f=0;f<d.getCount();f++){var g=d.getAt(f);if(g.get("type")!="PERSONAL"){if(!g.get("sessionID")||g.get("sessionID")==""||g.get("sessionID")=="0"){if(g.get("meetingId")==c.get("productID")){if(!c.get("appointmentId")||c.get("appointmentId")==""){c.set("appointmentId",g.get("appointmentId"))}if(!c.get("isAdded")){c.set("isAdded",true)}break}}}}}this.setCountLoad(0);this.setMaxCountLoad(2);this.onGetIsUserRegistered(c,a);this.onGetMeetingAgendaData(c,a);this.onGetMeetingRegistrantData(c,a)}this.removeAllChild()},onBackToEventTap:function(){if(Personify.utils.Configuration.getAllowChangeView()){var a=this;a.getView().setMasked({xtype:"loadmask"});Ext.callback(function(){a.getView().setMasked(false);if(a.getFromMain()){a.getView().fireEvent("requestchangeview","Personify.view.EventAndEventDetail",null,"Events","eventmenuitem")}else{a.getView().fireEvent("backtoevent")}},a,[],500)}else{Ext.Msg.alert("","Please enter the note title.",Ext.emptyFn)}},setBackToEventButtonText:function(a){if(a){this.getBackToEventButton().setText(a)}},addNewCustomerMeetingAgenda:function(c,b,d){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}Ext.Viewport.setMasked({xtype:"loadmask"});var f=this;var a=Personify.utils.Configuration.getCurrentUser();var e=this.getView().getRecord();var g=c.get("sessionID");if(g){a.addSessionToSchedule(c,e.get("productID")).then({success:function(h){f.addToMyScheduleDone(c,h,b)},failure:function(){Ext.Msg.alert("","Error occurred while adding agenda.")}}).always(function(){Ext.Viewport.setMasked(false)})}else{a.addEventToSchedule(c).then({success:function(h){f.addToMyScheduleDone(c,h,b,true)},failure:function(){Ext.Msg.alert("","Error occurred while adding agenda.")}}).always(function(){Ext.Viewport.setMasked(false)})}},addToMyScheduleDone:function(b,d,a,c){if(!b.get("isAdded")){b.set("isAdded",true)}if(d){b.set("appointmentId",d.get("appointmentId"))}if(a!=null){a.getController().setRecord(b)}this.refreshDataAgenda(d.get("appointmentId"),true);if(c){Ext.Msg.alert("","Meeting has been added to your schedule.")}else{Ext.Msg.alert("","Session has been added.")}},getObjectDelectMeetingAgenda:function(d,i,g,e){Ext.Viewport.setMasked({xtype:"loadmask"});var b=this.getView().getRecord();var h=this;var f={type:"ajax",method:"GET",url:Personify.utils.ServiceManager.getUrlWS("eventGetDeleteMeetingAgenda")+d.get("appointmentId"),headers:Personify.utils.ServiceManager.getHeaders(),reader:{type:"json",rootProperty:"d"}};var a=Personify.utils.ServiceManager.getStoreManager();var j=a.getObjectDeleteMeetingAgenda();var c=Ext.create(j);c.setProxy(f);c.load({callback:function(n,m,p){if(n.length>0){var k=Personify.utils.Configuration.getCurrentUser();var o=n[0];var l={EntityGUID:o.get("entityGUID"),AppointmentId:o.get("appointmentId"),OrganizationId:o.get("organizationId"),OrganizationUnitId:o.get("organizationUnitId"),MasterCustomerId:k.get("masterCustomerId"),SubCustomerId:k.get("subCustomerId"),AddedBy:o.get("addedBy"),AddedOn:Personify.utils.ItemUtil.formatDateMSMySchedule(o.get("addedOn")),AppointmentDescription:d.get("description")?d.get("description"):d.get("shortDescription"),AppointmentEndDateTime:Personify.utils.ItemUtil.formatDateTimeSession(d.get("endDateTime")),AppointmentStartDateTime:Personify.utils.ItemUtil.formatDateTimeSession(d.get("startDateTime")),AppointmentTitle:d.get("title")?d.get("title"):d.get("shortName"),AppointmentTypeCodeString:"Meeting",AvailableToOrders:o.get("availableToOrders"),ChangedBy:o.get("changedBy"),ChangedOn:Ext.Date.format(new Date(),"c"),ConcurrencyId:o.get("concurrencyId"),MeetingParentProductCode:"",MeetingProductCode:"",MeetingProductId:b.get("productID"),SessionFee:d.get("price"),sessionLocation:d.get("location"),SessionParentProductCode:"",SessionProductCode:"",SessionProductId:d.get("sessionID"),SessionTrackCode:"",SessionTypeCode:"",SpeakerName:""};h.saveDeleteMeetingAgenda(l,d,i,g,e)}else{Ext.Msg.alert("","Cannot get agenda information to delete!");Ext.Viewport.setMasked(false)}},scope:this})},saveDeleteMeetingAgenda:function(c,e,i,g,f){var h=this;var a=Personify.utils.ServiceManager.getStoreManager();var b=a.getSaveDeleteMeetingAgenda();var d=Ext.create(b);d.setDataRequest(c);d.load({callback:function(k,j,p){if(p){if(e.get("isAdded")){e.set("isAdded",false)}if(i!=null){i.getController().setRecord(e)}var o=e.get("sessionID");h.refreshDataAgenda(o,false);if(g==true){Ext.Msg.alert("","Meeting has been removed.")}else{if(e.get("sessionID").trim()!=""&&e.get("sessionID")!=0){Ext.Msg.alert("","Session has been removed.");var l=null;var n=h.getView().getRecord().MeetingAgendaStore;for(var m=0;m<n.getCount();m++){if(n.getAt(m).get("sessionID")==e.get("sessionID")){l=n.getAt(m)}}if(l){n.remove(l)}}}}else{Ext.Msg.alert("","Error occurred while deleting agenda.")}Ext.Viewport.setMasked(false);if(typeof(f)=="function"){f()}},scope:this})},refreshDataAgenda:function(e,d){var c=this.getComplexEventScheduleContent().getActiveItem();this.getView().fireEvent("updateagendalist");this.getView().getParent().fireEvent("updateagendalist");if(c.getItemId()=="sessionsAndDetail"||c.getItemId()=="mapEventSchedule"||c.getItemId()=="mapevent"){c.getController().refreshMySchedule(e,d)}else{var b=this.getView().getRecord();var a=Personify.utils.Configuration.getCurrentUser();this.onGetMeetingAgendaData(b,a)}},onAddPersonalTap:function(b){var c=this;if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Event Add To Calendar")}var a=Ext.Viewport.add([{xtype:"addevent",record:b,listeners:{refreshagenda:function(){c.refreshDataAgenda()}}}]);a.getController().getAddEventTitle().setHtml("Add Personal Session to Schedule");a.getController().getAddPersonalEventButton().setText("Add Personal Session");a.show()},removeAllChild:function(){var a=this.getComplexEventScheduleContent();a.removeAll(true,true);var b={xtype:"sessionsAndDetail",itemId:"sessionsAndDetail"};a.add(b)}});