Ext.define("Personify.controller.event.simpleEvent.SimpleEvent",{extend:"Personify.base.Controller",inject:["shoppingCartStore"],config:{countLoad:0,defaultView:"simpleeventcontent",shoppingCartStore:null,fromMain:false},control:{addToCartButton:{tap:"onAddToCartButtonTap"},simpleEventContent:{gotoAttendeeProfile:"gotoAttendeeProfile",refreshmyschedule:"refreshMySchedule",buttonmapittap:"onButtonMapitTap",deletesession:"getObjectDelectMeetingAgenda"},eventMenu:{onMenuItemTapped:"onMenuItemTap"},twitterPanel:true,registerButton:{tap:"onTapRegisterButton"},registeredText:true,backToEventButton:{tap:"onBackToEventTap"},view:{painted:"onPainted"}},init:function(){this.initView()},onPainted:function(){Ext.Viewport.setMasked(false)},initView:function(){var a=this.getView().getRecord();if(this.getView().getFromMain()){this.setFromMain(this.getView().getFromMain())}if(a){this.getTwitterPanel().updateRecord(a);this.onHideRegisterButton(a);this.onLoadMenu(a)}},onGetIsUserRegistered:function(b,a){var e=this;var c={ProductID:b.get("productID"),MasterCustomerID:a?a.get("masterCustomerId"):"0",SubCustomerID:a?a.get("subCustomerId"):"0"};var f=Personify.utils.ServiceManager.getStoreManager();var d=f.getIsUserRegisterStore();isUserRegisterStore=Ext.create(d);isUserRegisterStore.setDataRequest(c);e.getView().setMasked({xtype:"loadmask"});isUserRegisterStore.load({callback:function(h,g,i){e.getView().setMasked(false);if(h.length>0){b.set("registered",h[0].get("userRegistered"))}e.initView(b)},scope:this})},onMenuItemTap:function(b){var e=this.getView().getRecord();var d=this,c={xtype:b.get("view"),record:e,meetingRecord:e},a=d.getSimpleEventContent();this.setDefaultView(b.get("view"));a.removeAll();a.add(c)},onButtonMapitTap:function(e){var h=this;var c=Personify.utils.Configuration.getCurrentUser();if(c&&c.isLogged()){var i=c.get("masterCustomerId");var g=c.get("subCustomerId");var a=Personify.utils.ServiceManager.getStoreManager();var f=a.getAgendaStore();var d={SubCustomerID:g,MeetingID:e.get("productID"),MasterCustomerID:i};var b=Ext.create(f);b.setDataRequest(d);b.load({callback:function(l,k,n){e.MeetingAgendaStore=b;var m={xtype:"mapevent",record:e,meetingRecord:e};var j=h.getSimpleEventContent();j.removeAll(true,true);j.add(m)},scope:this})}},onAddToCartButtonTap:function(){var l=this;var b=Personify.utils.Configuration.getCurrentUser();if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(l.getView().getRecord().get("membersOnly")){if(b.isExpiredMember()){Ext.Msg.alert("","For Members Only.",Ext.emptyFn);return}}if(b&&b.isLogged()){var c=l.getView().getRecord().get("productID");var m=b.get("masterCustomerId");var g=b.get("subCustomerId");var a=Personify.utils.ServiceManager.getStoreManager(),h=a.getAddCartStore();var k=l.getView().getRecord();var j=k.get("yourPriceRateStructure")?k.get("yourPriceRateStructure"):"LIST";var f=k.get("yourPriceRateCode")?k.get("yourPriceRateCode"):"STD";var e=k.get("yourPrice");var i={InternalKey:null,NavigationKey:null,MasterCustomerId:m,SubCustomerId:g,ProductId:c,Qty:1,CartSessionId:null,IsAutoRenew:null,UserDefinedField1:null,UserDefinedField2:null,UserDefinedField3:null,MarketCode:null,OrderNo:null,OrderLineNo:null,Price:e,RateCode:f,RateStructure:j,ShipMasterCustomerId:m,ShipSubCustomerId:g,DoNotAutoAddComponents:null};var d=Ext.create(h);d.setDataRequest(i);l.getView().setMasked({xtype:"loadmask"});d.load({callback:function(p,o,t){l.getView().setMasked(false);if(t){var q=d.getAt(0).getData().cartItemId;if(q==-1){Ext.Msg.alert("Fail","Add to shopping cart unsuccessfully.")}else{if(b.get("masterCustomerId")==null){m="";g=""}var r=l.getShoppingCartStore();var s={MasterCustomerId:m,SubCustomerId:g};r.setDataRequest(s);r.load();Deft.Injector.configure({shoppingCartStore:{value:r}});var n=Ext.create("Personify.view.store.ConfirmAddToCart");Ext.Viewport.add(n);n.show()}}},scope:this})}else{Personify.utils.ItemUtil.needToLogin()}},onLoadMenu:function(c){var e=this;var b=this.getEventMenu();b.setMasked({xtype:"loadmask"});var g=Ext.create("Personify.store.base.EventMenu");var d={type:"ajax",url:"data/SimpleEventMenu.json",reader:{type:"json",rootProperty:"menu"}};var a=Personify.utils.Configuration.getCurrentUser();var f=[];if(c){g.setProxy(d);g.load({callback:function(j,l,p){b.setMasked(false);Ext.Viewport.setMasked(false);var o=e.getMenu(j,"Event Info");if(o!=null){f.push(o)}if(c.SpeakersListEvent.getCount()>0){var h=e.getMenu(j,"Presenters");if(h!=null){f.push(h)}}var n=e.getMenu(j,"Conversation");if(n!=null){f.push(n)}var k=e.getMenu(j,"Notes");if(k!=null){f.push(k)}if(c.MaterialStore.getCount()>0){var h=e.getMenu(j,"Materials");if(h!=null){f.push(h)}}if(c.get("badgeData")!=""){var m=e.getMenu(j,"Badge");if(m!=null){f.push(m)}}if(a&&a.isLogged()){var i=e.getMenu(j,"Rate");if(i!=null){f.push(i)}}g.setData(f);b.getController().setStore(g);b.getController().setSelectedMenu(0)},scope:this})}},getMenu:function(c,a){for(var b=0;b<c.length;b++){if(c[b].get("name")==a){return c[b]}}return null},gotoAttendeeProfile:function(b){var d=this;var c={xtype:"attendees",record:b};var a=d.getSimpleEventContent();a.setMasked({xtype:"loadmask"});a.removeAll(true,true);a.add(c);a.setMasked(false)},refreshData:function(c){var a=this.getView().getRecord();if(a){var b=Ext.getStore("agendaStoreListMain");if(b){for(var d=0;d<b.getCount();d++){var e=b.getAt(d);if(e.get("type")!="PERSONAL"){if(!e.get("sessionID")||e.get("sessionID")==""||e.get("sessionID")=="0"){if(e.get("meetingId")==a.get("productID")){if(!a.get("appointmentId")||a.get("appointmentId")==""){a.set("appointmentId",e.get("appointmentId"))}if(!a.get("isAdded")){a.set("isAdded",true)}break}}}}}this.onGetIsUserRegistered(a,c)}},onHideRegisterButton:function(){this.getRegisteredText().hide();this.getRegisterButton().hide();this.getAddToCartButton().hide();var c=this.getView().getRecord(),a=Personify.utils.Configuration.getCurrentUser(),b=new Date(),d=Personify.utils.ItemUtil.convertStringToDate(c.get("endDateTimeString"));if(b>d||c.get("registered")||c.get("meetingTag")=="Sold Out"||c.get("meetingTag")=="Cancelled"){if(c.get("registered")){this.getRegisteredText().show()}}else{var e=Personify.utils.Configuration.getConfiguration().getAt(0).EventsStore.get("mobileRegistration");if(e){this.getAddToCartButton().show();if(a&&a.get("cCType")&&a.get("cCNumber")&&a.get("cCType")!=""&&a.get("cCNumber")!=""){this.getRegisterButton().show()}}}},onBackToEventTap:function(){var a=this;a.getView().setMasked({xtype:"loadmask"});Ext.callback(function(){a.getView().setMasked(false);if(a.getFromMain()){a.getView().fireEvent("requestchangeview","Personify.view.EventAndEventDetail",null,"Events","eventmenuitem")}else{a.getView().fireEvent("backtoevent")}},a,[],500)},onTapRegisterButton:function(){var d=this;var b=d.getView().getRecord();var a=Personify.utils.Configuration.getCurrentUser();if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(b.get("membersOnly")){if(a.isExpiredMember()){Ext.Msg.alert("","For Members Only.",Ext.emptyFn);return}}if(a&&a.isLogged()){if(b.get("meetingTag")=="Wait List"){Ext.Msg.show({title:"",message:"Event Capacity Reached. Do you want to be placed on the wait list?",buttons:[{itemId:"cancel",text:"Cancel",ui:"action"},{itemId:"ok",text:"Buy now",ui:"action"}],fn:c,animEl:"elId"});function c(e){Ext.Msg.hide();if(e=="ok"){d.sendRequestRegister(b,a)}}}else{if(b.get("meetingTag")=="Sold Out"){Ext.Msg.alert("","Event and Wait list capacity reached.  Thank you for your interest.",Ext.emptyFn)}else{d.sendRequestRegister(b,a)}}}else{Personify.utils.ItemUtil.needToLogin()}},sendRequestRegister:function(b,a){var e=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);var f=this;var g=Personify.utils.ServiceManager.getStoreManager();f.getView().setMasked({xtype:"loadmask"});var d=Ext.create(g.getOrderFalse());var c={CusAddressID:"",CusAddressType:"",MasterCustomerID:a.get("masterCustomerId"),SubCustomerID:a.get("subCustomerId"),ProductID:b.get("productID"),OrgID:a?a.get("organizationId"):e.get("orgId"),OrgUnitID:a?a.get("organizationUnitId"):e.get("orgUnitId"),CustomPrice:"",ConfirmOrder:"false",Quantity:1};d.setDataRequest(c);d.load({callback:function(k,j,l){f.getView().setMasked(false);if(l){var i=a.isStaffMember();var h={MasterCustomerId:a.get("masterCustomerId"),SubCustomerId:a.get("subCustomerId"),ReqMasterCustomerId:a.get("masterCustomerId"),ReqSubCustomerId:a.get("subCustomerId"),IsStaff:i,RecordType:""};f.getView().setMasked({xtype:"loadmask"});f.loadProfileStore(h,b,d)}else{Ext.Msg.alert("Shopping Cart","Cannot process order at this time.",Ext.emptyFn)}}})},loadProfileStore:function(d,a,c){var e=this;var f=Personify.utils.ServiceManager.getStoreManager();var b=Ext.create(f.getProfileStore());b.setDataRequest(d);b.load({callback:function(u,p,n){e.getView().setMasked(false);var r=[];var y=Ext.create("Personify.base.Store",{model:"Personify.model.jsonp.profile.Addresses"});if(n){if(u[0]){var x=u[0];if(x.EntryProfile.getAt(0)){var w=x.EntryProfile.getAt(0);var k=w.AddressesProfile.getCount();for(var v=0;v<k;v++){var l=w.AddressesProfile.getAt(v);var s=l.get("streetAddress"),m=l.get("locality"),h=l.get("region"),o=l.get("postalCode"),t=l.get("country"),g=l.get("addressesId"),j=l.get("type");r.push({streetAddress:s,locality:m,region:h,postalCode:o,country:t,addressesId:g,type:j})}y.add(r)}}}var q=Ext.create("Personify.view.store.OrderPanel");q.getController().setProduct(a);q.getController().setIsProductEvent(true);q.getController().getOrderTemplate().setStore(c);q.getController().getShippingAddress().setStore(y);if(y.getCount()>0){q.getController().getShippingAddress().select(0)}Ext.Viewport.add(q);q.show();q.getController().setCallback({fn:e.onRegisteredSuccess,scope:e})}})},onRegisteredSuccess:function(){var b=this;if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Event List")}var a=b.getView().getParent();b.getView().fireEvent("updatemeetinglist");if(a){a.fireEvent("updatemeetinglist")}Ext.callback(function(){b.getView().fireEvent("backtoevent")},b,[],1)},setBackToEventButtonText:function(a){if(a){this.getBackToEventButton().setText(a)}},refreshMySchedule:function(){this.getView().fireEvent("refreshmyschedule");this.getView().getParent().fireEvent("updateagendalist")},getObjectDelectMeetingAgenda:function(c,b){Ext.Viewport.setMasked({xtype:"loadmask"});var f=this.getView().getRecord();var g=this;var e={type:"ajax",method:"GET",url:Personify.utils.ServiceManager.getUrlWS("eventGetDeleteMeetingAgenda")+c.get("appointmentId"),headers:Personify.utils.ServiceManager.getHeaders(),reader:{type:"json",rootProperty:"d"}};var h=Personify.utils.ServiceManager.getStoreManager();var d=h.getObjectDeleteMeetingAgenda();var a=Ext.create(d);a.setProxy(e);a.load({callback:function(l,k,n){if(l.length>0){var i=Personify.utils.Configuration.getCurrentUser();var m=l[0];var j={EntityGUID:m.get("entityGUID"),AppointmentId:m.get("appointmentId"),OrganizationId:m.get("organizationId"),OrganizationUnitId:m.get("organizationUnitId"),MasterCustomerId:i.get("masterCustomerId"),SubCustomerId:i.get("subCustomerId"),AddedBy:m.get("addedBy"),AddedOn:Personify.utils.ItemUtil.formatDateMSMySchedule(m.get("addedOn")),AppointmentDescription:c.get("shortDescription"),AppointmentEndDateTime:Personify.utils.ItemUtil.formatDateTimeSession(c.get("endDateTime")),AppointmentStartDateTime:Personify.utils.ItemUtil.formatDateTimeSession(c.get("startDateTime")),AppointmentTitle:c.get("shortName"),AppointmentTypeCodeString:"Meeting",AvailableToOrders:m.get("availableToOrders"),ChangedBy:m.get("changedBy"),ChangedOn:Ext.Date.format(new Date(),"c"),ConcurrencyId:m.get("concurrencyId"),MeetingParentProductCode:"",MeetingProductCode:"",MeetingProductId:f.get("productID"),SessionFee:c.get("price"),sessionLocation:c.get("location"),SessionParentProductCode:"",SessionProductCode:"",SessionProductId:c.get("sessionID"),SessionTrackCode:"",SessionTypeCode:"",SpeakerName:""};g.saveDeleteMeetingAgenda(j,c,b)}else{Ext.Msg.alert("","Cannot get agenda information to delete.");Ext.Viewport.setMasked(false)}},scope:this})},saveDeleteMeetingAgenda:function(e,c,b){var g=this.getView().getRecord();var f=this;var h=Personify.utils.ServiceManager.getStoreManager();var d=h.getSaveDeleteMeetingAgenda();var a=Ext.create(d);a.setDataRequest(e);a.load({callback:function(j,i,k){if(k){if(c.get("isAdded")){c.set("isAdded",false)}if(g.get("isAdded")){g.set("isAdded",false)}if(g.MeetingAgendaStore){g.MeetingAgendaStore.each(function(l){if(l.get("appointmentId")==c.get("appointmentId")){g.MeetingAgendaStore.remove(l)}})}b.getController().setRecord(c);f.refreshMySchedule();Ext.Msg.alert("","Meeting has been removed.")}else{Ext.Msg.alert("","Error occurred while deleting agenda.")}Ext.Viewport.setMasked(false)},scope:this})}});