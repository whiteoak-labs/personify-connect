Ext.define("Personify.controller.store.OrderPanel",{extend:"Personify.base.Controller",control:{closeorderForm:{tap:"onCloseForm"},orderTemplate:{},btnCancel:{tap:"onCloseForm"},btncheckout:{tap:"onCheckOut"},shippingAddress:{itemtap:"onTapShippingAddress"}},config:{product:null,isProductEvent:null,callback:null,quantity:1},init:function(){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Product Place Order")}},onCloseForm:function(){Ext.Viewport.setMasked(false);this.getView().destroy()},onCheckOut:function(){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}var f=this;var c=Personify.utils.Configuration.getCurrentUser();var b=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);var a=Personify.utils.ServiceManager.getStoreManager();var i=Ext.create(a.getOrderTrue());var e=null;var h=f.getShippingAddress().getSelection()[0].get("addressesId");var g=f.getShippingAddress().getSelection()[0].get("type");if(f.getIsProductEvent()==true){e=f.getProduct().get("productID")}else{e=f.getProduct().get("productID")}f.getView().setMasked({xtype:"loadmask"});var d={CusAddressID:h,CusAddressType:g,MasterCustomerID:c.get("masterCustomerId"),SubCustomerID:c.get("subCustomerId"),ProductID:e,OrgID:c?c.get("organizationId"):b.get("orgId"),OrgUnitID:c?c.get("organizationUnitId"):b.get("orgUnitId"),CustomPrice:"",ConfirmOrder:"true",Quantity:f.getQuantity()};i.setDataRequest(d);i.load({callback:function(k,j,l){f.getView().setMasked(false);var m=f.getCallback();if(l){f.getView().destroy();if(f.getProduct().get("meetingTag")&&f.getProduct().get("meetingTag")=="Wait List"){if(m){Ext.Msg.alert("Shopping Cart","You have been added to wait list for this event.",function(){Ext.callback(m.fn,m.scope,m.args)})}else{Ext.Msg.alert("Shopping Cart","You have been added to wait list for this event.",Ext.emptyFn)}}else{Ext.Msg.alert("Shopping Cart","Order Placed Successfully",function(){if(m){Ext.callback(m.fn,m.scope,m.args)}f.getView().destroy()})}}else{Ext.Msg.alert("Shopping Cart","Cannot process order at this time.",function(){f.getView().destroy()})}}});Ext.Viewport.setMasked(false)},onTapShippingAddress:function(h,d,f,c,g,i){var j=this;var b=this.getQuantity();this.getView().setMasked({xtype:"loadmask"});var a=Personify.utils.Configuration.getCurrentUser();a.confirmProductOrder(this.getProduct(),b,c,false).then({success:function(e){j.getOrderTemplate().setStore(e)},failure:function(){Ext.Msg.alert("","Cannot load order information for selected address, please try again later.",Ext.emptyFn)}}).always(function(){j.getView().setMasked(false)})}});