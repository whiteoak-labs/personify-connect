Ext.define("Personify.controller.profile.Photo",{extend:"Personify.base.Controller",control:{imageFrame:{},editButton:{tap:"onEditPictureTapped"}},config:{record:null},updateRecord:function(a){var b=a.EntryProfile.getAt(0).PhotosProfile;if(b.getCount()!=0&&b.getAt(0).get("value")!=""){if(Personify.utils.Configuration.profilePictureTimestamp){this.getImageFrame().setSrc(b.getAt(0).get("value")+"?_dc="+Personify.utils.Configuration.profilePictureTimestamp)}else{this.getImageFrame().setSrc(b.getAt(0).get("value"))}}else{this.getImageFrame().setSrc("img/directory/defaultAvatar.png")}this.updateEditMode(false)},setPresenterRecord:function(a){if(a&&a.get("imageURL")&&a.get("imageURL")!=""){this.getImageFrame().setSrc(a.get("imageURL"))}else{this.getImageFrame().setSrc("img/directory/defaultAvatar.png")}},updateEditMode:function(a){if(this.getView()){if(a==true){this.getEditButton().show()}else{this.getEditButton().hide()}}},onEditPictureTapped:function(){var a=this;Ext.Viewport.setMasked({xtype:"loadmask",message:"Loading",indicator:true,centered:true,fullscreen:true});navigator.camera.getPicture(function(b){Ext.callback(a.uploadImage,a,[b])},a.onPhotoDataError,{quality:50,allowEdit:true,sourceType:navigator.camera.PictureSourceType.PHOTOLIBRARY,destinationType:navigator.camera.DestinationType.FILE_URI,encodingType:navigator.camera.EncodingType.PNG})},uploadImage:function(e){var d=this;var g=e.substr(e.lastIndexOf("/")+1);var b=new FileUploadOptions();b.fileKey="fileToUpload";b.fileName=g;b.mimeType="image/png";b.chunkedMode=false;var f=Personify.utils.ServiceManager.getHeaders();if(f.Authorization){b.headers={Authorization:f.Authorization}}var c=d.getRecord().EntryProfile.first();b.params={masterCustomerId:c.get("masterCustomerId"),subCustomerId:c.get("subCustomerId")};var a=new FileTransfer();a.upload(e,Personify.utils.ServiceManager.getUrlWS("utilFileUpload"),function(h){Ext.Viewport.setMasked(false);if(JSON.parse(h.response.toLowerCase())==false){Ext.Msg.alert("","Cannot upload image, please try again later",Ext.emptyFn)}else{Ext.Msg.alert("","Your profile picture has been updated",Ext.emptyFn);var i=d.getRecord().EntryProfile.first().PhotosProfile.first();if(i){d.getImageFrame().setSrc("img/directory/defaultAvatar.png");var j=d.getImageFrame();Personify.utils.Configuration.profilePictureTimestamp=Ext.Date.now();Ext.callback(j.setSrc,j,[i.get("value")+"?_dc="+Personify.utils.Configuration.profilePictureTimestamp],1000)}if(Ext.os.is.Android){window.plugins.androidHelper.clearHistory()}}},function(h){Ext.Msg.alert("","Cannot upload image, please try again later",Ext.emptyFn);Ext.Viewport.setMasked(false)},b)},onPhotoDataError:function(a){Ext.Viewport.setMasked(false)}});