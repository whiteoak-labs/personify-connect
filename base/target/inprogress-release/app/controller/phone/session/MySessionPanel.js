Ext.define("Personify.controller.phone.session.MySessionPanel",{extend:"Personify.base.Controller",config:{sessionDates:null,currentDate:null,dateIndex:0},control:{mySessionTitleBar:true,mySessionList:{itemtap:"onSessionItemTap"},previousButton:{tap:"onBackSegmentButton"},dateTimeLabel:true,totalEventLabel:true,sessionHeader:true,nextButton:{tap:"onNextSegmentButton"}},setRecord:function(a){var c=this;if(a){this.getMySessionTitleBar().setHtml(Personify.utils.ItemUtil.getShortContent(a.get("shortName"),48));if(a.MeetingAgendaStore&&a.SessionStore.getCount()>0){var e=Personify.utils.ServiceManager.getStoreManager();var b=e.getAgendaStore();var d=Ext.create(b);a.MeetingAgendaStore.each(function(h){for(var g=0;g<a.SessionStore.getCount();g++){var f=a.SessionStore.getAt(g);if(f.get("sessionID")==h.get("sessionID")){h.MaterialStore=f.MaterialStore;h.SpeakerSession=f.SpeakerSession;h.set("locationDescription",f.get("locationDescription"));h.set("isAdded",true);d.add(h);break}}});this.getMySessionList().setStore(d);this.getArrayDates();this.onSelectDefaultDate()}else{this.onGetData(a)}}},onGetData:function(d){this.getView().setMasked({xtype:"loadmask"});var i=this;var b=Personify.utils.Configuration.getCurrentUser();if(b&&b.isLogged()){var j=b.data.masterCustomerId;var g=b.data.subCustomerId;var c={SubCustomerID:g,MeetingID:d.get("productID"),MasterCustomerID:j};var a=Personify.utils.ServiceManager.getStoreManager();var f=a.getAgendaStore();var e=Ext.create(f);var h=Ext.create(f);h.setDataRequest(c);h.load({callback:function(l,k,m){i.getView().setMasked(false);if(m){h.each(function(p){for(var o=0;o<d.SessionStore.getCount();o++){var n=d.SessionStore.getAt(o);if(n.get("sessionID")==p.get("sessionID")){p.MaterialStore=n.MaterialStore;p.SpeakerSession=n.SpeakerSession;p.set("locationDescription",n.get("locationDescription"));p.set("isAdded",true);e.add(p);break}}});i.getMySessionList().setStore(e);d.MeetingAgendaStore=h;i.getArrayDates();i.onSelectDefaultDate()}},scope:this})}},getArrayDates:function(){var a=this.getMySessionList().getStore();if(a){var b=new Array();a.each(function(d){if(d){var c=d.get("startDateTime");if(!Personify.utils.ItemUtil.checkDateInDateArray(b,c)){b.push(c)}}});b.sort(function(d,c){return d>c?1:(d==c?0:-1)});this.setSessionDates(b)}},onSelectDefaultDate:function(){var e=this.getSessionDates();var d=new Date();var a=false;Ext.Array.each(e,function(f){var g="m/d/y";if(Ext.Date.format(f,g)==Ext.Date.format(d,g)){a=true;d=f}});if(e.length>0){this.getSessionHeader().show();if(a){this.onFilterByDate(d)}else{var c=this.getDateIndex();var b=e[c];if(b){this.onFilterByDate(b)}else{this.onBackSegmentButton()}}}else{this.getSessionHeader().hide()}this.updateShowHidebutton()},onFilterByDate:function(b){var c=this;var a=this.getMySessionList().getStore();if(a){a.clearFilter();this.setCurrentDate(b);a.filter(function(e){var d=e.get("startDateTime");var f="m/d/y";if(Ext.Date.format(d,f)==Ext.Date.format(b,f)){return e}});a.sort({sorterFn:function(e,d){var h=e.get("startDateTime");var f=d.get("startDateTime");if(h>f){return 1}else{if(h<f){return -1}else{var i=e.get("title");var g=d.get("title");return i>g?1:(i==g?0:-1)}}},direction:"ASC"})}this.getDateTimeLabel().setHtml(Ext.Date.format(b,"F d, Y"));this.getTotalEventLabel().setHtml(a.getCount()+" Events")},onBackSegmentButton:function(){var a=this.getDateIndex();var b=this.getSessionDates();if(a>0){this.setDateIndex(a-1);this.onFilterByDate(b[a-1]);this.updateShowHidebutton()}},onNextSegmentButton:function(){var a=this.getDateIndex();var b=this.getSessionDates();if(a<this.getSessionDates().length){this.setDateIndex(a+1);this.onFilterByDate(b[a+1]);this.updateShowHidebutton()}},updateShowHidebutton:function(){var a=this.getDateIndex();if(a>0){this.getPreviousButton().setDisabled(false)}else{this.getPreviousButton().setDisabled(true)}if(a+1<this.getSessionDates().length){this.getNextButton().setDisabled(false)}else{this.getNextButton().setDisabled(true)}},onSessionItemTap:function(b,c,f,a,d){this.getView().getParent().fireEvent("onsessiontap",a,true)}});