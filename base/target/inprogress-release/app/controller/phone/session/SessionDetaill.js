Ext.define("Personify.controller.phone.session.SessionDetaill",{extend:"Personify.base.Controller",config:{noteNumber:0,locationDescription:null,sessionRecords:null},control:{eventToolbar:{onNavigationButtonTap:"onBack"},titleOfEvent:true,descriptionLabel:true,titleSessionDetail:true,dateLabel:true,timeLabel:true,sessionRoomLabel:true,sessionPresentersLabel:true,sessionNotesLabel:true,sessionMaterialsLabel:true,addToMySchedule:{tap:"onInMyScheduleTap"},addToCalendar:{tap:"onAddToCalendar"},shareButton:{tap:"onShareButton"},notePanel:{gotonotes:"onGotoNotePanel"},ratePanel:{gotorate:"onGotoRate"},presenterPanel:{gotopresenters:"onGotoPresenterPanel"},mapPanel:{gotomap:"onGotoMapPanel"},materialsPanel:{gotomaterials:"onGotoMaterialPanel"},view:{painted:"onPainted"}},init:function(){this.getEventToolbar().getController().setHiddenActionButton(true);var c=this.getView().config;var b=c.record;var d=this.getView().getMeetingRecord();this.setLocationDescription(this.getView().getLocationDescription());this.getTitleSessionDetail().setHtml(Personify.utils.ItemUtil.getShortContent(d.get("shortName"),48));if(b){this.loadNoteList()}var a=Personify.utils.Configuration.getCurrentUser();if(a.isLogged()){this.getRatePanel().show()}else{this.getRatePanel().hide()}},onPainted:function(){this.onUpdateData(this.getSessionRecords())},setRecord:function(a){var d=this;Ext.Viewport.setMasked({xtype:"loadmask"});var c={sessionID:a.get("sessionID")};var f=Personify.utils.ServiceManager.getStoreManager();var e=f.getSessionDetailStore();var b=Ext.create(e);b.setDataRequest(c);b.load({callback:function(h,g,i){if(i){if(h.length>0){recordSession=h[0];if(recordSession.get("isAdded")!=a.get("isAdded")){recordSession.set("isAdded",a.get("isAdded"))}recordSession.set("appointmentId",a.get("appointmentId"))}d.onUpdateData(h)}else{Ext.Msg.alert("","Error occurred while loading session detail.")}Ext.Viewport.setMasked(false)},scope:this})},onUpdateData:function(i){var e=this.getView().getRecord();var a=this.getView().getMeetingRecord();var g=e.get("isAdded");if(i.length>0){e=i[0];if(e.get("isAdded")!=g){e.set("isAdded",g)}e.set("appointmentId",e.get("appointmentId"))}else{if(!e.get("sessionID")||e.get("sessionID")==""||e.get("sessionID")=="0"){e.set("startDateTimeString",a.get("startDateTimeString"));e.set("endDateTimeString",a.get("endDateTimeString"))}}e.set("timeZoneCode",a.get("timeZoneCode"));this.updateAddRemoveButton(e);var c=this.getView().getRecord();var d=c.MaterialStore;if(d&&d.getCount()>0){this.getSessionMaterialsLabel().setHtml(this.getDataStringFromStore(d,"title"))}else{this.getMaterialsPanel().hide()}this.getTitleOfEvent().setHtml(e.get("title"));this.getDescriptionLabel().setHtml(e.get("description"));this.getSessionRoomLabel().setHtml(this.getLocationDescription());var k="";var f="";if(e.get("type")=="PERSONAL"){k=Personify.utils.ItemUtil.convertStringToDateSession(e.get("startDateTime"));f=Personify.utils.ItemUtil.convertStringToDateSession(e.get("endDateTime"))}else{k=Personify.utils.ItemUtil.convertStringToDateSession(e.get("startDateTimeString"));f=Personify.utils.ItemUtil.convertStringToDateSession(e.get("endDateTimeString"))}this.getDateLabel().setHtml(Ext.Date.format(k,"F j, Y"));this.getTimeLabel().setHtml(Ext.Date.format(k,"g:i A")+" - "+Ext.Date.format(f,"g:i A")+" "+a.get("timeZoneCode"));var b=c.SpeakerSession;var j=e.get("location");if(!j||j==""){this.getMapPanel().hide()}else{}if(b&&b.getCount()>0){this.getSessionPresentersLabel().setHtml(this.getDataStringFromStore(b,"name"))}else{this.getPresenterPanel().hide()}var h=this.getNoteNumber();this.getSessionNotesLabel().setHtml(h)},getDataStringFromStore:function(a,b){var c="";a.each(function(f,d,e){c+=f.get(b);if(d<e-1){c+=", "}});return c},updateAddRemoveButton:function(a){if(a.get("isAdded")){this.getAddToMySchedule().setCls("p-phone-button-eventdetail-regiter");this.getAddToMySchedule().setHtml("Delete from My Schedule")}else{this.getAddToMySchedule().setCls("p-phone-button-eventdetail-savetocalendar");this.getAddToMySchedule().setHtml("Add to My Schedule")}},onBack:function(){this.getView().fireEvent("back",this)},loadNoteList:function(){var a=this.getView().getRecord();var f=this.getView().getMeetingRecord();var e=this;var d=f.get("productID");var g=a.get("sessionID");var c={eventId:d,sessionId:g};var h=Personify.utils.ServiceManager.getStoreManager();var b=Ext.create(h.getNoteListStore());b.setDataRequest(c);b.load({callback:function(j,i,k){e.setNoteNumber(j.length);e.getSessionNotesLabel().setHtml(j.length)}})},onGotoNotePanel:function(){var d=this.getView().getMeetingRecord();var b=this.getView().getRecord();var c=d.get("productID");var f=b.get("sessionID");var e=b.get("title");var a=Ext.create("Personify.view.phone.note.NoteNavigation",{record:b,eventId:c,sessionId:f,title:e});a.addListener("updatelistnote",this.loadNoteList,this);this.getView().fireEvent("requestopendetail",a,null)},onGotoRate:function(){var e=this.getView().getMeetingRecord();var b=this.getView().getRecord();var c=e.get("productID");var f=b.get("sessionID");var a=Ext.create("Personify.view.phone.rate.Rate",{record:b,productId:c,sessionId:f,meetingRecord:e});var d=this;Ext.Function.defer(function(){d.getView().fireEvent("requestopendetail",a,null)},400)},onGotoPresenterPanel:function(){var b=this.getView().getRecord();var a=b.SpeakerSession;if(a&&a.getCount()>0){if(a.getCount()==1){this.onSelectPresenter(a.getAt(0))}else{this.getView().fireEvent("requestopendetail","Personify.view.phone.presenter.PresenterPanel",{record:b})}}},onGotoMapPanel:function(){var d=Personify.utils.Configuration.getConfiguration().getAt(0).EventsStore.get("mapData");var c=this.getView().getRecord();if(d){var a=c.get("location");var b=d.locations[a];if(b){this.getView().fireEvent("requestopendetail","Personify.view.phone.map.MapNavigation",{record:c,locationData:c.get("location")})}else{Ext.Msg.alert("Map","Map not found.",Ext.emptyFn)}}},onInMyScheduleTap:function(){var d=this;var b=this.getView().getRecord();var f=this.getView().getMeetingRecord();var c=f.get("productID");var a=Personify.utils.Configuration.getCurrentUser();if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(a&&a.isLogged()){var e=b.get("isAdded");if(e){Ext.Viewport.setMasked({xtype:"loadmask"});d.getView().fireEvent("removeagenda",b,function(g){if(g){d.getView().fireEvent("updatelistagenda");b.set("isAdded",false);d.updateAddRemoveButton(b);Ext.Msg.alert("","Session has been removed.",Ext.emptyFn);d.getView().fireEvent("refreshagenda",d.getView().getRecord(),false)}Ext.Viewport.setMasked(false)})}else{Ext.Viewport.setMasked({xtype:"loadmask"});d.getView().fireEvent("addagenda",b,c,function(h,g){if(h){d.getView().fireEvent("updatelistagenda");b.set("isAdded",true);b.set("appointmentId",g);d.updateAddRemoveButton(b);Ext.Msg.alert("","Session has been added.",Ext.emptyFn)}Ext.Viewport.setMasked(false)})}}else{this.getView().fireEvent("requestopendetail","Personify.view.phone.login.LoginPhone",null)}},onAddToCalendar:function(){var h=this;if(window.plugins.calendarPlugin&&window.plugins.calendarPlugin.createEvent){var a={};var e=h.getView().getRecord();var i=e.get("title");var d=Personify.utils.ItemUtil.formatJSONDate(Personify.utils.ItemUtil.convertStringToDateSession(e.get("startDateTimeString")));var b=Personify.utils.ItemUtil.formatJSONDate(Personify.utils.ItemUtil.convertStringToDateSession(e.get("startDateTimeString")),"g:i a");var g=Personify.utils.ItemUtil.formatJSONDate(Personify.utils.ItemUtil.convertStringToDateSession(e.get("endDateTimeString")),"g:i a");var c=b+" - "+g;var j=this.getLocationDescription();var f="Title: "+i+"\nDate: "+d+"\nTime: "+c+"\nLocation: "+j;a.title=i;a.location=j;a.body=f;a.startDate=e.get("startDateTime");a.endDate=e.get("endDateTime");a.calendarName=i;window.plugins.calendarPlugin.createEvent(a,function(){Ext.Msg.alert("","Saved to calendar successfully.",Ext.emptyFn)},function(){if(Ext.os.is.Android){Ext.Msg.alert("Calendar","To use this function, you have to allow this mobile application to access your contacts",Ext.emptyFn)}else{Ext.Msg.alert("Calendar","To use this function, you have to allow this mobile application to access your contacts by changing iOS settings in Settings > Privacy > Calendars",Ext.emptyFn)}})}},onShareButton:function(){Personify.utils.ItemUtil.onShareSessionDetail(this.getView().getRecord())},onSelectPresenter:function(a){if(a){var e=Personify.utils.ServiceManager.getStoreManager();var c=e.getCustomerBiographyStore();var b=Ext.create(c);b.setDataRequest(a);this.getView().setMasked({xtype:"loadmask"});var d=this;b.load({callback:function(g,f,h){if(g.length>0){this.getView().fireEvent("requestopendetail","Personify.view.phone.directory.ContactInfoManagement",{record:this.getView().config.record,listOfInfo:Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("listinfoPresenter"),bio:g[0],presenterRecord:a})}d.getView().setMasked(false)},scope:this})}},onGotoMaterialPanel:function(){var a=this.getView().getRecord();this.getView().fireEvent("requestopendetail","Personify.view.phone.material.MaterialPanelPhone",{record:a})}});