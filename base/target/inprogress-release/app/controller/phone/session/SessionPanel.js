Ext.define("Personify.controller.phone.session.SessionPanel",{extend:"Personify.base.Controller",config:{activeindex:0},control:{eventToolbar:{onNavigationButtonTap:"onBack",actionButtonTap:"openMySessionView"},allSessionPanel:{},mySessionPanel:{},cardSession:{onsessiontap:"onOpenDetailView"}},init:function(){this.getEventToolbar().getController().setActionText("View");this.getEventToolbar().getController().setActionCls("p-phone-button-viewmore");var a=this.getView().getRecord();this.setRecord(a)},setRecord:function(a){this.getAllSessionPanel().setRecord(a);this.getMySessionPanel().setRecord(a)},onBack:function(){this.getView().fireEvent("back",this)},openMySessionView:function(){if(this.getActiveindex()==0){var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){this.setActiveindex(1);this.getCardSession().setActiveItem(1);this.getEventToolbar().setTitle("My Sessions")}else{this.getView().fireEvent("requestopendetail","Personify.view.phone.login.LoginPhone",null)}}else{this.setActiveindex(0);this.getCardSession().setActiveItem(0);this.getEventToolbar().setTitle("All Sessions")}},onOpenDetailView:function(a){var b=this;var c=this.getView().getRecord();this.loadDetailSessionStore(a,function(e){b.onUpdatePresenterSession(a);var d=Ext.create("Personify.view.phone.session.SessionDetail",{record:a,meetingRecord:c,locationDescription:a.get("locationDescription")});d.addListener("updatelistagenda",b.onGetMeetingAgendaData,b);b.getView().fireEvent("requestopendetail",d,null);d.getController().setSessionRecords(e)})},loadDetailSessionStore:function(a,f){Ext.Viewport.setMasked({xtype:"loadmask"});var b={sessionID:a.get("sessionID")};var e=Personify.utils.ServiceManager.getStoreManager();var d=e.getSessionDetailStore();var c=Ext.create(d);c.setDataRequest(b);c.load({callback:function(h,g,j){if(j){if(h.length>0){var i=h[0];if(i.get("isAdded")!=a.get("isAdded")){i.set("isAdded",a.get("isAdded"))}i.set("appointmentId",a.get("appointmentId"))}if(typeof f=="function"){f(h)}}else{Ext.Msg.alert("","Error occurred while loading session detail.")}Ext.Viewport.setMasked(false)},scope:this})},onUpdatePresenterSession:function(a){var b=this;var c=this.getView().getRecord();if(a.SpeakerSession){a.SpeakerSession.each(function(d){if(c.SpeakersListEvent){c.SpeakersListEvent.each(function(e){if(e.get("masterCustomerId")==d.get("masterCustomerId")){d.SessionListStore.removeAll();e.SessionListStore.each(function(f){d.SessionListStore.add(f)})}})}})}},onGetMeetingAgendaData:function(){var h=this;var d=this.getView().getRecord();var b=Personify.utils.Configuration.getCurrentUser();if(b&&b.isLogged()){var i=b.get("masterCustomerId");var g=b.get("subCustomerId");var c={SubCustomerID:g,MeetingID:d.get("productID"),MasterCustomerID:i};var a=Personify.utils.ServiceManager.getStoreManager();var f=a.getAgendaStore();var e=Ext.create(f);e.setDataRequest(c);d.MeetingAgendaStore=e;e.load({scope:h,callback:function(){d.SessionStore.each(function(l){if(l.get("isAdded")){l.set("isAdded",false)}});e.each(function(n){for(var m=0;m<d.SessionStore.getCount();m++){var l=d.SessionStore.getAt(m);if(l.get("sessionID")==n.get("sessionID")){l.set("isAdded",true);break}}});var j=h.getMySessionPanel();var k=h.getAllSessionPanel();if(j){h.getMySessionPanel().updateRecord(d)}if(k){h.getAllSessionPanel().updateRecord(d)}}})}}});