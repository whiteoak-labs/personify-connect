Ext.define("Personify.controller.Store",{extend:"Personify.base.Controller",inject:["allProductStore","shoppingCartStore"],requires:"Personify.store.base.FilterProductStore",config:{allProductStore:null,storeProduct:null,productClassFilter:null,textFilter:null,productClass:null,orientation:null,productClassStore:null,shoppingCartStore:null,allItemsPerPage:null},control:{filterList:{filterbytrack:"onFilterStore"},featuredProductsStore:true,featuredItemCarousel:true,storeDetails:true,totalItemStore:true,featuredTotalItem:true,searchStorePanel:{seachclearicontap:"onSearchStore",onsearchtextchange:"onSearchStore",tapsearchbutton:"onSearchStore"},featureLabel:{onOpenFilterPanel:"onOpenFilterPanel",onTapClearFilter:"onClearFilter",ontapcartitemcheckout:"onTapCartItemCheckout"},view:{painted:"onPainted"},filterTextLabel:{},clearFilter:true,searchField:true},init:function(){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Viewport.setMasked(false);Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Product List")}var a=this;a.loadData();Ext.Viewport.setListeners({orientationchange:{fn:a.onOrientationChange,scope:a}});a.setOrientation(Ext.Viewport.getOrientation());this.getView().setMasked(false)},onOrientationChange:function(a,b){this.setOrientation(b);this.updateOrientationCarousel()},onPainted:function(){this.updateOrientationCarousel();Ext.Viewport.setMasked(false)},loadData:function(){var f=this;var g=f.getFeaturedItemCarousel();var e=f.getStoreDetails();g.setMasked({xtype:"loadmask"});e.setMasked({xtype:"loadmask"});var h=Personify.utils.ServiceManager.getStoreManager();var c=null;if(this.getAllProductStore().getAllCount()>0){c=this.getAllProductStore();f.displayData(g,c)}else{c=Ext.create(h.getProductListStore());var a=Personify.utils.Configuration.getCurrentUser();var d=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);var b={IsMember:true,IsStaffmember:a?a.isStaffMember():"false",ItemsPerPage:"10",OrgID:a?a.get("organizationId"):d.get("orgId"),OrgUnitID:a?a.get("organizationUnitId"):d.get("orgUnitId"),ProductClassCode:"ALL",StartIndex:"1",MasterCustomerID:a?a.get("masterCustomerId"):"",SubCustomerID:a?a.get("subCustomerId"):"0"};c.setDataRequest(b);c.load({callback:function(j,i,k){if(k){c.load({callback:function(m,l,n){if(n){Deft.Injector.configure({allProductStore:{value:c}});f.displayData(g,c)}else{f.displayNoData()}}})}else{f.displayNoData()}}})}},displayData:function(m,k){var h=this;var b=k.getProductItemStore();b.clearFilter();h.setStoreProduct(b);if(k.getAt(0)!=null){h.setProductClassStore(k.getAt(0).ProductClassItem);h.onUpdateListFilter()}if(k.getProductItemStore()!=null){var j=k.getProductItemStore().getCount();var f=k.getProductItemStore();var d=[];for(var e=0;e<j;e++){var l=f.getAt(e);if(l.get("featuredProduct")==true){d.push(l)}}var g=Personify.utils.ServiceManager.getModelManager();var a=Ext.create("Ext.data.Store",{model:g.getProductModel(),sorters:[{property:"featuredProductSortOrder",direction:"ASC"},{property:"productID",direction:"ASC"}]});a.add(d);var c=h.setDataCarousel(a,m,2,a.getCount());if(parseInt(c)>0){h.getFeaturedProductsStore().setHidden(false)}else{h.getFeaturedProductsStore().setHidden(true)}h.getFeaturedTotalItem().setHtml(c);h.updateOrientationCarousel()}},updateOrientationCarousel:function(){var d=this;var a=d.getStoreProduct();if(a!=null){var b=a.getCount();var c=d.getStoreDetails();this.onUpdateAllItemsPerPage();var e=d.setDataCarousel(a,c,this.getAllItemsPerPage(),b);d.getTotalItemStore().setHtml(e)}},setDataCarousel:function(l,m,h,j){var g=this;var k=[],e=0;var b=[];var f=Personify.utils.ServiceManager.getModelManager();var a=Ext.create("Ext.data.Store",{model:f.getProductModel()});for(var d=0;d<j;d++){if(l.getAt(d)!=null){k.push(l.getAt(d))}e++;if(e%h==0||e==j){a.add(k);var c=Ext.create("Personify.view.store.StoreDetails",{store:a});c.on({itemtap:{fn:g.onFeaturedItemCarouselTap,scope:g,item:l.getAt(d)}});b.push(c);k=[];a=Ext.create("Ext.data.Store",{model:f.getProductModel()})}}m.setMasked(false);m.removeAll(true);m.add(b);m.setActiveItem(0);return e},onStoreDetailsItemTap:function(h,c,g,b,f,d){var a=Ext.Viewport.add({xtype:"moredetailpage"});a.setProductItemStore(b.getData());a.show()},onFeaturedItemCarouselTap:function(h,c,g,b,f,d){var a=Ext.Viewport.add({xtype:"moredetailpage"});var i=Ext.create("Personify.base.Store",{fields:[{name:"imageURL",type:"string"}]});i.add({imageURL:b.get("imageURL")});a.getController().getImagesMoredetailPage().setStore(i);a.getController().setProductItemStore(b);a.show()},onSearchStore:function(b){var a=(b!=null)?b.toLowerCase():"";if(a==""){this.setTextFilter(null)}else{this.setTextFilter({filterFn:function(c){if(c.get("name").toLowerCase().indexOf(a)>-1){return c}}})}this.updateFilters()},refreshData:function(a){this.loadData()},onCartItemCheckoutStore:function(){var b=this;if(!b.getCurrentUser().isLogged()){Personify.utils.ItemUtil.needToLogin()}else{var a=Ext.Viewport.add({xtype:"cartpanel"});a.show()}},onUpdateListFilter:function(){var a=this.getFilterList();a.getController().setButtonText("Clear Filter");var b=this.getProductClassStore();b.sort("name","DESC");a.getController().getUpdateList().setStore(b)},onOpenFilterPanel:function(b){var a=this.getFilterList();a.showBy(b);b.setZIndex(8)},onFilterStore:function(a){if(a==null){this.setProductClassFilter(null);this.getFilterTextLabel().setHtml("")}else{this.setProductClassFilter({filterFn:function(b){if(b.get("productClass").trim().toLowerCase()==a.trim().toLowerCase()){return b}}});this.getFilterTextLabel().setHtml("FILTER: "+a.toUpperCase())}this.setProductClass(a);this.updateFilters()},updateFilters:function(){var a=this.getStoreProduct();var c=this.getStoreDetails();if(a){a.clearFilter();var b=[];if(this.getProductClassFilter()){b.push(this.getProductClassFilter())}if(this.getTextFilter()){b.push(this.getTextFilter())}if(b.length>0){this.getClearFilter().setDisabled(false)}else{this.getClearFilter().setDisabled(true)}a.filter(b);this.setDataCarousel(a,c,this.getAllItemsPerPage(),a.getCount());this.getTotalItemStore().setHtml(a.getCount())}},onClearFilter:function(){this.setProductClassFilter(null);this.setTextFilter(null);this.updateFilters();this.getFilterTextLabel().setHtml("");this.getSearchField().setValue("")},displayNoData:function(){var a=this.getStoreDetails();this.getFeaturedProductsStore().setHidden(true);a.setHtml("No data");a.setCls("newsFeedItem-emptytext");a.setMasked(false)},destroy:function(){var a=this;Ext.Viewport.removeListener({orientationchange:{fn:a.onOrientationChange,scope:a}});return this.callParent(arguments)},onTapCartItemCheckout:function(){var c=this;if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(window.plugins.app47){window.plugins.app47.sendGenericEvent("View Shopping Cart")}var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){var d=Personify.utils.Configuration.getUrlCheckOut();if(!d){Ext.Msg.alert("","Cannot check out shopping cart.");return}var b=null;if(Ext.os.is.Android){b=window.open(d,"_blank","location=yes,enableViewportScale=yes")}else{b=window.open(d,"_blank","location=no,enableViewportScale=yes")}b.addEventListener("exit",function(){Ext.callback(c.setTotalItemCheckout,c)})}else{Personify.utils.ItemUtil.needToLogin()}},setTotalItemCheckout:function(){var e=this,b=Personify.utils.Configuration.getCurrentUser(),c=null,a=null;if(b&&b.isLogged()){c=b.get("masterCustomerId"),a=b.get("subCustomerId");var f=e.getShoppingCartStore(),d={MasterCustomerId:c,SubCustomerId:a};f.setDataRequest(d);f.load({callback:function(h,g,i){Deft.Injector.configure({shoppingCartStore:{value:f}})}})}},onUpdateAllItemsPerPage:function(){var a=this.getStoreDetails().element.getHeight();var b=parseInt(a/101);this.setAllItemsPerPage((b>1)?b*2:2)}});