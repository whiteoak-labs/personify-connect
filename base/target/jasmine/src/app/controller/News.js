Ext.define("Personify.controller.News",{extend:"Personify.base.Controller",requires:["Personify.model.news.YahooRssItem","Personify.model.personify.news.Feeds"],inject:["personify"],config:{yahooRss:null,personify:null,rssStore:null,isSelected:false,isElement:false,flagSelected:null,record:null,newsStore:null,isSelect:false,allNewsData:null},control:{searchfieldNews:{seachclearicontap:"onClearicontapNews",onsearchtextchange:"onSearchNews"},contentPanelNews:{},contentPanelNewsTitle:{tapTitle:"onTapTitle"},twitterNewsPanel:true,shareNews:{tap:"onTapShareNews"},newsList:{newstitemtap:"onNewstItemTap",select:"onSelectNewsItem"}},init:function(){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(window.plugins.app47){window.plugins.app47.sendGenericEvent("News")}var b=this;var c=[];var a=Personify.utils.Configuration.getCurrentUser();Ext.callback(function(){var f=b.getPersonify().getAt(0).NewsStore.FeedsStore;for(var e=0;e<f.getAllCount();e++){var d=f.getAt(e);if(d.get("visible")){if(d.get("private")){if(a.isLogged()){c.push({name:d.get("title"),url:d.get("url")})}}else{c.push({name:d.get("title"),url:d.get("url")})}}}b.loadAllNewsStore(c)},b,[],1)},loadAllNewsStore:function(b){var a=this;a.getView().setMasked({xtype:"loadmask"});Deft.Promise.all(a.getAllNewsPromise(b)).then({success:function(c){a.setAllNewsData(c);a.parseNewsData(c)},failure:function(){}}).always(function(){a.getView().setMasked(false)})},parseNewsData:function(c){var h=this;var b=Personify.utils.ServiceManager.getStoreManager();var k=Personify.utils.ServiceManager.getModelManager();var l=Ext.create(b.getNewStore());var j=k.getNewsModel();for(var f=0,d=c.length;f<d;f++){var e=[];var a=1;c[f].store.each(function(i){e.push(i);a++});var g=Ext.create(j,{name:c[f].name,expanded:false,news:e});l.add(g)}h.setNewsStore(l)},getAllNewsPromise:function(c){var b=this;var e=[];for(var a=0;a<c.length;a++){var d=function(h,g){var f=Ext.create("Deft.promise.Deferred");b.loadNewsStore(h,g,f);return f.promise};e.push(d(c[a].url,c[a].name))}return e},loadNewsStore:function(d,c,b){if(d){var e=Personify.utils.ServiceManager.getStoreManager();var a=Ext.create(e.getYahooRssStore());a.setFeedUrl(d);a.load({callback:function(g,f,h){if(h){b.resolve({name:c,store:a})}else{b.reject()}}})}},onNewstItemTap:function(b){var a=Ext.create("Ext.data.Store",{model:"Personify.model.news.YahooRssItem"});if(b!=null){this.setRecord(b);a.setData(b);this.getContentPanelNews().setStore(a);this.getContentPanelNewsTitle().setStore(a)}},onSelectNewsItem:function(b,a){if(this.getIsSelect()&&!a.get("expanded")){a.set("expanded",true)}},onDeselectNewsFeedItem:function(b,a){if(this.getIsSelect()&&a.get("expanded")){a.set("expanded",false)}},updateNewsStore:function(a){this.updateViewData(a)},updateViewData:function(b){var a=null;this.getNewsList().setStore(b);this.setIsSelect(true);this.getNewsList().select(0);if(b.getAt(0)){a=b.getAt(0).get("news")[0];if(a){this.onNewstItemTap(a)}}this.setIsSelect(false)},onKeyUpSearchFieldNews:function(b,a){this.onSearchfieldNews(b)},onSearchNews:function(a){this.onSearchfieldNews(a)},onSearchfieldNews:function(e){var b=e.toLowerCase();var d=this.getAllNewsData();if(!e||e==""){for(var c=0;c<d.length;c++){var a=d[c].store;a.clearFilter()}this.parseNewsData(d)}else{for(var c=0;c<d.length;c++){var a=d[c].store;a.clearFilter();a.filterBy(function(f){if(f.get("title").toLowerCase().indexOf(b)>-1){return f}})}this.parseNewsData(d);this.setIsSelect(true);this.getNewsList().selectAll();this.setIsSelect(false)}},onClearicontapNews:function(){this.onSearchfieldNews("")},onSelectNewsFeedItem:function(b,a,c){this.setContentNewsPanel(a);this.setRecord(a)},setContentNewsPanel:function(b){var a=Ext.create("Ext.data.Store",{model:"Personify.model.news.YahooRssItem"});if(b!=null){a.setData(b);this.getContentPanelNews().setStore(a);this.getContentPanelNewsTitle().setStore(a)}},onTweetButtonNewsTap:function(){var b=this,c,a=b.getTextfieldTwitterNews();if(TMA.Twitter.isAuthorized()){if(a.getValue().length>0){c={tweet:a.getValue(),success:b.onSucessTweet,failure:b.onFailureTweet,scope:b};TMA.Twitter.tweet(c)}else{Ext.Msg.alert("Twitter","Empty tweet",Ext.emptyFn)}}else{Ext.Msg.alert("Twitter","You have to login twitter",Ext.emptyFn)}},onSucessTweet:function(b){var a=this;a.getTwitterTimeline().addNewTweet(b)},onFailureTweet:function(){},onTapTitle:function(a){if(Ext.os.is.Android){window.open(a.get("link"),"_blank","location=yes,enableViewportScale=yes")}else{window.open(a.get("link"),"_blank","location=no,enableViewportScale=yes")}},refreshData:function(){},onTapShareNews:function(){var a=this;if(window.plugins.social&&window.plugins.social.available){window.plugins.social.available(function(c){if(c==1){var b="";var d="";var e=a.getRecord();if(e){b=e.get("title")+" "+e.get("description");d=e.get("link")}window.plugins.social.share(b,d,"")}else{Ext.Msg.alert("","Social network plugins is not supported.",Ext.emptyFn)}})}}});