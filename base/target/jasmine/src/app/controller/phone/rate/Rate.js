Ext.define("Personify.controller.phone.rate.Rate",{extend:"Personify.base.Controller",requires:["Personify.view.phone.login.LoginPhone"],control:{titleRate:true,inputRating:true,inputRatingComment:{keyup:"onTextChange",change:"onTextChange",show:"onClearText",clearicontap:"onClearText"},saveRatingComment:{tap:"onTapSaveRatingCommentButton"},rateToolbar:{onNavigationButtonTap:"onBack"},rateTitleBar:true},init:function(){this.getRateToolbar().getController().setHiddenActionButton(true);var c="";var b=this.getView().getRecord();if(b.get("shortName")){c=b.get("shortName")}else{if(b.get("title")){c=b.get("title")}}this.getRateTitleBar().setHtml(Personify.utils.ItemUtil.getShortContent(c,48));var a=Personify.utils.Configuration.getConfiguration().getAt(0).EventsStore.get("rateTitleBar");if(a){this.getTitleRate().setHtml(a)}},onBack:function(){this.getView().fireEvent("back",this)},onTapSaveRatingCommentButton:function(){this.getInputRatingComment().blur();if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}var h=this;var b=Personify.utils.Configuration.getCurrentUser();if(b&&b.isLogged()){Ext.Viewport.setMasked({xtype:"loadmask"});var h=this;var g=h.getInputRatingComment().getValue();var c=h.getInputRating().getValue()+1;var e=this.getView().getMeetingRecord()?this.getView().getMeetingRecord().get("productID"):null;var a=Personify.utils.ServiceManager.getStoreManager();var i=a.getSaveRating();var d=Ext.create(i);var f={InternalKey:null,NavigationKey:null,MasterCustomerId:b.get("masterCustomerId"),SubCustomerId:b.get("subCustomerId"),StarRating:c,Comments:g,ProductId:e};d.setDataRequest(f);d.load({callback:function(k,j,l){if(l){Ext.Msg.alert("","This session has been rated.");h.resetForm();Ext.Viewport.setMasked(false)}else{Ext.Msg.alert("","Please select a star rating and/or enter your comments.");Ext.Viewport.setMasked(false)}},scope:this})}else{this.getView().fireEvent("requestopendetail","Personify.view.phone.login.LoginPhone",null);return}},resetForm:function(){var a=this;a.getInputRatingComment().setValue("");a.getInputRating().setValue(-1)},onTextChange:function(g){var b=Ext.DomQuery.select("textarea",g.element.dom)[0];var e=b.scrollHeight;var c=b.clientHeight;var f=b.selectionEnd;var d=b.textLength;if(c<e){this.getInputRatingComment().setHeight(e);if(f==d){this.getInputRatingComment().getParent().getScrollable().getScroller().scrollToEnd()}else{var a=this.getInputRatingComment().getParent().getScrollable().getScroller();a.scrollBy(0,e-c)}}},onClearText:function(){this.getInputRatingComment().setHeight(82);this.getInputRatingComment().getParent().getScrollable().getScroller().scrollToTop()}});