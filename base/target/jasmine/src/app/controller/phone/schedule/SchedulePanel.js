Ext.define("Personify.controller.phone.schedule.SchedulePanel",{extend:"Personify.base.Controller",config:{eventRecord:null,flagSelected:false,futureEvents:null,currentStore:null,itemSelected:false,expandEvent:null,indexExpandEvent:null,isSelectAll:false},control:{eventToolbar:{onNavigationButtonTap:"onBack",actionButtonTap:"addPersonalEvent"},searchField:{change:"onTapSearchButton",clearicontap:"onClearIconTap",keyup:"onTapSearchButton",},selectScheduleItem:{removeitem:"removeMyScheduleItem",eventitemtap:"openMyScheduleItem",select:"onSelectMyScheduleItem"},selectSchedulePanel:true,allEventButton:{tap:"goToAllEvent"}},init:function(){this.getEventToolbar().getController().setActionText(" + Add")},updateRecordForSelectItems:function(c){var a=Personify.utils.Configuration.getCurrentUser();var b=a.getScheduleMonthStore(c);this.getSelectScheduleItem().setStore(b);this.getSelectSchedulePanel().setStore(c)},onGetData:function(){Ext.Viewport.setMasked({xtype:"loadmask"});var a=this;Ext.callback(function(){var b=Ext.getStore("agendaStoreListMain");if(b&&b.getCount()>0){var e=Personify.utils.ServiceManager.getStoreManager();var c=e.getAgendaStore();var d=Ext.create(c);b.each(function(f){d.add(f)});a.updateRecordForSelectItems(d)}else{a.onUpdateMySchedule()}Ext.Viewport.setMasked(false)},a,[],1)},onUpdateMySchedule:function(d){var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Agenda List")}var f=this;f.getView().setMasked({xtype:"loadmask"});var c={MasterCustomerID:a?a.get("masterCustomerId"):"",SubCustomerID:a?a.get("subCustomerId"):"",MeetingID:""};var h=Personify.utils.ServiceManager.getStoreManager();var e=h.getAgendaStore();var b=Ext.create(e);var g=Ext.create(e);b.setDataRequest(c);b.setStoreId("agendaStoreListMain");b.load({callback:function(j,i,k){f.getView().setMasked(false);if(j.length>0){b.each(function(l){g.add(l)})}f.updateRecordForSelectItems(g);f.getView().setMasked(false)},scope:this})}},onBack:function(){this.getView().fireEvent("backtomain",this)},onTapSearchButton:function(d,c){var b=d.getValue().trim();var a=this.getSelectSchedulePanel().getStore();a.clearFilter();if(b!=""){a.filter(function(f){didMatch=(f.get("title").trim().toLowerCase()+" "+f.get("description").trim().toLowerCase()+" "+f.get("type").trim().toLowerCase()+" "+f.get("speakerName").trim().toLowerCase()).match(b.trim().toLowerCase());if(f.eventData){var e=f.eventData.SpeakersListEvent;e.each(function(g){didMatch=didMatch||g.get("name").trim().toLowerCase().match(b.trim().toLowerCase())})}if(didMatch){return f}});this.updateRecordForSelectItems(a);this.setIsSelectAll(true);this.getSelectScheduleItem().selectAll();this.setIsSelectAll(false)}},addOrRemoveRecordToStore:function(b){var a=this.getSelectSchedulePanel().getStore();a.removeAll();for(var c=0;c<b.length;c++){a.add(b[c])}this.updateRecordForSelectItems(a);Ext.Viewport.setMasked(false)},addOrRemoveByMeetingRecord:function(a,d,b){var c=this;c.addOrRemoveRecordToStore(b)},addPersonalEvent:function(){this.getView().fireEvent("requestopendetail","Personify.view.phone.addevent.AddEvent",null)},onClearIconTap:function(){var a=this.getSelectSchedulePanel().getStore();a.clearFilter();this.updateRecordForSelectItems(a)},removeItemsInnerSelectItem:function(){var b=this.getSelectScheduleItem().getViewItems();for(var c=0;c<b.length;c++){var a=Ext.get(b[c].id);if(a.eventList){a.eventList.destroy();a.eventList=null}}},goToAllEvent:function(){this.getView().fireEvent("requestchangeview","Personify.view.phone.Event",null)},removeMyScheduleItem:function(a){var d=this;if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}var c=Personify.utils.ItemUtil.getMessageMatchTypeOfEvent(a);Ext.Msg.confirm("",c.msg,b);function b(e){Ext.Msg.hide();if(e=="yes"){Ext.Viewport.setMasked(false);Ext.Viewport.setMasked({xtype:"loadmask"});d.getView().fireEvent("removeagenda",a,function(f){if(f){d.getSelectSchedulePanel().getStore().remove(a);Ext.Msg.alert("",c.msgSuccess,Ext.emptyFn);Ext.Viewport.setMasked(false)}})}}},openMyScheduleItem:function(a){var e=this;if(a.get("type").toUpperCase()=="PERSONAL"){e.getView().fireEvent("requestopendetail","Personify.view.phone.schedule.PersonalAgenda",{record:a})}else{var c=a.get("meetingId"),f=a.get("sessionID"),b=Ext.getStore("meetingListtingMain");if(b){var d=true;b.each(function(m){if(m.get("productID")==c){d=false;m.set("appointmentId",a.get("appointmentId"));if(f>0){var l=m.SessionStore;if(!l||l.getCount()<=0){var k="";var i={xtype:"loadmask",message:"Loading..",fullscreen:true,centered:true,cls:k};Ext.Viewport.setMasked(i);var g=Personify.utils.Configuration.getCurrentUser();var j={MeetingID:a.get("meetingId"),IsStaffMember:g?g.isStaffMember().toString():false,IsMember:g?g.isMember().toString():false,ItemsPerPage:"100000",StartIndex:"0"};var n=Personify.utils.ServiceManager.getStoreManager();var h=n.getSessionStore();var l=Ext.create(h);l.setDataRequest(j);a.SessionStore=l;l.load({scope:e,callback:function(){Ext.Viewport.setMasked(false);l.each(function(o){if(o.get("sessionID")==f){o.set("appointmentId",a.get("appointmentId"));if(!o.get("isAdded")){o.set("isAdded",true)}e.loadDetailSessionStore(o,function(p){e.getView().fireEvent("requestopendetail","Personify.view.phone.session.SessionDetail",{record:o,meetingRecord:m,locationDescription:o.get("locationDescription"),sessionRecords:p})})}})}})}else{l.each(function(o){if(o.get("sessionID")==f){o.set("appointmentId",a.get("appointmentId"));if(!o.get("isAdded")){o.set("isAdded",true)}e.loadDetailSessionStore(o,function(p){e.getView().fireEvent("requestopendetail","Personify.view.phone.session.SessionDetail",{record:o,meetingRecord:m,locationDescription:o.get("locationDescription"),sessionRecords:p})})}})}}else{m.set("isAdded",true);e.getView().fireEvent("requestopendetail","Personify.view.phone.event.EventDetail",{record:m})}}});if(d){Ext.Msg.alert("","Cannot find associated meeting, please help to report this problem.")}}}},onSelectMyScheduleItem:function(b,a){if(this.getIsSelectAll()&&!a.get("expanded")){a.set("expanded",true)}},loadDetailSessionStore:function(a,f){Ext.Viewport.setMasked({xtype:"loadmask"});var b={sessionID:a.get("sessionID")};var e=Personify.utils.ServiceManager.getStoreManager();var d=e.getSessionDetailStore();var c=Ext.create(d);c.setDataRequest(b);c.load({callback:function(h,g,j){if(j){if(h.length>0){var i=h[0];if(i.get("isAdded")!=a.get("isAdded")){i.set("isAdded",a.get("isAdded"))}i.set("appointmentId",a.get("appointmentId"))}if(typeof f=="function"){f(h)}}else{Ext.Msg.alert("","Error occurred while loading session detail.")}Ext.Viewport.setMasked(false)},scope:this})}});