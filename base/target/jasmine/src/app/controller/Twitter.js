Ext.define("Personify.controller.Twitter",{extend:"Personify.base.Controller",inject:{currentUser:"currentUser"},config:{currentUser:null,refreshInterval:null,actionTweet:null,itemsToLoad:30,page:1},control:{view:{itemtap:"onItemTap",reload:"reLoad",itemtouchstart:"onItemTouchStart",itemtouchend:"onItemTouchEnd",scrollend:"onScrollEnd"}},init:function(){var a=this;this.getView().setMasked({xtype:"loadmask"});a.callParent(arguments);a.setRefreshInterval(setInterval(function(){a.onRefreshTwitter()},Personify.utils.Configuration.getConfiguration().first().NewsStore.get("refreshInterval")*1000))},onRefreshTwitter:function(){var d=this;var c=this.getView().getType();var a=this.getView().getConfigSearch();var b=this.getView().getTwitterHashTag();switch(c){case"timeline":default:this.reLoad(b);break;case"search":d.onSearch(a)}},destroy:function(){clearInterval(this.getRefreshInterval());this.getView().setStore(null);return this.callParent(arguments)},onUserTimeLineSuccess:function(c){if(!this["getView"]){return}var b=this,d=b.getView();var a=Ext.create("Personify.store.UserTimelineTwitter",{data:c});d.setStore(a);d.refresh();d.setMasked(false)},onUserTimeFailure:function(){if(!this["getView"]){return}this.getView().setMasked(false)},reLoad:function(a){var b=this;TMA.Twitter.userTimeline({screen_name:a,count:b.getItemsToLoad(),success:b.onUserTimeLineSuccess,failure:b.onUserTimeFailure,scope:b})},onScrollEnd:function(){var c=this;var b=this.getView().getType();if(b=="timeline"){var a=this.getView().getTwitterHashTag();var d=this.getPage()+1;this.setPage(d);this.getView().setMasked({xtype:"loadmask"});TMA.Twitter.userTimeline({screen_name:a,count:c.getItemsToLoad(),page:d,success:c.onLoadMoreSuccess,failure:c.onUserTimeFailure,scope:c})}},onLoadMoreSuccess:function(b){if(!this["getView"]){return}var a=this.getView().getStore();a.add(b);this.getView().refresh();this.getView().setMasked(false)},onSearchMoreSuccess:function(b){var a=this.getView().getStore();a.add(b.statuses);this.getView().refresh();this.getView().setMasked(false)},onItemTap:function(e,g,h,f,a){var i=this,c,j=this.getView().getType();if(a.target.classList.contains("favorite-feature-twitter")){c={tweetId:f.get("id_str"),success:i.onSuccessFavorite,failure:i.onFailureFavorite,scope:h};TMA.Twitter.favorite(c)}if(a.target.classList.contains("reply-feature-twitter-button")){f.set("isReply",true);var d=h.query(".x-input-text")[0],b=i.getView().getTwitterHashTag();if(j=="timeline"){d.value=b+" ";Personify.utils.ItemUtil.setCaretSelection(d,b.length+1,b.length+1)}else{var k=f.get("user").screen_name;d.value="@"+k+" \n"+b;Personify.utils.ItemUtil.setCaretSelection(d,k.length+2,k.length+2)}i.setActionTweet("reply")}if(a.target.classList.contains("cancel-reply-twitter-button")){f.set("isReply",false);i.setActionTweet(null)}if(a.target.classList.contains("reply-twitter-button")){var i=this;switch(i.getActionTweet()){case"reply":var d=h.query(".x-input-text")[0],c={tweet:d.value,tweetId:f.get("id_str"),author:TMA.Twitter.getUser().get("screen_name"),success:i.onReplySuccess,failure:i.onReplyError,scope:i};TMA.Twitter.reply(c);break;case"retweet":var c={tweetId:f.get("id_str"),author:TMA.Twitter.getUser().get("screen_name"),success:i.onTweetSuccess,failure:i.onTweetError,scope:i};TMA.Twitter.retweet(c);break}f.set("isReply",false);i.setActionTweet(null)}if(a.target.classList.contains("twitter-retweet")){f.set("isReply",true);var d=h.query(".x-input-text")[0];d.value=f.get("text");d.disabled=true;this.setActionTweet("retweet")}},onItemTouchStart:function(b,c,g,a,f,d){if(f.target.className.indexOf("x-button")>=0){f.target.classList.add("x-button-pressing")}else{if(f.target.parentNode&&f.target.parentNode.className.indexOf("x-button-label")>=0){f.target.parentNode.parentNode.classList.add("x-button-pressing")}}},onItemTouchEnd:function(b,c,g,a,f,d){if(f.target.className.indexOf("x-button")>=0){f.target.classList.remove("x-button-pressing")}else{if(f.target.parentNode&&f.target.parentNode.className.indexOf("x-button-label")>=0){f.target.parentNode.parentNode.classList.remove("x-button-pressing")}}},onSuccessFavorite:function(){var b=this,a=b.down(".favorite-feature-twitter").dom;if(a){a.textContent="favorited";a.classList.remove("favorite-feature-twitter");a.classList.add("tweet-favorited")}},onFailureFavorite:function(){},onReplySuccess:function(){var c=this;var b=c.getView().getConfigSearch();var a=new Ext.util.DelayedTask(function(){c.onSearch(b)},c);Ext.Msg.alert("","The tweet is successful.",Ext.emptyFn);a.delay(5000)},onReplyError:function(){},onTweetSuccess:function(){var c=this;var b=c.getView().getConfigSearch();var a=new Ext.util.DelayedTask(function(){c.onSearch(b)},c);Ext.Msg.alert("","The tweet is successful.",Ext.emptyFn);a.delay(5000)},onTweetError:function(){},onSearch:function(a){if(!TMA.Twitter.isAuthorized()){return}var b=this;TMA.Twitter.search({config:a,scope:b,success:b.onSuccessSearch,failure:b.onFailureSearch})},onSuccessSearch:function(c){var b=this,d=b.getView();var a=Ext.create("Personify.store.UserTimelineTwitter");a.setData(c.statuses);d.setStore(a);d.refresh();d.setMasked(false)},onFailureSearch:function(){this.getView().setMasked(false)}});