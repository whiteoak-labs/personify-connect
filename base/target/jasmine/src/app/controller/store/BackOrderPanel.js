Ext.define("Personify.controller.store.BackOrderPanel",{extend:"Personify.base.Controller",config:{product:null,quantity:1},control:{btnCancel:{tap:"onCloseForm"},btncheckout:{tap:"onBuyNow"},closeorderForm:{tap:"onCloseForm"}},onCloseForm:function(){this.getView().destroy()},onBuyNow:function(){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}var f=this;var e=f.getProduct().get("productID");var g=f.getQuantity();Ext.Viewport.setMasked({xtype:"loadmask"});this.onCloseForm();var a=Personify.utils.Configuration.getCurrentUser();var d=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);var h=Personify.utils.ServiceManager.getStoreManager();var c=Ext.create(h.getOrderFalse());var b={CusAddressID:"",MasterCustomerID:a.get("masterCustomerId"),SubCustomerID:a.get("subCustomerId"),ProductID:e,OrgID:a?a.get("organizationId"):d.get("orgId"),OrgUnitID:a?a.get("organizationUnitId"):d.get("orgUnitId"),CustomPrice:"",ConfirmOrder:"false",Quantity:g};c.setDataRequest(b);c.load({callback:function(m,l,n){if(n){var k=Ext.create(h.getProfileStore());var j=a.isStaffMember();var i={MasterCustomerId:a.get("masterCustomerId"),SubCustomerId:a.get("subCustomerId"),ReqMasterCustomerId:a.get("masterCustomerId"),ReqSubCustomerId:a.get("subCustomerId"),IsStaff:j,RecordType:""};k.setDataRequest(i);k.load({callback:function(B,w,u){Ext.Viewport.setMasked(false);var y=[];var F=Ext.create("Personify.base.Store",{model:"Personify.model.jsonp.profile.Addresses"});if(u){if(B[0]){var E=B[0];if(E.EntryProfile.getAt(0)){var D=E.EntryProfile.getAt(0);var r=D.AddressesProfile.getCount();for(var C=0;C<r;C++){var s=D.AddressesProfile.getAt(C);var z=s.get("streetAddress"),t=s.get("locality"),p=s.get("region"),v=s.get("postalCode"),A=s.get("country"),o=s.get("addressesId"),q=s.get("type");y.push({streetAddress:z,locality:t,region:p,postalCode:v,country:A,addressesId:o,type:q})}F.add(y)}}}var x=Ext.create("Personify.view.store.OrderPanel");x.getController().setProduct(f.getProduct());x.getController().setIsProductEvent(false);Ext.Viewport.add(x);c.each(function(H){var G=H.get("baseAmount");H.set("baseAmount",G*g)});x.getController().getOrderTemplate().setStore(c);x.getController().getShippingAddress().setStore(F);x.getController().setQuantity(g);if(F.getCount()>0){x.getController().getShippingAddress().select(0)}f.getView().destroy();x.show()}})}else{Ext.Viewport.setMasked(false);Ext.Msg.alert("Shopping Cart","Cannot process order at this time.",Ext.emptyFn)}}})}});