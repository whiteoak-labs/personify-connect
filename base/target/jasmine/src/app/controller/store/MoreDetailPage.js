Ext.define("Personify.controller.store.MoreDetailPage",{extend:"Personify.base.Controller",inject:["shoppingCartStore"],config:{productItemStore:null,isDonate:false,shoppingCartStore:null},requires:["Personify.utils.ItemUtil","Personify.view.store.OrderPanel","Personify.view.store.BackOrderPanel","Personify.base.Store"],control:{view:{show:"onShow"},titleMoredetailPage:true,memberPriceMoredetailPage:true,labelMemberPriceMoredetailPage:true,labelListPriceMoredetailPage:true,listPriceMoredetailPage:true,descriptionMoredetailPage:true,productIdMoredetailPage:true,quantityPanelMoreDetailPage:true,buyNowButtonMoredetailPage:{tap:"onBuyNow"},addToCartButtonMoredetaiPage:{tap:"onAddToCart"},quantityMoredetailPage:{},imagesMoredetailPage:true},init:function(){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Product Detail")}var b=this;var a=Personify.utils.Configuration.getCurrentUser();if((a.get("cCNumber")!=null&&a.get("cCType")!=null)&&(a.get("cCNumber")!=""&&a.get("cCType")!="")){b.getBuyNowButtonMoredetailPage().show()}},onShow:function(){var f=this.getProductItemStore();var e=f.get("price");var c=f.get("memberPrice");var g=f.get("yourPrice");var d=f.get("yourPriceRateStructure")?f.get("yourPriceRateStructure").trim().toLowerCase():"list";var b=Personify.utils.ItemUtil.getWidthPrice(e,c,9);this.getTitleMoredetailPage().setHtml(f.get("name"));this.getListPriceMoredetailPage().setHtml(Personify.utils.ItemUtil.formatPurchaseAmount(e,2));var a=Personify.utils.Configuration.getCurrentUser();if(a.isLogged()){if(d=="list"){this.getMemberPriceMoredetailPage().setHtml(Personify.utils.ItemUtil.formatPurchaseAmount(c,2));this.getLabelListPriceMoredetailPage().setHtml("Your Price: ");this.getListPriceMoredetailPage().setHtml(Personify.utils.ItemUtil.formatPurchaseAmount(g,2));this.getLabelMemberPriceMoredetailPage().setHtml("Member Price: ")}else{this.getMemberPriceMoredetailPage().setHtml(Personify.utils.ItemUtil.formatPurchaseAmount(g,2));this.getLabelMemberPriceMoredetailPage().setHtml("Your Price: ");this.getLabelListPriceMoredetailPage().setHtml("List Price: ")}}else{this.getMemberPriceMoredetailPage().setHtml(Personify.utils.ItemUtil.formatPurchaseAmount(c,2))}this.getMemberPriceMoredetailPage().setWidth(b);this.getListPriceMoredetailPage().setWidth(b);this.getDescriptionMoredetailPage().setHtml(f.get("descr"));this.getProductIdMoredetailPage().setHtml(f.get("productID"));this.getImagesMoredetailPage().select(0);if(f.get("productClass")=="DONATION"){this.getQuantityPanelMoreDetailPage().hide();this.setIsDonate(true)}this.getBuyNowButtonMoredetailPage().setText(f.get("purchaseActionTitle"))},onAddToCart:function(e){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}var n=this;var b=Personify.utils.Configuration.getCurrentUser();if(b.isLogged()){if(n.getProductItemStore().get("membersonly")){if(b.isExpiredMember()){Ext.Msg.alert("Alert","For Members Only.",Ext.emptyFn);return}}var c=n.getQuantityMoredetailPage().getValue();if(c<=0){Ext.Msg.alert("Alert","Quantity must be more than 0.",Ext.emptyFn);return}var m=this.getProductItemStore();if(n.getIsDonate()){c=1}var d=n.getProductIdMoredetailPage().getHtml();var o=b.data.masterCustomerId;var i=b.data.subCustomerId;var a=Personify.utils.ServiceManager.getStoreManager(),j=a.getAddCartStore();var l=m.get("yourPriceRateStructure")?m.get("yourPriceRateStructure"):"LIST";var h=m.get("yourPriceRateCode")?m.get("yourPriceRateCode"):"STD";var g=m.get("yourPrice");var k={InternalKey:null,NavigationKey:null,MasterCustomerId:o,SubCustomerId:i,ProductId:d,Qty:c,CartSessionId:null,IsAutoRenew:null,UserDefinedField1:null,UserDefinedField2:null,UserDefinedField3:null,MarketCode:null,OrderNo:null,OrderLineNo:null,Price:g,RateCode:h,RateStructure:l,ShipMasterCustomerId:o,ShipSubCustomerId:i,DoNotAutoAddComponents:null};var f=Ext.create(j);f.setDataRequest(k);n.getView().setMasked({xtype:"loadmask"});f.load({callback:function(s,r,w){n.getView().setMasked(false);if(w){var t=f.getAt(0).getData().cartItemId;if(t==-1){Ext.Msg.alert("","Add to shopping cart failed.")}else{var q=Ext.ComponentQuery.query("#totalItemCheckout");q[0].setHtml(parseInt(q[0].getHtml())+c);if(b.get("masterCustomerId")==null){o="";i=""}var u=n.getShoppingCartStore();var v={MasterCustomerId:o,SubCustomerId:i};u.setDataRequest(v);u.load();Deft.Injector.configure({shoppingCartStore:{value:u}});n.getView().destroy();var p=Ext.create("Personify.view.store.ConfirmAddToCart");Ext.Viewport.add(p);p.show()}}else{Ext.Msg.alert("","Add to shopping cart failed.")}}})}else{n.getView().destroy();Personify.utils.ItemUtil.needToLogin()}},onBuyNow:function(){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}var g=this;var e=g.getQuantityMoredetailPage().getValue();if(e<=0){Ext.Msg.alert("Alert","Quantity must be more than 0.",Ext.emptyFn);return}var h=g.getProductItemStore().get("productID");var d=Personify.utils.Configuration.getCurrentUser();var c=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);if(!d.isLogged()){Personify.utils.ItemUtil.needToLogin()}if(g.getProductItemStore().get("membersonly")){if(d.isExpiredMember()){Ext.Msg.alert("Alert","For Members Only.",Ext.emptyFn);return}}if(g.getProductItemStore().get("allowbackorders")==true&&g.getProductItemStore().get("availablequantity")==0){var a=Ext.create("Personify.view.store.BackOrderPanel");a.getController().setProduct(g.getProductItemStore());a.getController().setQuantity(e);Ext.Viewport.add(a);a.show();g.getView().destroy();return}g.getView().setMasked({xtype:"loadmask"});var b=Personify.utils.ServiceManager.getStoreManager();var i=Ext.create(b.getOrderFalse());var f={CusAddressID:"",MasterCustomerID:d.get("masterCustomerId"),SubCustomerID:d.get("subCustomerId"),ProductID:h,OrgID:d?d.get("organizationId"):c.get("orgId"),OrgUnitID:d?d.get("organizationUnitId"):c.get("orgUnitId"),CustomPrice:"",ConfirmOrder:"false",Quantity:e};i.setDataRequest(f);i.load({callback:function(n,m,o){if(o){var l=Ext.create(b.getProfileStore());var k=d.isStaffMember();var j={MasterCustomerId:d.get("masterCustomerId"),SubCustomerId:d.get("subCustomerId"),ReqMasterCustomerId:d.get("masterCustomerId"),ReqSubCustomerId:d.get("subCustomerId"),IsStaff:k,RecordType:""};l.setDataRequest(j);l.load({callback:function(C,x,v){g.getView().setMasked(false);var z=[];var G=Ext.create("Personify.base.Store",{model:"Personify.model.jsonp.profile.Addresses"});if(v){if(C[0]){var F=C[0];if(F.EntryProfile.getAt(0)){var E=F.EntryProfile.getAt(0);var s=E.AddressesProfile.getCount();for(var D=0;D<s;D++){var t=E.AddressesProfile.getAt(D);var A=t.get("streetAddress"),u=t.get("locality"),q=t.get("region"),w=t.get("postalCode"),B=t.get("country"),p=t.get("addressesId"),r=t.get("type");z.push({streetAddress:A,locality:u,region:q,postalCode:w,country:B,addressesId:p,type:r})}G.add(z)}}}var y=Ext.create("Personify.view.store.OrderPanel");y.getController().setProduct(g.getProductItemStore());y.getController().setIsProductEvent(false);y.getController().setQuantity(e);Ext.Viewport.add(y);i.each(function(I){var H=I.get("baseAmount");I.set("baseAmount",H*e)});y.getController().getOrderTemplate().setStore(i);y.getController().getShippingAddress().setStore(G);if(G.getCount()>0){y.getController().getShippingAddress().select(0)}g.getView().destroy();y.show()}})}else{g.getView().setMasked(false);Ext.Msg.alert("Shopping Cart","Cannot process order at this time.",Ext.emptyFn)}}})}});