Ext.define("Personify.controller.Main",{extend:"Personify.base.Controller",inject:["personify","currentUser","shoppingCartStore","notificationStore"],requires:["Personify.view.community.CommunityPanel","Personify.view.Home","Personify.view.Directory","Personify.view.Store","Personify.view.Profile","Personify.view.main.Notifications","Personify.model.base.MenuItem"],config:{currentUser:null,personify:null,shoppingCartStore:null,agendaListStore:null,notificationStore:null},control:{headerPanel:{},loginPanel:{userlogin:"onUserLoggedIn",requestchangeview:"onRequestChangeView"},menuBar:{openselectview:"onRequestChangeView",onNotificationButton:"onNotificationButton",ontapcartitemcheckout:"onTapCartItemCheckout"},labelTitle:{},viewPanel:{copymeetinglist:"onCopyMeetingList",updatemeetinglist:"onUpdateEventList",copyagendalist:"onCopyScheduleList",updateagendalist:"onUpdateMySchedule"},connectButton:{tap:"onConnectButtonTap"},lastNewsPanel:{},iconHeader:{},view:{painted:"onPainted"}},init:function(){console.log("Main.init: start");var b=this;b.updateViewModules();var a=Personify.utils.Configuration.getCurrentUser();if(a.isLogged()){b.onUserLoggedIn(a)}else{b.getView().setMasked({xtype:"loadmask"});b.setAgendaListStore(null);b.onUpdateEventList(function(d){var c=b.getViewPanel().getActiveItem();c.getController().getNextThreeEventList().getController().onUpdateEventList(d);b.getView().setMasked(false)})}Ext.Viewport.addListener("keyboardhide",b.onHideKeyBoard,b);Ext.Viewport.addListener("keyboardshow",b.onShowKeyBoard,b);window.addEventListener("lockoutView",function(){var c=b.getCurrentUser();if(c.isLogged()){var d=Ext.create("Personify.view.LoginForm",{hidden:true,modal:true,hideOnMaskTap:true,centered:true});Ext.Viewport.add(d);d.show()}},false);b.getLabelTitle().addCls("homemenuitem");console.log("Main.init: hide splashscreen");navigator.splashscreen.hide();return b.callParent(arguments)},onHideKeyBoard:function(){this.getMenuBar().setHidden(false);this.getViewPanel().setStyle("margin-bottom: 52px;")},onShowKeyBoard:function(){this.getMenuBar().setHidden(true);this.getViewPanel().setStyle("margin-bottom: 0px;")},onPainted:function(){console.log("Main.onPainted:");navigator.splashscreen.hide()},onUserLoggedIn:function(c){var d=this;if(Ext.Viewport.getOrientation()=="landscape"){var b={xtype:"loadmask",message:"Loading..",fullscreen:true,centered:true,cls:"p-loading-ipad-landscape"}}else{var b={xtype:"loadmask",message:"Loading..",fullscreen:true,centered:true,cls:"p-loading-ipad-portrait"}}Ext.Viewport.setMasked(b);Deft.Injector.configure({currentUser:{value:c}});d.setCurrentUser(c);d.updateViewModules();d.getLastNewsPanel().getController().onUpdateLastNews();d.onLoadNotification();d.onUpdateMySchedule(true);d.setTotalItemCheckout();var a=d.getViewPanel().getActiveItem();if(a.getItemId()=="homeView"){a.getController().getNextThreeEventList().getController().onUpdateEventList(null);d.onUpdateEventList(function(e){Ext.Viewport.setMasked(false);a.getController().getNextThreeEventList().getController().onUpdateEventList(e)});a.getController().setCurrentUser(c);a.getController().onLoadMenu()}else{if(a.getItemId().indexOf("eventAndEventDetailPage")<0){d.onUpdateEventList(function(){Ext.Viewport.setMasked(false)})}else{Ext.Viewport.setMasked(false)}}d.getMenuBar().getController().closeMenuBar()},onRequestChangeView:function(a,b,e,c){var d=this;Ext.callback(function(){d.openView(a,b,e,c)},d,[],1)},openView:function(b,c,g,d){if(c){if(c.record){if(c.record.get("neededLogin")&&!this.getCurrentUser().isLogged()){Personify.utils.ItemUtil.needToLogin();return}}}if(b=="Personify.view.Profile"){this.getLoginPanel().hide();this.getLabelTitle().setCls("profilemenuitem")}else{this.getLoginPanel().show();this.getLabelTitle().setCls("labelTitleHeaderPanel")}if(typeof b=="string"){b=Ext.create(b,c)}b.addListener("requestchangeview",this.onRequestChangeView,this);b.addListener("updatetitle",this.updateTitle,this);if(c){var e=c.listeners;if(e){for(var f in e){this.getView().addListener(f,e[f],b)}}}var a=this.getViewPanel();a.removeAll(true,true);a.add(b);this.getMenuBar().getController().getMenubarListItems().hide();this.getMenuBar().getController().resetSelectedButton();this.getLabelTitle().setHtml(g);this.getIconHeader().setCls("p-image-iconheaderurl "+d);this.getIconHeader().setHidden(false)},updateViewModules:function(){var b=this;var c=function(d){b.getMenuBar().getController().updateMenuList(d)};var a=b.getCurrentUser().modulesConfigurationLoad("tablet",c,b)},logout:function(){var a=Personify.utils.ServiceManager.getModelManager();var c=a.getUserModel();var b=Ext.create(c);Deft.Injector.configure({currentUser:{value:b}});this.setCurrentUser(b);Personify.utils.Sqlite.invalidateProfileCache();Personify.utils.Configuration.setCurrentUser(b);Personify.utils.Configuration.setDiscussionUrl(null);if(window.plugins.applicationPreferences){window.plugins.applicationPreferences.set("keepUserLogin","",function(){},function(){})}TMA.Twitter.unAuthorize();this.updateViewModules();this.onChangeNotificationLabel("0");this.openView("Personify.view.Home",null,"Main","homemenuitem");this.getLoginPanel().getController().resetViews();Ext.Array.each(Ext.ComponentQuery.query("#totalItemCheckout"),function(f){f.setHtml(0)});if(window.plugins.pushNotification){var e=window.plugins.pushNotification;e.setAlias("")}var d=this;d.getView().setMasked({xtype:"loadmask"});d.onUpdateEventList(function(g){var f=d.getViewPanel().getActiveItem();f.getController().getNextThreeEventList().getController().onUpdateEventList(g);d.getView().setMasked(false)})},onNotificationButton:function(){var e=this;var a=Personify.utils.Configuration.getCurrentUser();var d=a?a.isLogged():false;if(!d){Personify.utils.ItemUtil.needToLogin()}else{var c=e.getNotificationStore();var b=Ext.Viewport.add({xtype:"notificationview"});b.on({disablenotificationbutton:{fn:e.disableNotificationButton,scope:e},changenotificationlabel:{fn:e.onChangeNotificationLabel,scope:e}});b.getController().getNotification().setStore(c);if(c!=null){b.getController().getLblNumberNoti().setHtml(c.getAllCount());e.getLocalNotificationData(c,b.getController().getLblNumberNoti())}b.show();e.disableNotificationButton(true)}},getLocalNotificationData:function(b,a){var c=this;var d=0;Personify.utils.Sqlite.getNotification(function(e){if(typeof e=="object"&&e.length>0){for(var f=0;f<e.length;f++){b.each(function(g){if(g.get("messageId")==e[f].messageId){if(e[f].isDeleted==1){b.remove(g)}else{g.set("isRead",true);d++}}})}c.getMenuBar().getController().setNotificationButton(b.getCount()-d);if(a){a.setHtml(b.getCount()-d+" unread of "+b.getAllCount())}}})},onChangeNotificationLabel:function(a){this.getMenuBar().getController().setNotificationButton(a)},disableNotificationButton:function(a){this.getMenuBar().getController().disableNotificationButton(a)},updateTitle:function(d,a,c){var b=this;if(typeof(a)=="object"){b.getIconHeader().setHidden(true)}else{b.getIconHeader().setHidden(false)}this.getLabelTitle().setHtml(d);this.getLabelTitle().setCls("labelTitleHeaderPanel "+a);if(c==true){Ext.Viewport.setMasked(false)}},onCopyMeetingList:function(h,c){var a=Personify.utils.ServiceManager.getStoreManager();var b=a.getICalendarStore();var f=Ext.create(b);var i=a.getEventListStore();var g=Ext.create(i);var d=Personify.utils.Configuration.getCurrentUser();if(!d.isLogged()){this.setAgendaListStore(null)}var e=this.getAgendaListStore();h.each(function(j){if(e){for(var k=0;k<e.getCount();k++){var l=e.getAt(k);if(l.get("type")!="PERSONAL"){if(!l.get("sessionID")||l.get("sessionID")==""||l.get("sessionID")=="0"){if(l.get("meetingId")==j.get("productID")){if(!j.get("appointmentId")||j.get("appointmentId")==""){j.set("appointmentId",l.get("appointmentId"))}if(!j.get("isAdded")){j.set("isAdded",true)}break}}}}}g.add(j)});c.each(function(j){f.add(j)});g.setStoreId("meetingListtingMain");f.setStoreId("iCalendarStoreMain")},clearData:function(){this.setAgendaListStore(null)},onCopyScheduleList:function(a){var d=Personify.utils.ServiceManager.getStoreManager();var b=d.getAgendaStore();var c=Ext.create(b);a.each(function(e){e.set("isAdded",true);c.add(e)});this.setAgendaListStore(c);c.setStoreId("agendaStoreListMain")},setTotalItemCheckout:function(){var e=this,b=Personify.utils.Configuration.getCurrentUser(),c=null,a=null;if(b&&b.isLogged()){c=b.get("masterCustomerId"),a=b.get("subCustomerId");var f=e.getShoppingCartStore(),d={MasterCustomerId:c,SubCustomerId:a};f.setDataRequest(d);f.load({callback:function(i,h,j){if(j){Deft.Injector.configure({shoppingCartStore:{value:f}})}else{var g=new Ext.util.DelayedTask(function(){e.setTotalItemCheckout()},e);g.delay(30*1000)}}})}},onTapCartItemCheckout:function(){var b=this;if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(window.plugins.app47){window.plugins.app47.sendGenericEvent("View Shopping Cart")}var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){Ext.Viewport.setMasked({xtype:"loadmask"});a.loadShoppingCartUrl().then({success:function(c){var d=null;if(window.plugins.childBrowser){window.plugins.childBrowser.clearCookies()}if(Ext.os.is.Android){d=window.open(c,"_blank","location=yes,enableViewportScale=yes")}else{d=window.open(c,"_blank","location=no,enableViewportScale=yes")}d.addEventListener("exit",function(){Ext.callback(b.setTotalItemCheckout,b)})},failure:function(){Ext.Msg.alert("","Cannot check out shopping cart.")}}).always(function(){Ext.Viewport.setMasked(false)})}else{Personify.utils.ItemUtil.needToLogin()}},onUpdateEventList:function(c,a){var b=this;Ext.callback(function(){var d=Personify.utils.Configuration.getCurrentUser();var g=b.getPersonify().first().ConfigStore.DefaultListingParamsStore.getAt(0);var f={IsStaffMember:d?d.isStaffMember().toString():false,IsMember:true,FromMonth:"1",ToMonth:"12",OrgID:(d&&d.isLogged())?d.get("organizationId"):g.get("orgId"),OrgUnitID:(d&&d.isLogged())?d.get("organizationUnitId"):g.get("orgUnitId"),MasterCustomerID:(d&&d.isLogged())?d.get("masterCustomerId"):"",SubCustomerID:(d&&d.isLogged())?d.get("subCustomerId"):"0"};var i=Personify.utils.ServiceManager.getStoreManager();var h=i.getICalendarStore();var e=Ext.create(h);e.setDataRequest(f);e.load({callback:function(k,j,l){if(l){b.onCopyMeetingList(e.getAt(0).EventListStore,e)}else{Personify.utils.ItemUtil.cantLoadEvent()}if(c){Ext.callback(c,a,[e])}Ext.Viewport.setMasked(false)},scope:b})})},onUpdateMySchedule:function(d){var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Agenda List")}var f=this;var c={MasterCustomerID:a?a.get("masterCustomerId"):"",SubCustomerID:a?a.get("subCustomerId"):"",MeetingID:""};var g=Personify.utils.ServiceManager.getStoreManager();var e=g.getAgendaStore();var b=Ext.create(e);b.setDataRequest(c);b.load({callback:function(i,h,j){f.onCopyScheduleList(b);if(d==true){f.getView().fireEvent("userlogin",a);f.getView().setMasked(false)}},scope:f})}},onConnectButtonTap:function(){if(Personify.utils.Configuration.getAllowChangeView()){var a=this;Ext.callback(function(){a.openView("Personify.view.Home",null,"Main","homemenuitem")},a,[],1)}else{Ext.Msg.alert("","Please enter the note title.",Ext.emptyFn)}},onLoadNotification:function(){var d=this;var a=d.getCurrentUser();if(!a.isLogged()){return}var b=a.get("masterCustomerId");var f=a.get("subCustomerId");var e={MasterCustomerID:b,SubCustomerID:f};var c=d.getNotificationStore();c.setDataRequest(e);c.load({callback:function(i,h,j){d.setNotificationStore(c);d.getMenuBar().getController().setNotificationButton(c.getAllCount());d.getLocalNotificationData(c);var g=new Ext.util.DelayedTask(function(){d.onLoadNotification()});var k=Personify.utils.Configuration.getConfiguration().getAt(0).HomeStore.get("notificationRefreshInterval");g.delay(k*60*1000)}});Deft.Injector.configure({notificationStore:{value:c}})}});