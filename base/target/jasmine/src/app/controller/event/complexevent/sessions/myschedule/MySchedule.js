Ext.define("Personify.controller.event.complexevent.sessions.myschedule.MySchedule",{extend:"Personify.base.Controller",config:{valueSearch:null,currentDate:null,dateIndex:0,lengthSegment:5,dayJump:1,sessionDates:null},control:{filterSession:{searchbuttontap:"onSearchButtonTapMySchedule",clearicontap:"onClearIconTapMySchedule",onsearchtextchange:"onSearchButtonTapMySchedule",addpersonaltap:"onAddPersonalTap"},calendarSegmentMySchedule:{},myScheduleList:{oneventitemtap:"onEventItemTapMySchedule",deletesession:"onDeleteSessionToAgenda"},backSegmentButtonMySchedule:{tap:"onBackSegmentButtonMySchedule"},nextSegmentButtonMySchedule:{tap:"onNextSegmentButtonMySchedule"}},init:function(){this.callParent(arguments);var a=this.getView().getRecord();this.setRecord(a);this.getFilterSession().getController().hideFilterByTrackButton()},setRecord:function(a){var c=this;if(a){if(a.MeetingAgendaStore&&a.SessionStore.getCount()>0){var f=Personify.utils.ServiceManager.getStoreManager();var b=f.getAgendaStore();var d=Ext.create(b);var e=[];a.MeetingAgendaStore.each(function(g){var h=g.get("sessionID");if(g.get("type")!="PERSONAL"&&(!h||h==""||h=="0")){e.push(g)}});Ext.Array.each(e,function(g){a.MeetingAgendaStore.remove(g)});a.MeetingAgendaStore.each(function(g){d.add(g)});this.getMyScheduleList().setStore(d);c.getArrayDate(d)}else{this.onGetData(a)}this.getView().setRecord(a);this.getView().fireEvent("onupdatesession")}},onGetData:function(d){this.getView().setMasked({xtype:"loadmask"});var i=this;var b=Personify.utils.Configuration.getCurrentUser();if(b&&b.isLogged()){var j=b.data.masterCustomerId;var g=b.data.subCustomerId;var c={SubCustomerID:g,MeetingID:d.get("productID"),MasterCustomerID:j};var a=Personify.utils.ServiceManager.getStoreManager();var f=a.getAgendaStore();var e=Ext.create(f);var h=Ext.create(f);e.setDataRequest(c);e.load({callback:function(l,k,n){i.getView().setMasked(false);if(n){d.MeetingAgendaStore=e;var m=[];d.MeetingAgendaStore.each(function(o){var p=o.get("sessionID");if(o.get("type")!="PERSONAL"&&(!p||p==""||p=="0")){m.push(o)}});Ext.Array.each(m,function(o){d.MeetingAgendaStore.remove(o)});e.each(function(o){h.add(o)});i.getMyScheduleList().setStore(h);i.getArrayDate(h)}},scope:this})}},showCalendarSegment:function(k){var p=this;var n=this.getDateIndex();var m=this.getLengthSegment();var d=this.getCurrentDate();var c=p.getCalendarSegmentMySchedule();c.removeAll();var b=this.getSessionDates();var o=(1/b.length)*100;if(b.length>m){o=(1/m)*100}var a=(b.length<=3)?"F d":"M d";for(var j=n;j<b.length&&j<n+m;j++){var g=Ext.Date.format(b[j],a);var l="btn-date-list";if(d){var f="m/d/Y";var e=Ext.Date.format(d,f);var h=Ext.Date.format(b[j],f);if(e==h){l="btn-date-list-selected"}}c.add([{xtype:"button",text:g,data:b[j],style:{display:"inline-block",width:o+"%"},baseCls:l,listeners:{tap:function(){p.resetSegmentCls();p.onClickDateSegmentMySchedule(this.getData());this.setBaseCls("btn-date-list-selected")}},pressedCls:"p-button-pressing-opacity"}])}},resetSegmentCls:function(){var a=this.getCalendarSegmentMySchedule();var b=a.getItems();for(var c=0;c<b.length;c++){b.getAt(c).setBaseCls("btn-date-list")}},onFilterByDate:function(b){var a=this.getMyScheduleList().getStore();if(a){a.clearFilter();this.updateFilter(a);this.setCurrentDate(b);a.filter(function(d){var c=d.get("startDateTime");var e="m/d/y";if(Ext.Date.format(c,e)==Ext.Date.format(b,e)){return d}})}},updateFilter:function(a){var b=this.getValueSearch();if(b){a.filter(function(c){var d=c.get("title")+" "+c.get("location");if(c.SpeakerSession){c.SpeakerSession.each(function(e){d=d+" "+e.get("name")+" "+e.get("firstName")+" "+e.get("lastName")+" "+e.get("jobTitle")+" "+e.get("employer")})}if(d.toLowerCase().match(b.trim().toLowerCase())){return c}})}},onEventItemTapMySchedule:function(d,c,f,a){if(!a.get("isAdded")){a.set("isAdded",true)}var e=this.getView().getRecord();var g=e.SessionStore;var b=a;g.each(function(h){if(a.get("sessionID")==h.get("sessionID")){b=h;if(!b.get("isAdded")){b.set("isAdded",true)}}});this.getView().getParent().fireEvent("onsessionitemtap",d,c,f,b)},onSearchButtonTapMySchedule:function(a){this.setValueSearch(a);this.takeAwayDaysNoResults()},onClearIconTapMySchedule:function(){var a=this.getMyScheduleList().getStore();a.clearFilter();this.setValueSearch(null);this.getArrayDate(a);this.updateFilter(a)},onSelectDefaultDate:function(c){var f=this.getSessionDates();var e=new Date();var b=this.getCalendarSegmentMySchedule();var a=false;Ext.Array.each(f,function(h){var i="m/d/y";if(Ext.Date.format(h,i)==Ext.Date.format(e,i)){a=true;e=h}});if(a){this.onFilterByDate(e);var d=Ext.Array.indexOf(f,e);var g=d%this.getLengthSegment();if(g==0){d>0?this.setDateIndex(d):this.setDateIndex(d)}else{this.setDateIndex(d-g)}this.showCalendarSegment(c)}else{if(f.length>0){this.onFilterByDate(f[0]);this.resetSegmentCls();b.getAt(0).setBaseCls("btn-date-list-selected")}}this.updateShowHidebutton()},onBackSegmentButtonMySchedule:function(){var a=this.getView().getRecord();var b=this.getDateIndex();if(b>0){this.setDateIndex(b-this.getDayJump());this.showCalendarSegment(a);this.updateShowHidebutton()}},onNextSegmentButtonMySchedule:function(){var a=this.getView().getRecord();var b=this.getDateIndex();var c=this.getLengthSegment();if(b+c<=this.getSessionDates().length){this.setDateIndex(b+this.getDayJump());this.showCalendarSegment(a);this.updateShowHidebutton()}},updateShowHidebutton:function(){var a=this.getView().getRecord();var b=this.getDateIndex();if(b>0){this.getBackSegmentButtonMySchedule().show()}else{this.getBackSegmentButtonMySchedule().hide()}if(b+this.getLengthSegment()<this.getSessionDates().length){this.getNextSegmentButtonMySchedule().show()}else{this.getNextSegmentButtonMySchedule().hide()}},getArrayDate:function(b){b.clearFilter();b.sort({sorterFn:function(e,d){var h=new Date(e.get("startDateTime"));var f=new Date(d.get("startDateTime"));if(h>f){return 1}else{if(h<f){return -1}else{var i=e.get("title");var g=d.get("title");return i>g?1:(i==g?0:-1)}}},direction:"ASC"});var a=this.getView().getRecord();var c=new Array();b.each(function(e){if(e){var d=new Date(e.get("startDateTime"));if(!Personify.utils.ItemUtil.checkDateInDateArray(c,d)){c.push(d)}}});this.setSessionDates(c);this.showCalendarSegment(a);this.onSelectDefaultDate(a)},onClickDateSegmentMySchedule:function(a){this.setCurrentDate(a);this.onFilterByDate(this.getCurrentDate())},takeAwayDaysNoResults:function(){var a=this.getView().getRecord();var b=this.getMyScheduleList().getStore();this.getArrayDate(b);var f=this.getSessionDates();var e=new Array();for(var d=0;d<f.length;d++){this.onFilterByDate(f[d]);if(b.getCount()==0){e.push(f[d])}}for(var c=0;c<e.length;c++){Ext.Array.remove(f,e[c])}this.setSessionDates(f);this.setDateIndex(0);this.showCalendarSegment(a);this.onSelectDefaultDate(a);this.updateFilter(b)},onDeleteSessionToAgenda:function(a){this.getView().fireEvent("deletesession",a)},onAddPersonalTap:function(){var a=this.getView().getRecord();this.getView().fireEvent("openaddpersonal",a)}});