Ext.define("Personify.controller.event.complexevent.detailsession.Rate",{extend:"Personify.base.Controller",control:{titleRate:true,inputRating:true,inputRatingComment:{keyup:"onTextChange",change:"onTextChange",show:"onClearText",clearicontap:"onClearText"},saveRatingComment:{tap:"onTapSaveRatingCommentButton"},panelOfContent:{},closeButton:{tap:"onCloseRateTaped"}},config:{screenHeight:0},init:function(){var a=Personify.utils.Configuration.getConfiguration().getAt(0).EventsStore.get("rateTitleBar");if(a){this.getTitleRate().setHtml(a)}if(this.getView().getShowCloseButton()){this.getCloseButton().show()}if(Ext.os.is.Android){this.setScreenHeight(Ext.getBody().getHeight())}},onTapSaveRatingCommentButton:function(){this.getInputRatingComment().blur();if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}var h=this;var b=Personify.utils.Configuration.getCurrentUser();if(b&&b.isLogged()){Ext.Viewport.setMasked({xtype:"loadmask"});var h=this;var g=h.getInputRatingComment().getValue();var c=h.getInputRating().getValue()+1;var e=this.getView().getRecord()?this.getView().getRecord().get("sessionID"):null;if(!e){e=this.getView().getRecord()?this.getView().getRecord().get("productID"):null}var a=Personify.utils.ServiceManager.getStoreManager();var i=a.getSaveRating();var d=Ext.create(i);var f={InternalKey:null,NavigationKey:null,MasterCustomerId:b.get("masterCustomerId"),SubCustomerId:b.get("subCustomerId"),StarRating:c,Comments:g,ProductId:e};d.setDataRequest(f);d.load({callback:function(k,j,l){if(l){Ext.Msg.alert("","This session has been rated.");h.resetForm();Ext.Viewport.setMasked(false)}else{Ext.Msg.alert("","Please select a star rating and/or enter your comments.");Ext.Viewport.setMasked(false)}},scope:this})}else{Personify.utils.ItemUtil.needToLogin();return}},resetForm:function(){var a=this;a.getInputRatingComment().setValue("");a.getInputRating().setValue(-1)},onTextChange:function(g){var b=Ext.DomQuery.select("textarea",g.element.dom)[0];var e=b.scrollHeight;var c=b.clientHeight;var f=b.selectionEnd;var d=b.textLength;if(c<e){this.getInputRatingComment().setHeight(e);if(f==d){this.getInputRatingComment().getParent().getScrollable().getScroller().scrollToEnd()}else{var a=this.inputRatingComment().getParent().getScrollable().getScroller();a.scrollBy(0,e-c)}}},onClearText:function(){this.inputRatingComment().setHeight(82);this.inputRatingComment().getParent().getScrollable().getScroller().scrollToTop()},onCloseRateTaped:function(){this.getView().fireEvent("close")}});