var globalMapDataAll=null;Ext.define("Personify.controller.event.map.Map",{extend:"Personify.base.Controller",control:{agendaMap:{tap:"getAgendaList"},agendaExhibitor:{tap:"getExhibitorList"},myAgenda:{oneventitemtap:"onTapMyAgenda",deletesession:"onDeleteSessionToAgenda"},myExhibitor:{tapAllExhibitorItem:"onMyExhibitorItemTapped",onTapBtnDelProductAllExhibitor:"onTapBtnDelProductAllExhibitor"},mapPanel:true,mapSegmentedButton:{toggle:"onMapSegmentedButtonToggled"},mapAndAgendaPanel:true,tabMapEvent:true,agendaAndExhibitorCardLayout:true},config:{mapData:null,currentLocation:null},init:function(){var b=this;allExhibitorList=b.getMyExhibitor();if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Map Detail")}b.filterMapsByProduct();var a=b.getView().getRecord();b.setRecord(a)},filterMapsByProduct:function(){var e=this;var a=[];var c=e.getView().getRecord()?e.getView().getRecord().get("productID"):"0";var g=Personify.utils.Configuration.getConfiguration().getAt(0).EventsStore.get("mapData");if(c!="0"){var d=[];if(g!=null&&g.maps!=null&&g.maps.length>0){if(globalMapDataAll===null){for(var b=0;b<g.maps.length;b++){var f=g.maps[b];d.push(f)}globalMapDataAll=d}for(var b=0;b<g.maps.length;b++){var f=g.maps[b];if(f.productId===c){a.push(f)}}if(a!=null&&a.length>0){g.maps=a;e.setMapData(g);e.initMap(g)}}}else{if(globalMapDataAll!=null&&globalMapDataAll.length>0){g.maps=globalMapDataAll}}},initMap:function(g){var e=this;var d=e.getMapSegmentedButton();var h=e.getMapPanel();if(g.maps.length<=0){d.hide()}else{for(var b=0;b<g.maps.length;b++){var f=g.maps[b];f.mapIndex=b;var a="my-schedule-tab";if(b==0){var a="event-schedule-tab"}d.add({text:f.name,flex:1,cls:a,data:f})}d.setPressedButtons([d.getAt(0)])}var c=e.getView().getRecord();if(c){if(!c.get("location")){e.showMarker(e.getView().getBoothNosPresent())}else{e.showMarker(c.get("location"))}}else{e.showMarker()}},setRecord:function(c){var b=this.getView();if(b&&!b.isDestroyed){if(c){var a=Personify.utils.Configuration.getCurrentUser();var g=Personify.utils.ServiceManager.getStoreManager();this.getAgendaAndExhibitorCardLayout().setRecord(c);if(!c.get("location")){this.showMarker(this.getView().getBoothNosPresent())}else{this.showMarker(c.get("location"))}this.getExhibitorStore();var f=this.getView().getMeetingRecord();if(f.MeetingAgendaStore){var e=g.getAgendaStore();var d=Ext.create(e);f.MeetingAgendaStore.each(function(h){if(h.get("type").toUpperCase()!="PERSONAL"){d.add(h)}});d.setGrouper({groupFn:function(i){var h=Personify.utils.ItemUtil.convertStringToDate(i.get("startDateTimeString"));return Ext.Date.format(h,"l, F j")},sorterFn:function(i,h){var l=i.get("startDateTime");var j=h.get("startDateTime");if(l>j){return 1}else{if(l<j){return -1}else{var m=i.get("title");var k=h.get("title");return m>k?1:(m==k?0:-1)}}},direction:"ASC"});this.getMyAgenda().setStore(d);this.getMyAgenda().refresh()}else{if(a&&a.isLogged()){this.getAgendaStore()}else{this.getMapAndAgendaPanel().hide()}}}}},getExhibitorStore:function(){var d=this;var a=Personify.utils.Configuration.getCurrentUser();var b=this.getView().getMeetingRecord();if(b.ExhibitorStore&&b.ExhibitorStore.getCount()>0){d.getAllExhibitorFromSql(b,a,b.ExhibitorStore)}else{var c={ItemsPerPage:"100000",XbtID:b.get("xbtProductID"),XbtParentProduct:b.get("xbtParentProduct"),StartIndex:"0",XbtProductCode:b.get("xbtProductCode")};var g=Personify.utils.ServiceManager.getStoreManager();var e=g.getExhibitorStore();var f=Ext.create(e);f.setDataRequest(c);b.ExhibitorStore=f;f.load({scope:d,callback:function(i,h,j){d.getAllExhibitorFromSql(b,a,f)}})}},getAllExhibitorFromSql:function(g,d,b){var i=this;var a=Personify.utils.ServiceManager.getStoreManager();var c=a.getExhibitorStore();var f=Ext.create(c);var e=g.get("productID")||null;var j=d.get("masterCustomerId");var h=d.get("subCustomerId");Personify.utils.Sqlite.getMyExhibitor(e,j,h,function(k){if(typeof k=="object"&&k.length>0){b.each(function(m){for(var l=0;l<k.length;l++){if(k[l].exhibitorId==m.get("recordId")){if(!m.get("isAdded")){m.set("isAdded",true)}f.add(m);break}}})}g.MyExhibitorStore=f;i.getMyExhibitor().setStore(f)})},getAgendaStore:function(){var a=this.getView().getMeetingRecord();var i=this;this.getMyAgenda().setMasked({xtype:"loadmask"});var d=Personify.utils.Configuration.getCurrentUser();if(d&&d.isLogged()){var j=d.get("masterCustomerId");var g=d.get("subCustomerId");var b=Personify.utils.ServiceManager.getStoreManager();var f=b.getAgendaStore();var e={SubCustomerID:g,MeetingID:a.get("productID"),MasterCustomerID:j};var c=Ext.create(f);var h=Ext.create(f);h.setDataRequest(e);h.load({callback:function(l,k,m){h.each(function(n){if(n.get("type").toUpperCase()!="PERSONAL"){c.add(n)}});c.setGrouper({groupFn:function(o){var n=Personify.utils.ItemUtil.convertStringToDate(o.get("startDateTimeString"));return Ext.Date.format(n,"l, F j")},sorterFn:function(o,n){var r=o.get("startDateTime");var p=n.get("startDateTime");if(r>p){return 1}else{if(r<p){return -1}else{var s=o.get("title");var q=n.get("title");return s>q?1:(s==q?0:-1)}}},direction:"ASC"});i.getMyAgenda().setStore(c);a.MeetingAgendaStore=h;i.getMyAgenda().setMasked(false)},scope:this})}},showMarker:function(c){if(!c){c=this.getCurrentLocation()}var g=this.getMapData();this.clearAllMarker();if(g&&c){var a=g.locations[c];if(a){var d=this.getMapSegmentedButton().getItems().items;for(var b=0;b<d.length;b++){var f=d[b].getData();if(f.mapId==a.mapId){var e=this.getMapSegmentedButton().getPressedButtons();if(e.length&&e[0]==d[b]){this.createMap(f.mapIndex,{x:a.coords[0],y:a.coords[1]})}else{this.getMapSegmentedButton().setPressedButtons([d[b]])}break}}}else{this.createMap(0)}}},createMap:function(c,a){var f=this.getMapPanel();var e=this.getMapData().maps[c];var b=this.getMapData().locations[this.getCurrentLocation()];f.removeAll(true);var d=f.add({xtype:"pinchzoomimage",cls:"map-schema",src:e.image});if(b&&b.mapId==e.mapId){d.updateMarkerPosition({x:b.coords[0],y:b.coords[1]})}else{d.updateMarkerPosition()}},clearAllMarker:function(){Ext.Array.each(this.getMapPanel().getItems().items,function(a){a.showMarker(false)})},getExhibitorList:function(){this.getMyExhibitor().show();this.getMyAgenda().hide()},getAgendaList:function(){this.getMyExhibitor().hide();this.getMyAgenda().show()},onMapSegmentedButtonToggled:function(e,d,a,c){if(a){var b=d.getData().mapIndex;this.createMap(b)}},onMyExhibitorItemTapped:function(d,b,g,a,f,c){this.setCurrentLocation(a.get("boothNos"));this.showMarker();d.select(b)},onTapMyAgenda:function(d,b,g,a,f,c){this.setCurrentLocation(a.get("location"));this.showMarker();d.select(b)},onDeleteSessionToAgenda:function(a){this.getView().getParent().fireEvent("deletesession",a.record,this.getView(),null,a.callback)},refreshMySchedule:function(b){this.getAgendaStore();var a=this.getView().getRecord();if(a.SessionStore){a.SessionStore.each(function(c){if(c.get("sessionID")==b){if(c.get("isAdded")){c.set("isAdded",false)}}})}},onTapBtnDelProductAllExhibitor:function(d){var f=this;var c=Personify.utils.Configuration.getCurrentUser();var b=null,h=d.get("recordId")||null,g=c.get("masterCustomerId")||null,a=c.get("subCustomerId")||null,e=f.getView().getRecord().get("productID")||null;Personify.utils.Sqlite.deleteMyExhibitor(h,e,g,a,function(i){if(i){if(d.get("isAdded")){d.set("isAdded",false)}f.getMyExhibitor().getStore().remove(d);f.getView().fireEvent("removeexhibitorsuccess");Ext.Msg.alert("","Exhibitor has been removed.",Ext.emptyFn)}else{Ext.Msg.alert("","Delete Exhibitor Failed.",Ext.emptyFn)}})},selectItemExhibitor:function(a){if(allExhibitorList&&!allExhibitorList.isDestroyed){var b=allExhibitorList.getStore();if(b){allExhibitorList.deselectAll();allExhibitorList.select(a)}}},selectItemMyAgenda:function(a){if(this.getMyAgenda()&&!this.getMyAgenda().isDestroyed){var b=this.getMyAgenda().getStore();if(b){this.getMyAgenda().deselectAll();this.getMyAgenda().select(a)}}}});