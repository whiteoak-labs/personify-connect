Ext.define("Personify.controller.main.Notifications",{extend:"Personify.base.Controller",requires:["Personify.view.main.NotificationDetails"],control:{lblNumberNoti:true,notification:{itemtap:"onNotificationItemTap"},view:{closenotification:"onCloseNotification"}},init:function(){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Notifications")}},onCloseNotification:function(){this.disableNotificationButton(false)},setNotificationLabel:function(a,b){this.getLblNumberNoti().setHtml(a+" unread of "+b);this.getView().fireEvent("changenotificationlabel",a)},disableNotificationButton:function(a){this.getView().fireEvent("disablenotificationbutton",a)},onNotificationItemTap:function(c,e,i,d,b){var g=this;var f=d.get("messageId");if(b.target.className.indexOf("x-button")>=0){Ext.Msg.confirm("","Are you sure you want to delete?",h);function h(j){Ext.Msg.hide();if(j=="yes"){g.deleteNotification(d)}}}else{var a=Ext.Viewport.add({xtype:"notificationdetails",record:d,viewParent:g.getView()});a.setRecord(d);a.show();g.markReadNotification(d);Personify.utils.Sqlite.insertTableNotification(f,0,function(j){if(j){}})}},deleteNotification:function(a){var d=this;var b=d.getNotification().getStore();var c=a.get("messageId");var e=0;Personify.utils.Sqlite.insertTableNotification(c,1,function(g){if(g){b.remove(a);b.each(function(h){if(h.get("isRead")==true){e++}});var f=b.getCount();d.setNotificationLabel(f-e,f);d.getNotification().refresh()}else{Ext.Msg.alert("Delete Notification","Delete failed.",Ext.emptyFn)}})},markReadNotification:function(a){var d=0;var b=this.getNotification().getStore();var c=b.getCount();b.each(function(e){if(e.get("isRead")==true){d++}else{if(e.get("messageId")==a.get("messageId")){e.set("isRead",true);d++}}});this.setNotificationLabel(c-d,c);this.getNotification().refresh()}});