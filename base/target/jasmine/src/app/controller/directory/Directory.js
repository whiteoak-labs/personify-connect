Ext.define("Personify.controller.directory.Directory",{extend:"Personify.base.Controller",inject:["countryListStore"],config:{contactInfoData:null,purchasedHistoryData:null,participationData:null,relationshipData:null,staffList:null,callTopicList:null,callSubjectList:{},callTypeList:null,selectedRecord:null,countryListStore:null},control:{directoryManagementPanel:{select:"onSelectContactRow"},contactInfoManagementPanel:{updateContactFail:"onUpdateContactFail",updatedContact:"onUpdatedContact",editRecord:"onEditRecord"},staffButtonsPanel:{},contactContainer:{},contactListingStaffButton:{}},init:function(){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Directory")}this.callParent(arguments);this.getDataCountryList()},onSelectContactRow:function(e,c,b,a){this.getStaffButtonsPanel().setHidden(false);var d=this.getContactInfoManagementPanel();if(c.get("details")){this.LoadContactInfo(c,d)}else{var f=this.getCountryListStore();if(f){d.setRecord(c.get("details"));d.setCountryListStore(f)}}},LoadContactInfo:function(e,a){var h=this;var d={ReqMasterCustomerId:Personify.utils.Configuration.getCurrentUser().get("masterCustomerId"),ReqSubCustomerId:Personify.utils.Configuration.getCurrentUser().get("subCustomerId"),IsStaff:Personify.utils.Configuration.getCurrentUser().isStaffMember(),RecordType:e.get("type")};var i=e.get("masterCustomerId"),f=e.get("subCustomerId");if(i!=null&&!(i==="")){d.MasterCustomerId=i}if(f!=null&&!(f==="")){d.SubCustomerId=f}else{d.SubCustomerId="0"}var b=Personify.utils.ServiceManager.getStoreManager();var g=b.getProfileStore();var c=Ext.create(g,{dataRequest:d});c.load({callback:function(k,j,m){if(m&&k.length){var l=k[0];e.data["details"]=l;h.setContactInfoData(l);var n=h.getCountryListStore();a.setCountryListStore(n);a.setRecord(e.get("details"))}else{Ext.Msg.alert("","Cannot get user profile.")}h.getView().setMasked(false)}})},onUpdateContactFail:function(){this.LoadContactInfo(this.getDirectoryManagementPanel().getController().getSelection(),this.getContactInfoManagementPanel())},onUpdatedContact:function(a){this.getDirectoryManagementPanel().getController().updateContactDetails(a)},onEditRecord:function(){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Directory Edit Contact Detail")}},loadStaffStore:function(){var b=Personify.utils.Configuration.getCurrentUser();var c=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);var d={OrgID:b?b.get("organizationId"):c.get("orgId"),OrgUnitID:b?b.get("organizationUnitId"):c.get("orgUnitId")};var f=Personify.utils.ServiceManager.getStoreManager();var a=f.getStaffStore();var e=Ext.create(a);e.setDataRequest(d);e.load();return e},loadCallTypeStore:function(){var c=Personify.utils.ServiceManager.getStoreManager();var b=c.getCallTypeStore();var a=Ext.create(b);a.load();return a},loadCallTopicStore:function(){var c=Personify.utils.ServiceManager.getStoreManager();var a=c.getCallTopicStore();var b=Ext.create(a);b.load();return b},passDataToChildView:function(a){a.setStaffList(this.getStaffList());a.setCallTopicList(this.getCallTopicList());a.setCallSubjectList(this.getCallSubjectList());a.setCallTypeList(this.getCallTypeList())},getDataCountryList:function(){var a=this;if(a.getView()&&!a.getView().isDestroyed){if(a.getCountryListStore().getCount()>0){a.loadStaffData(a)}else{a.loadContryList(a.loadStaffData)}}},loadStaffData:function(b){var a=Personify.utils.Configuration.getCurrentUser().isStaffMember();if(a==true){b.getView().setMasked({xtype:"loadmask"});var e=b.loadStaffStore(),d=b.loadCallTypeStore(),c=b.loadCallTopicStore();if(e){b.setStaffList(e)}if(d){b.setCallTypeList(d)}if(c){b.setCallTopicList(c)}b.getView().setMasked(false)}},loadContryList:function(f){var d=this;var e=Personify.utils.ServiceManager.getStoreManager();var a=e.getCountryStore();var c=Ext.create(a);var b=new Array();c.load({callback:function(j,h,n){var g=e.getProfileTypeStore();var l=Ext.create(g);for(var k=0;k<j.length;k++){var m=j[k];if((m.get("countryCode")!=="ALL")&&(m.get("countryCode")!=="[ALL]")){b.push({text:m.get("countryDescription"),value:m.get("countryCode")})}}l.setData(b);l.sort("text","ASC");d.setCountryListStore(l);if(typeof f=="function"){f(d)}Deft.Injector.configure({countryListStore:{value:l}})}})}});