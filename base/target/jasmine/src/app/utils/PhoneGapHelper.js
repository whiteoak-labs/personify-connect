Ext.define("Personify.utils.PhoneGapHelper",{alias:"PhoneGapHelper",singleton:true,config:{isonline:null},isOnLine:function(){return navigator.onLine},addEventListener:function(a,b){document.addEventListener(a,b,false)},checkConnection:function(){if(this.getIsonline()==null){this.setIsonline(this.isOnLine())}return this.getIsonline()},listenerConnection:function(){var a=this;if(a.checkConnection()==false){Personify.utils.ServiceManager.updateManager("offline")}window.addEventListener("online",a.callbackFn(a,a.onOnLine),false);window.addEventListener("offline",a.callbackFn(a,a.onOffLine),false)},callbackFn:function(b,a){return function(){a.apply(b,arguments)}},onOnLine:function(){this.setIsonline(true);Personify.utils.ServiceManager.updateManager("json")},onOffLine:function(){this.setIsonline(false);Personify.utils.ServiceManager.updateManager("offline");var b=Ext.ComponentQuery.query("loadmask");for(var a=0;a<b.length;a++){b[a].destroy()}},downloadFile:function(f,b,e){var c=this;var d=function(g){console.log("Download file error: "+g)};var a=function(h){var i=b.substring(b.lastIndexOf("."));var g=new FileReader();g.onloadend=function(j){if(j.target.result==null){h.root.getFile(f,{create:true,exclusive:false},function(m){var l=m.fullPath.replace(f,"");m.remove();l=l+f;var k=new FileTransfer();k.download(encodeURI(b),l,function(n){if(typeof e=="function"){e(l)}},function(n){e();Ext.Msg.alert("File download","File download failed",Ext.emptyFn);console.log("Download error: "+n)})},d)}else{e(h.root.fullPath+"/"+f)}};g.readAsDataURL(h.root.fullPath+"/"+f)};window.requestFileSystem(LocalFileSystem.PERSISTENT,0,a,d)},isFileExists:function(b,c){var a=new FileReader();a.onloadend=function(d){if(d.target.result==null){if(c){c(false)}}else{if(c){c(true)}}};a.readAsDataURL(b)},writeFile:function(b,c){var a=function(f){f.root.getFile(b,{create:true,exclusive:false},d,e)};var d=function(f){f.createWriter(function(g){g.write(c)},e)};var e=function(){};window.requestFileSystem(LocalFileSystem.PERSISTENT,0,a,e)},downloadQueue:function(a){var d=this;if(a.url.length>0){var c=a.url[0];var e=a.uuid[0];var b=c.substring(c.lastIndexOf("/"));d.downloadFile(e,c,function(f){Personify.utils.Sqlite.insertTableImage(c,b,e);a.url=a.url.slice(1,a.url.length-1);a.uuid=a.uuid.slice(1,a.uuid.length-1);downloadQueue(a)})}},randomUUID:function(){var b=[],c="0123456789ABCDEF";for(var a=0;a<36;a++){b[a]=Math.floor(Math.random()*16)}b[14]=4;b[19]=(b[19]&3)|8;for(var a=0;a<36;a++){b[a]=c[b[a]]}b[8]=b[13]=b[18]=b[23]="-";return b.join("")},downloadMapImage:function(g){var f=[];for(var b=0,d=g.maps.length;b<d;b++){var c=g.maps[b];var a=c.image;if(a.indexOf("http://")==0||a.indexOf("https://")==0){var e=function(i,j){var h=Ext.create("Deft.promise.Deferred");Personify.utils.PhoneGapHelper.checkMapImage(i,j,h);return h.promise};f.push(e(a,c))}}Deft.Promise.all(f).then({success:function(){},failure:function(){}})},checkMapImage:function(b,c,a){var d="PersonifyCaches/";Personify.utils.Sqlite.getTableImage(b,function(i){if(i.length>0){var e=function(j){c.image=j.root.fullPath+"/"+d+i[0].name;a.resolve()};window.requestFileSystem(LocalFileSystem.PERSISTENT,0,e,Ext.emptyFn)}else{var h=b.substring(b.lastIndexOf("."));var g=Personify.utils.PhoneGapHelper.randomUUID()+h;var f=d+g;Personify.utils.PhoneGapHelper.downloadFile(f,b,function(j){Personify.utils.Sqlite.insertTableImage(b,g,"");c.image=j;a.resolve()})}})}});