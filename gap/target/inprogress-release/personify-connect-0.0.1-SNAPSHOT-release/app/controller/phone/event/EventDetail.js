Ext.define("Personify.controller.phone.event.EventDetail",{extend:"Personify.base.Controller",requires:["Personify.view.phone.store.ConfirmAddToCart"],inject:["personify","shoppingCartStore"],config:{currentUser:null,personify:null,address:null,shoppingCartStore:null},control:{eventToolbar:{onNavigationButtonTap:"onBack",actionButtonTap:"onEventHomeButtonTap"},titleOfEvent:true,description:true,locationFullAddress:{onTapAddressList:"onTapAddressList"},location:true,timeLabel:true,memberPrice:true,labelMemberPrice:true,labelListPrice:true,price:true,saveToMyCalendar:{tap:"onSaveToMyCalendar"},addToMySchedule:{tap:"onAddToMyScheduleTap"},addToCart:{tap:"onAddToCartButtonTap"},registerNow:{tap:"onRegisterNowTap"},alreadyRegistered:true,pricingPanel:true,shareEventPhone:{tap:"onTapShareEventPhone"},rateEventPanel:{gotorate:"onGotoRate"}},init:function(){this.getEventToolbar().getController().setActionText("More");var b=this.getView().getRecord();var a=Personify.utils.Configuration.getCurrentUser();if(b){if(b.get("isConference")){this.getRateEventPanel().hide()}else{if(a.isLogged()){this.getRateEventPanel().show()}else{this.getRateEventPanel().hide()}}}else{this.getRateEventPanel().show()}this.setRecord(b);this.updateAddRemoveButton(b)},onGotoRate:function(){var d=this.getView().getRecord();var b=this.getView().getRecord();var c=d.get("productID");var e=b.get("productID");var a=Ext.create("Personify.view.phone.rate.Rate",{record:b,productId:c,sessionId:e,meetingRecord:d});me=this;Ext.Function.defer(function(){me.getView().fireEvent("requestopendetail",a,null)},400)},updateAddRemoveButton:function(a){if(a.get("isAdded")){this.getAddToMySchedule().setCls("p-phone-button-eventdetail-regiter");this.getAddToMySchedule().setHtml("Delete from My Schedule")}else{this.getAddToMySchedule().setCls("p-phone-button-eventdetail-savetocalendar");this.getAddToMySchedule().setHtml("Add to My Schedule")}},setRecord:function(g){if(g){this.onGetIsUserRegistered(g);var b=Personify.utils.ItemUtil.convertStringToDate(g.get("startDateTimeString"));var f=Personify.utils.ItemUtil.convertStringToDate(g.get("endDateTimeString"));var c=g.get("timeZoneCode");var l=Personify.utils.ItemUtil.getDisplayDateTimeEventDetailPhone(b,f,c);var k=g.get("locationFullAddress");this.setAddress(k);this.getTimeLabel().setHtml(l);this.getTitleOfEvent().setHtml(g.get("shortName"));this.getDescription().setHtml(g.get("shortDescription"));this.getLocationFullAddress().setHtml(k);this.getLocation().setHtml(g.get("location"));if(g.get("isConference")){this.getPricingPanel().hide()}else{var i=g.get("memberPrice");var e=g.get("yourPrice");var h=g.get("price");var j=g.get("yourPriceRateStructure")?g.get("yourPriceRateStructure").trim().toLowerCase():"list";var a=Personify.utils.ItemUtil.getWidthPrice(h,i,7.5);this.getPrice().setHtml(Personify.utils.ItemUtil.formatPurchaseAmount(h,2));var d=Personify.utils.Configuration.getCurrentUser();if(d!=null&&d.isLogged()){if(j=="list"){this.getMemberPrice().setHtml(Personify.utils.ItemUtil.formatPurchaseAmount(i,2));this.getLabelListPrice().setHtml("Your Price: ");this.getPrice().setHtml(Personify.utils.ItemUtil.formatPurchaseAmount(e,2));this.getLabelMemberPrice().setHtml("Member Price: ")}else{this.getMemberPrice().setHtml(Personify.utils.ItemUtil.formatPurchaseAmount(e,2));this.getLabelMemberPrice().setHtml("Your Price: ");this.getLabelListPrice().setHtml("List Price: ")}}else{this.getMemberPrice().setHtml(Personify.utils.ItemUtil.formatPurchaseAmount(i,2))}this.getMemberPrice().setWidth(a);this.getPrice().setWidth(a);this.getPricingPanel().show()}}},onAddToCartButtonTap:function(){var l=this;var b=Personify.utils.Configuration.getCurrentUser();if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(l.getView().getRecord().get("membersOnly")){if(b.isExpiredMember()){Ext.Msg.alert("","For Members Only.",Ext.emptyFn);return}}if(b&&b.isLogged()){var c=l.getView().getRecord().get("productID");var m=b.get("masterCustomerId");var g=b.get("subCustomerId");var a=Personify.utils.ServiceManager.getStoreManager(),h=a.getAddCartStore();var k=l.getView().getRecord();var j=k.get("yourPriceRateStructure")?k.get("yourPriceRateStructure"):"LIST";var f=k.get("yourPriceRateCode")?k.get("yourPriceRateCode"):"STD";var e=k.get("yourPrice");var i={InternalKey:null,NavigationKey:null,MasterCustomerId:m,SubCustomerId:g,ProductId:c,Qty:1,CartSessionId:null,IsAutoRenew:null,UserDefinedField1:null,UserDefinedField2:null,UserDefinedField3:null,MarketCode:null,OrderNo:null,OrderLineNo:null,Price:e,RateCode:f,RateStructure:j,ShipMasterCustomerId:m,ShipSubCustomerId:g,DoNotAutoAddComponents:null};var d=Ext.create(h);d.setDataRequest(i);l.getView().setMasked({xtype:"loadmask"});d.load({callback:function(o,n,s){if(s){var p=d.getAt(0).getData().cartItemId;if(p==-1){Ext.Msg.alert("Fail","Add to shopping cart unsuccessfully.")}else{if(b.getData().masterCustomerId==null){m="";g=""}var q=l.getShoppingCartStore();var r={MasterCustomerId:m,SubCustomerId:g};q.setDataRequest(r);q.load({callback:function(){l.getView().setMasked(false);Deft.Injector.configure({shoppingCartStore:{value:q}});var t=Ext.create("Personify.view.phone.store.ConfirmAddToCart");Ext.Viewport.add(t);t.show()}})}}else{l.getView().setMasked(false)}},scope:this})}else{l.openLoginView()}},onGetIsUserRegistered:function(b,g){var a=Personify.utils.Configuration.getCurrentUser();var e=this;var c={ProductID:b.get("productID"),MasterCustomerID:a?a.get("masterCustomerId"):"0",SubCustomerID:a?a.get("subCustomerId"):"0"};var f=Personify.utils.ServiceManager.getStoreManager();var d=f.getIsUserRegisterStore();isUserRegisterStore=Ext.create(d);isUserRegisterStore.setDataRequest(c);isUserRegisterStore.load({callback:function(i,h,j){if(g){g(true)}if(i.length>0){b.set("registered",i[0].get("userRegistered"))}e.onShowHideButtonAndText(b)},scope:this})},onShowHideButtonAndText:function(){if(this["getAddToCart"]){this.getAddToCart().hide()}this.getRegisterNow().hide();this.getAlreadyRegistered().hide();var c=this.getView().getRecord(),a=Personify.utils.Configuration.getCurrentUser(),b=new Date(),d=Personify.utils.ItemUtil.convertStringToDate(c.get("endDateTimeString"));if(a&&a.isLogged()){if(c.get("registered")){this.getAlreadyRegistered().show()}if(!c.get("isConference")&&b<d&&!c.get("registered")&&c.get("meetingTag")!="Sold Out"&&c.get("meetingTag")!="Cancelled"){var e=Personify.utils.Configuration.getConfiguration().getAt(0).EventsStore.get("mobileRegistration");if(e){this.getAddToCart().show();if(a.get("cCType")&&a.get("cCNumber")&&a.get("cCType")!=""&&a.get("cCNumber")!=""){this.getRegisterNow().show()}}}}},onBack:function(){this.getView().fireEvent("back",this)},onAddToMyScheduleTap:function(){var c=this;var b=this.getView().getRecord();var a=Personify.utils.Configuration.getCurrentUser();if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(a&&a.isLogged()){var d=b.get("isAdded");if(d){Ext.Viewport.setMasked({xtype:"loadmask"});c.getView().fireEvent("removeagenda",b,function(e){if(e){c.getView().fireEvent("updatelistagenda");if(b.get("isAdded")){b.set("isAdded",false)}c.updateAddRemoveButton(b);Ext.Msg.alert("","Meeting has been removed.",Ext.emptyFn);c.getView().fireEvent("refreshagenda",c.getView().getRecord(),false)}Ext.Viewport.setMasked(false)})}else{Ext.Viewport.setMasked({xtype:"loadmask"});c.getView().fireEvent("addagenda",b,b.get("productID"),function(f,e){if(f){if(!b.get("isAdded")){b.set("isAdded",true)}b.set("appointmentId",e);c.updateAddRemoveButton(b);Ext.Msg.alert("","Meeting has been added to your schedule.",Ext.emptyFn)}Ext.Viewport.setMasked(false)})}}else{c.openLoginView()}},openLoginView:function(){var a=Ext.create("Personify.view.phone.login.LoginPhone",null);this.getView().fireEvent("requestopendetail",a,null)},onRefreshData:function(f){var e=this;var a=this.getView().getRecord();var b=Ext.getStore("agendaStoreListMain");if(b){for(var c=0;c<b.getCount();c++){var d=b.getAt(c);if(d.get("type")!="PERSONAL"){if(!d.get("sessionID")||d.get("sessionID")==""||d.get("sessionID")=="0"){if(d.get("meetingId")==a.get("productID")){if(!a.get("appointmentId")||a.get("appointmentId")==""){a.set("appointmentId",d.get("appointmentId"))}if(!a.get("isAdded")){a.set("isAdded",true);break}}}}}e.updateAddRemoveButton(a)}e.onGetIsUserRegistered(a,f)},onRegisterNowTap:function(){var d=this;var b=d.getView().getRecord();var a=Personify.utils.Configuration.getCurrentUser();if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(b.get("membersOnly")){if(a.isExpiredMember()){Ext.Msg.alert("","For Members Only.",Ext.emptyFn);return}}if(a&&a.isLogged()){if(b.get("meetingTag")=="Wait List"){Ext.Msg.show({title:"",message:"Event Capacity Reached. Do you want to be placed on the wait list?",buttons:[{itemId:"cancel",text:"Cancel",ui:"action"},{itemId:"ok",text:"Buy now",ui:"action"}],fn:c,animEl:"elId"});function c(e){Ext.Msg.hide();if(e=="ok"){d.sendRequestRegister(b,a)}}}else{if(b.get("meetingTag")=="Sold Out"){Ext.Msg.alert("","Event and Wait list capacity reached.  Thank you for your interest.",Ext.emptyFn)}else{d.sendRequestRegister(b,a)}}}else{d.openLoginView()}},onSaveToMyCalendar:function(){var h=this;if(window.plugins.calendarPlugin&&window.plugins.calendarPlugin.createEvent){var a={};var e=h.getView().getRecord();var i=e.get("shortName");var d=Personify.utils.ItemUtil.formatJSONDate(Personify.utils.ItemUtil.convertStringToDate(e.get("startDateTimeString")));var b=Personify.utils.ItemUtil.formatJSONDate(Personify.utils.ItemUtil.convertStringToDate(e.get("startDateTimeString")),"g:i a");var g=Personify.utils.ItemUtil.formatJSONDate(Personify.utils.ItemUtil.convertStringToDate(e.get("endDateTimeString")),"g:i a");var c=b+" - "+g;var j=e.get("locationFullAddress");var f="Title: "+i+"\nDate: "+d+"\nTime: "+c+"\nLocation: "+j;a.title=i;a.location=j;a.body=f;a.startDate=e.get("startDateTime");a.endDate=e.get("endDateTime");a.calendarName=i;window.plugins.calendarPlugin.createEvent(a,function(){if(Ext.os.is.iOS){Ext.Msg.alert("","Saved to calendar successfully.",Ext.emptyFn)}},function(){if(Ext.os.is.Android){Ext.Msg.alert("Calendar","To use this function, you have to allow this mobile application to access your contacts",Ext.emptyFn)}else{Ext.Msg.alert("Calendar","To use this function, you have to allow this mobile application to access your contacts by changing iOS settings in Settings > Privacy > Calendars",Ext.emptyFn)}})}},onEventHomeButtonTap:function(){var c=this;var b=this.getView().getRecord();var a="Personify.view.phone.event.ConfrerenceNavigation";this.getView().fireEvent("requestopendetail",a,{record:b})},sendRequestRegister:function(b,a){var e=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);var f=this;var g=Personify.utils.ServiceManager.getStoreManager();f.getView().setMasked({xtype:"loadmask"});var d=Ext.create(g.getOrderFalse());var c={CusAddressID:"",CusAddressType:"",MasterCustomerID:a.get("masterCustomerId"),SubCustomerID:a.get("subCustomerId"),ProductID:b.get("productID"),OrgID:a?a.get("organizationId"):e.get("orgId"),OrgUnitID:a?a.get("organizationUnitId"):e.get("orgUnitId"),CustomPrice:"",ConfirmOrder:"false"};d.setDataRequest(c);d.load({callback:function(k,j,l){f.getView().setMasked(false);if(l){var i=a.isStaffMember();var h={MasterCustomerId:a.get("masterCustomerId"),SubCustomerId:a.get("subCustomerId"),ReqMasterCustomerId:a.get("masterCustomerId"),ReqSubCustomerId:a.get("subCustomerId"),IsStaff:i,RecordType:""};f.getView().setMasked({xtype:"loadmask"});f.loadProfileStore(h,b,d)}else{Ext.Msg.alert("Shopping Cart","Cannot process order at this time.",Ext.emptyFn)}}})},loadProfileStore:function(d,a,c){var e=this;var f=Personify.utils.ServiceManager.getStoreManager();var b=Ext.create(f.getProfileStore());b.setDataRequest(d);b.load({callback:function(u,p,n){e.getView().setMasked(false);var r=[];var y=Ext.create("Personify.base.Store",{model:"Personify.model.jsonp.profile.Addresses"});if(n){if(u[0]){var x=u[0];if(x.EntryProfile.getAt(0)){var w=x.EntryProfile.getAt(0);var k=w.AddressesProfile.getCount();for(var v=0;v<k;v++){var l=w.AddressesProfile.getAt(v);var s=l.get("streetAddress"),m=l.get("locality"),h=l.get("region"),o=l.get("postalCode"),t=l.get("country"),g=l.get("addressesId"),j=l.get("type");r.push({streetAddress:s,locality:m,region:h,postalCode:o,country:t,addressesId:g,type:j})}y.add(r)}}}var q=Ext.create("Personify.view.phone.store.OrderPanel");q.getController().setProduct(a);q.getController().setIsProductEvent(true);q.getController().getOrderTemplate().setStore(c);q.getController().getShippingAddress().setStore(y);if(y.getCount()>0){q.getController().getShippingAddress().select(0)}Ext.Viewport.add(q);q.show();q.getController().setCallback({fn:e.onRegisteredSuccess,scope:e,args:[a]})}})},onRegisteredSuccess:function(a){a.set("registered",true);this.onRefreshData(function(){})},onTapAddressList:function(){var a=this.getAddress();if(a){Personify.utils.ItemUtil.showAddressOnMaps(a)}},onTapShareEventPhone:function(){if(this.getView().getRecord()){Personify.utils.ItemUtil.onShareEvent(this.getView().getRecord())}}});