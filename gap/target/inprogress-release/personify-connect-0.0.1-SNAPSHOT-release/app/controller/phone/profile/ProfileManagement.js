Ext.define("Personify.controller.phone.profile.ProfileManagement",{extend:"Personify.controller.Profile",inject:["countryListStore"],requires:["Personify.view.phone.directory.contactinfo.ContactInfoEditForm","Personify.view.phone.profile.Logout","Personify.view.phone.profile.ProfileSetting","Personify.utils.storemanager.StoreOfflineManager"],control:{profileToolbar:{onNavigationButtonTap:"onBack",actionButtonTap:"onEditButtonTap"},contactinfo:{},viewMySettingButton:{tap:"onViewMySettingButtonTap"},logOutButton:{tap:"onLogOutButtonTap"}},config:{countryListStore:null,currentRecord:null,displayOptionPanelRecord:null,loadedOneData:null,backgroundEditView:null,},init:function(){console.log(new Date().getTime()+" Profile View Start");if(window.plugins.app47){window.plugins.app47.sendGenericEvent("My Profile")}this.getDataCountryList();var b=this,a=b.getContactinfo();a.getController().showListInfo(Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("listInfo"))},onGetData:function(){this.getData()},getDataCountryList:function(){var b=this;if(b.getView()&&!b.getView().isDestroyed){Ext.Viewport.setMasked({xtype:"loadmask"});if(b.getCountryListStore().getCount()>0){var a=b.getLoadedOneData();if(a==null){b.setLoadedOneData(1)}else{Ext.Viewport.setMasked(false)}}else{b.loadContryList(function(){var c=b.getLoadedOneData();if(c==null){b.setLoadedOneData(1)}else{Ext.Viewport.setMasked(false)}})}}},loadContryList:function(f){var d=this;var e=Personify.utils.ServiceManager.getStoreManager();var a=e.getCountryStore();var c=Ext.create(a);var b=new Array();c.load({callback:function(j,h,n){var g=e.getProfileTypeStore();var l=Ext.create(g);for(var k=0;k<j.length;k++){var m=j[k];if((m.get("countryCode")!=="ALL")&&(m.get("countryCode")!=="[ALL]")){b.push({text:m.get("countryDescription"),value:m.get("countryCode")})}}l.setData(b);l.sort("text","ASC");d.setCountryListStore(l);if(typeof f=="function"){f()}Deft.Injector.configure({countryListStore:{value:l}})}})},getData:function(i,j){var e=this,f=e.getView(),d=e.getContactinfo(),h=Ext.create("Personify.utils.storemanager.StoreOfflineManager"),a=Ext.create(h.getProfileStore()),b=Personify.utils.Configuration.getCurrentUser();var g=b.isStaffMember(),c={MasterCustomerId:b.get("masterCustomerId"),SubCustomerId:b.get("subCustomerId"),ReqMasterCustomerId:b.get("masterCustomerId"),ReqSubCustomerId:b.get("subCustomerId"),IsStaff:g,RecordType:""};a.setDataRequest(c);a.on("load",function(p,o){if(p.getCount()==0||j){var q=Personify.utils.ServiceManager.getStoreManager(),n=Ext.create(q.getProfileStore()),m=b.getProfileDisplayOptionStore();n.setDataRequest(c);n.on("load",function(u,t){if(u.getCount()){var s=u.first();e.getView().on("painted",Ext.callback(function(){e.getView().fireEvent("editViewInBackground","Personify.view.phone.directory.contactinfo.ContactInfoEditForm",{record:s,countryListStore:e.getCountryListStore(),listOfInfo:Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("listInfo")})},e,[],1000));d.setRecord(s);if(s.EntryProfile.getCount()){e.setDisplayOptionPanelRecord(s.EntryProfile.first())}else{e.setDisplayOptionPanelRecord(null)}}else{e.setDisplayOptionPanelRecord(null)}f.setStore(n);var r=e.getLoadedOneData();if(r==null){e.setLoadedOneData(1)}else{Ext.Viewport.setMasked(false)}if(i){i()}});n.load()}else{if(p.getCount()){var l=p.first();e.getView().on("painted",Ext.callback(function(){e.getView().fireEvent("editViewInBackground","Personify.view.phone.directory.contactinfo.ContactInfoEditForm",{record:l,countryListStore:e.getCountryListStore(),listOfInfo:Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("listInfo")})},e,[],1000));d.setRecord(l);if(l.EntryProfile.getCount()){e.setDisplayOptionPanelRecord(l.EntryProfile.first())}else{e.setDisplayOptionPanelRecord(null)}}else{e.setDisplayOptionPanelRecord(null)}f.setStore(a);var k=e.getLoadedOneData();if(k==null){e.setLoadedOneData(1)}else{Ext.Viewport.setMasked(false)}if(i){i()}}});a.load()},onBack:function(){var a=this;var b=a.getView();b.fireEvent("back",this,null)},onEditButtonTap:function(){var a=this;Ext.Viewport.setMasked({xtype:"loadmask"});if(a.getBackgroundEditView()==null){Ext.callback(function(){var b=a.getContactinfo().getRecord();a.getView().fireEvent("requestchangeview","Personify.view.phone.directory.contactinfo.ContactInfoEditForm",{record:b,countryListStore:a.getCountryListStore(),listOfInfo:Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("listInfo")});Ext.Viewport.setMasked(false)},a,[],0)}else{Ext.callback(function(){a.getView().fireEvent("loadEditView",a.getBackgroundEditView());Ext.Viewport.setMasked(false)},a,[],10)}},onViewMySettingButtonTap:function(){var a=this;Ext.Viewport.setMasked({xtype:"loadmask"});a.getView().fireEvent("requestchangeview","Personify.view.phone.profile.ProfileSetting",{record:a.getContactinfo().getRecord(),displayOptionPanelRecord:a.getDisplayOptionPanelRecord()});Ext.Viewport.setMasked(false)},onLogOutButtonTap:function(){var a=Ext.Viewport.add({xtype:"logoutphone",centered:true,modal:true,hideOnMaskTap:true});a.addListener("loggedout",this.onLoggedOut,this);a.show()},onLoggedOut:function(){this.getView().fireEvent("loggedout")},refreshRecordAfterEditing:function(a){if(a){if(a.updatedContact){this.getData(false)}else{this.getData(true)}}else{this.getData(false)}},});