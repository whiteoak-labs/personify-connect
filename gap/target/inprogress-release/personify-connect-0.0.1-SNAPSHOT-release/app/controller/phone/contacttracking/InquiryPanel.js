Ext.define("Personify.controller.phone.contacttracking.InquiryPanel",{extend:"Personify.controller.profile.InquiryPanel",control:{activityText:{},topicSelectField:{change:"onTopicSelectFieldChange"},subjectSelectField:{},assignToSelectField:{},callTypeSelectField:{},inquiryPanelToolbar:{onNavigationButtonTap:"onBack",actionButtonTap:"onTapButtonSubmit"}},config:{record:null,delegate:null,currentSubjectSelectField:null,currentContact:null},init:function(){this.callParent(arguments);this.getInquiryPanelToolbar().getController().setActionText("Save");var a=this.getView().config;var e=a.record;var h=a.delegate;var c=a.parentActivityId;var i=a.trackingDetailRecord;var g=a.currentContact;this.setDelegate(h);var j=a.staffList;var f=a.callTopicList;var b=a.callSubjectList;var d=a.callTypeList;this.getView().setStaffList(j);this.getView().setCallTopicList(f);this.getView().setCallSubjectList(b);this.getView().setCallTypeList(d);this.setCurrentContact(g);this.setOptionsForPickLists();if(i){if(c){this.setUIForEditFollowUpRecord()}else{this.setUIForEditTrackingDetail()}}else{if(c){this.setUIForAddFollowUpRecord()}}this.setRecord(e);this.getView().setParentActivityId(c);this.getView().setTrackingDetailRecord(i);this.setTrackingDetailToEdit(i)},onTapButtonSubmit:function(){this.getActivityText().blur();Ext.Viewport.setMasked({xtype:"loadmask"});if(this.getActivityText().getValue()!=""){var g;if(this.getView().getTrackingDetailRecord()){g=this.getView().getTrackingDetailRecord()}else{g=this.getRecord()}var c=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);var h=this;var d=Personify.utils.Configuration.getCurrentUser();var a=Personify.utils.ServiceManager.getStoreManager();var i=Ext.create(a.getInquiryStore());var b=new Date();var f=b.getMonth()+1+"/"+b.getDate()+"/"+b.getFullYear()+" "+b.getHours()+":"+b.getMinutes()+":"+b.getSeconds();var e={InternalKey:null,NavigationKey:null,MasterCustomerId:g.get("masterCustomerId"),SubCustomerId:g.get("subCustomerId"),ActivityId:(this.getView().getTrackingDetailRecord()!=null)?g.get("activityId"):0,ActivityDate:(this.getView().getTrackingDetailRecord()!=null)?g.get("activityDate"):f,ActivityText:this.getActivityText().getValue(),CallTypeCode:this.getCallTypeSelectField().getValue(),StaffUserId:this.getAssignToSelectField().getValue(),PersonContacted:(this.getView().getTrackingDetailRecord())?g.get("personContacted"):g.get("preferredName"),KeyCode:null,MarketCode:null,ListCode:null,ResolvedFlag:null,ResolvedDate:null,Topic:this.getTopicSelectField().getValue(),Subject:this.getSubjectSelectField().getValue(),PrivateFlag:null,OrgID:d?d.get("organizationId"):c.get("orgId"),OrgUnitID:d?d.get("organizationUnitId"):c.get("orgUnitId"),ParentActivityId:this.getView().getParentActivityId(),ContactDetail:null,Followup:null};i.setDataRequest(e);i.load({callback:function(l,k,n){if(n){Ext.Viewport.setMasked(false);Ext.Msg.alert("Inquiry","Successfully.",Ext.emptyFn);h.updateTrackingRecordFromView();if(h.getDelegate()){h.getDelegate().resetParams();if(h.getView().getTrackingDetailRecord()){h.getDelegate().loadContactData(h.getView().getRecord(),true)}else{h.getDelegate().loadContactData(h.getRecord(),true)}var j=h.getView();if(j&&j.destroy!=Ext.emptyFn){var m={};if(h.getView().getTrackingDetailRecord()){m.topic=h.getTopicSelectField().getValue();m.subject=h.getSubjectSelectField().getValue();m.assignTo=h.getAssignToSelectField().getValue();m.callType=h.getCallTypeSelectField().getValue();m.activityText=h.getActivityText().getValue();m.subjectList=h.getView().getCallSubjectList();m.refresh=true;h.onBack(m)}else{if(j.getParentActivityId()!=null){m.activityId=j.getParentActivityId();m.subjectList=h.getView().getCallSubjectList();m.refresh=true;h.onBack(m)}else{m.subjectList=h.getView().getCallSubjectList();h.onBack(m)}}}}}else{Ext.Viewport.setMasked(false);Ext.Msg.alert("Inquiry","Failed.",Ext.emptyFn)}}})}else{Ext.Viewport.setMasked(false);Ext.Msg.alert("Inquiry","Please input activity text.",Ext.emptyFn)}},setOptionsForPickLists:function(){this.getView().setMasked({xtype:"loadmask"});var d=this.getView().getCallTopicList();var c=this.getView().getCallTypeList();var f=this.getView().getStaffList();if(d){var a=new Array();d.each(function(g){if(g!=null){a.push({text:g.get("description"),value:g.get("code")})}});this.getTopicSelectField().setOptions(a)}if(c){var e=new Array();c.each(function(g){if(g!=null){e.push({text:g.get("description"),value:g.get("code")})}});this.getCallTypeSelectField().setOptions(e)}if(f){var b=new Array();f.each(function(g){if(g!=null){b.push({text:g.get("staffName"),value:g.get("staffId")})}});this.getAssignToSelectField().setOptions(b)}},setHeaderText:function(a){this.getAddNewPanelHeaderText().setHtml(a)},setSubmitButtonText:function(a){this.getButtonSubmit().setText(a)},setTrackingDetailToEdit:function(b){if(b){var a=this.getView();if(a&&a.destroy!=Ext.emptyFn){this.callParent(arguments)}}},loadCallSubjectStore:function(d){if(d){var b=this;var c=new Array();c.push({text:"",value:""});var g=Personify.utils.ServiceManager.getStoreManager();var f=g.getCallSubjectStore();var e=Ext.create(f);var a={type:"rest",url:Personify.utils.ServiceManager.getUrlWS("utilCallSubject")+"?$filter=Subsystem eq 'MRM' and Type eq ('CALL_TOPIC') and Code eq ('"+d+"')",headers:Personify.utils.ServiceManager.getHeaders(),reader:{implicitIncludes:true,type:"json",rootProperty:"d"}};e.setProxy(a);e.load({callback:function(j,i,k){if(k){b.getView().getCallSubjectList()[d]=e;b.getView().config.callSubjectList[d]=e;e.each(function(l){if(l!=null){c.push({text:l.get("description"),value:l.get("subcode")})}});if(b.getTopicSelectField().getValue()===d){b.getSubjectSelectField().setOptions(c)}if(b.getCurrentSubjectSelectField()){b.getSubjectSelectField().setValue(b.getCurrentSubjectSelectField());b.setCurrentSubjectSelectField(null)}var h=b.getView().config.trackingDetailRecord}b.getView().setMasked(false)}})}},onTopicSelectFieldChange:function(d,f,a){if(f){var c=this;var g=this.getView().getCallSubjectList();if(g[f]){var b=g[f];var e=new Array();e.push({text:"",value:""});b.each(function(h){if(h!=null){e.push({text:h.get("description"),value:h.get("subcode")})}});c.getSubjectSelectField().setOptions(e);if(c.getCurrentSubjectSelectField()){c.getSubjectSelectField().setValue(c.getCurrentSubjectSelectField());c.setCurrentSubjectSelectField(null)}c.getView().setMasked(false)}else{this.loadCallSubjectStore(f)}var b=g[f]}},setUIForEditTrackingDetail:function(){this.getInquiryPanelToolbar().setTitle("Edit Tracking Detail");this.getInquiryPanelToolbar().getController().setActionText("Save")},setUIForEditFollowUpRecord:function(){this.getInquiryPanelToolbar().setTitle("Edit Follow-up Record");this.getInquiryPanelToolbar().getController().setActionText("Save")},setUIForAddFollowUpRecord:function(){this.getInquiryPanelToolbar().setTitle("Add Follow-up Record")},onBack:function(a){var b=this;var c=b.getView();if(a){a.subjectList=b.getView().getCallSubjectList()}c.fireEvent("back",b,a)},updateTrackingRecordFromView:function(){var a=this.getView().getTrackingDetailRecord();if(a){a.set("topicString",this.getTopicSelectField().getRecord().get("text"));a.set("topic",this.getTopicSelectField().getValue());a.set("subject",this.getSubjectSelectField().getValue());a.set("assignTo",this.getAssignToSelectField().getValue());a.set("callType",this.getCallTypeSelectField().getValue());a.set("activityText",this.getActivityText().getValue())}}});