Ext.define("Personify.controller.phone.store.StoreManagement",{extend:"Personify.controller.Store",inject:["allProductStore","shoppingCartStore"],control:{storeToolbar:{onNavigationButtonTap:"onBack"},featuredItemCarousel:true,storeDetails:{itemtap:"onItemTapStoreDetail"},searchStorePanel:{seachclearicontap:"onSearchStore",onsearchtextchange:"onSearchStore",tapsearchbutton:"onSearchStore"},filterStorePanel:{clearFilter:"onTapClearFilter"},detailPanel:{onFilterProduct:"onFilterProduct",onTapSearchProduct:"onTapSearchProduct",onTapButtonShoppingCart:"onTapButtonShoppingCart"},filterProductList:{itemtap:"onFilterProductList"},filterProductPanel:true,actionButton:{},view:{show:"onShow"}},config:{productStore:null,productClassFilter:null,textFilter:null,allProductStore:null,shoppingCartStore:null},init:function(){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Product List")}var a=this;this.getStoreToolbar().getController().setActionCls("p-phone-button-storeshoppingcart");this.getActionButton().hide()},destroy:function(){this.getShoppingCartStore().un("load",this.onLoadDone,this);return this.callParent(arguments)},onShow:function(){if(this.getShoppingCartStore().getCount()!=0){this.getActionButton().setText(this.getShoppingCartStore().getCount())}else{this.getActionButton().setText("0")}var a=Personify.utils.Configuration.getCurrentUser();if(!a.isLogged()){this.getActionButton().setText("0")}},onBack:function(){var a=this;thisView=a.getView();thisView.fireEvent("back",this)},onGetData:function(){var a=this;a.getView().setMasked({xtype:"loadmask"});Ext.callback(function(){if(a.getAllProductStore().getAllCount()>0){var d=a.getAllProductStore();a.displayData(d.getAt(0).ProductItem,d.getAt(0).ProductClassItem)}else{var f=Personify.utils.ServiceManager.getStoreManager();var d=Ext.create(f.getProductListStore());var b=Personify.utils.Configuration.getCurrentUser();var e=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);var c={IsMember:true,IsStaffmember:b?b.isStaffMember():"false",ItemsPerPage:"10",OrgID:b?b.get("organizationId"):e.get("orgId"),OrgUnitID:b?b.get("organizationUnitId"):e.get("orgUnitId"),ProductClassCode:"ALL",StartIndex:"1",MasterCustomerID:b?b.get("masterCustomerId"):"",SubCustomerID:b?b.get("subCustomerId"):"0"};d.setDataRequest(c);d.load({callback:function(h,g,i){if(i){d.load({callback:function(k,j,l){if(l){if(k[0]){a.setAllProductStore(d);Deft.Injector.configure({allProductStore:{value:d}});a.displayData(k[0].ProductItem,k[0].ProductClassItem)}else{a.displayNoData()}}else{a.displayNoData()}}})}else{a.displayNoData()}}})}},a,[],1)},displayData:function(g,e){g.clearFilter();g.setRemoteFilter(false);this.setProductStore(g);var h=g.getAllCount();var c=[];for(var d=0;d<h;d++){var j=g.getAt(d);if(j.get("featuredProduct")==true){c.push(j)}}var f=Personify.utils.ServiceManager.getModelManager();var a=Ext.create("Ext.data.Store",{model:f.getProductModel(),sorters:[{property:"featuredProductSortOrder",direction:"ASC"},{property:"productID",direction:"ASC"}]});a.add(c);var b=this.setDataCarousel(a,this.getFeaturedItemCarousel(),1,a.getCount());this.getStoreDetails().setStore(g);this.getView().setMasked(false);this.getFilterProductList().setStore(e)},displayNoData:function(){var a=this.getStoreDetails();var b=this.getFeaturedItemCarousel();b.setHtml("No data");a.setMasked(false);b.setMasked(false)},setDataCarousel:function(l,m,h,j){var g=this;var k=[],e=0;var b=[];var f=Personify.utils.ServiceManager.getModelManager();var a=Ext.create("Ext.data.Store",{model:f.getProductModel()});for(var d=0;d<j;d++){if(l.getAt(d)!=null){k.push(l.getAt(d))}e++;if(e%h==0||e==j){a.add(k);var c=Ext.create("Personify.view.phone.store.FeatureItemTemplate",{store:a});c.on({itemtap:{fn:g.onFeaturedItemCarouselTap,scope:g,item:l.getAt(d)}});b.push(c);k=[];a=Ext.create("Ext.data.Store",{model:f.getProductModel()})}}m.setMasked(false);m.removeAll(true);m.add(b);m.setActiveItem(0);return e},onFeaturedItemCarouselTap:function(g,b,f,a,d,c){this.openMoreDetailPage(a)},onItemTapStoreDetail:function(b,c,g,a,f,d){this.openMoreDetailPage(a)},openMoreDetailPage:function(a){this.getView().fireEvent("requestchangeview","Personify.view.phone.store.MoreDetailPage",{record:a})},onFilterProduct:function(a){var b=this.getFilterProductPanel();b.showBy(a,"tl-tr?")},onFilterProductList:function(d,b,g,a,f,c){this.onFilterStore(a.get("text"));this.getFilterProductPanel().hide();this.getFilterStorePanel().getController().updateLabel('<span style = "font-size: 12px; float: left; margin-top: 3px; margin-right: 7px;">FILTER: </span>'+a.get("text").toUpperCase());this.getFilterStorePanel().show()},updateFilters:function(c){var a=this.getStoreDetails().getStore();if(a){a.clearFilter();var b=[];if(this.getProductClassFilter()){b.push(this.getProductClassFilter())}if(this.getTextFilter()){b.push(this.getTextFilter())}if(b.length>0){a.filter(b)}}},onFilterStore:function(a){if(a==null){this.setProductClassFilter(null)}else{this.setProductClassFilter({filterFn:function(b){if(b.get("productClass").trim().toLowerCase()==a.trim().toLowerCase()){return b}}})}this.updateFilters(a)},onTapClearFilter:function(){this.setProductClassFilter(null);this.setTextFilter(null);this.updateFilters();this.getFilterProductPanel().hide();this.getFilterStorePanel().hide()},onUpdateCurrentUser:function(){this.getAllProductStore().removeAll();this.loadData()},onTapSearchProduct:function(){var a=this;searchStorePanel=a.getSearchStorePanel();if(searchStorePanel.isHidden()){searchStorePanel.setHidden(false)}else{searchStorePanel.setHidden(true)}},onTapButtonShoppingCart:function(){var a=Personify.utils.Configuration.getCurrentUser();if(a&&a.isLogged()){this.getView().fireEvent("checkoutshoppingcart",this)}else{var b=Ext.create("Personify.view.phone.login.LoginPhone");b.addListener("updatecurrentuser",this.onUpdateCurrentUser,this);this.getView().fireEvent("requestchangeview",b,null)}}});