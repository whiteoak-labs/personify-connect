Ext.define("Personify.controller.profile.Website",{extend:"Personify.controller.profile.template.InfoTemplate",requires:["Personify.view.profile.contactinfo.website.WebsiteList","Personify.view.profile.contactinfo.WebsiteEditForm"],config:{typeList:null,typeListToRemove:null,recordsForDelete:new Array(),errorMessage:"\n- Wrong website format:",blankErrorMessage:"- Website field cannot be empty",canAddMoreFlag:null},control:{infoContainer:{typelistchange:"onTypeListChange",textboxchange:"onTextboxChange",deleteCommand:"onDeleteCommand"}},updateEditMode:function(c){this.callParent(arguments);me=this;this.getInfoContainer().removeAll(true,true);if(c==true){this.getView().setHidden(false);var d=new Array();var b=this.getView().getRecord();this.setTypeList(b.get("urlLocationList").split(","));var a=b.EntryProfile.getAt(0).UrlsProfile;a.each(function(e){var f=Ext.create("Personify.view.profile.contactinfo.WebsiteEditForm");f.getController().setTypeList(me.getTypeList());f.setRecord(e);me.getInfoContainer().add(f);d.push(e.get("type"))});this.setTypeListToRemove(d);this.addEmptyItem();this.updateTypeListForAllEditItems()}else{this.setRecord(this.getView().getRecord())}},onTextboxChange:function(h,f,e,b,d){var a=this.getInfoContainer();var i=Personify.utils.ServiceManager.getModelManager();var c=i.getProfileUrlsModel();var g=new Ext.create(c,{primary:e,value:b,type:d});if(!f){h.setRecord(g);this.addEmptyItem();this.updateTypeListForAllEditItems()}},onDeleteCommand:function(a,b){if(a.get("urlId")!=""){this.getRecordsForDelete().push(a)}Ext.Array.remove(this.getTypeListToRemove(),a.get("type"));this.updateTypeListForAllEditItems();this.getInfoContainer().remove(b,true);var d=this.getInfoContainer().getInnerItems();var c=d[d.length-1];if(c.getRecord()&&!c.getRecord().get("primary")){this.addEmptyItem()}},onTypeListChange:function(a,b,c){this.callParent(arguments);if(a.getRecord()){if(a.getRecord().get("urlId")!=""){this.getRecordsForDelete().push(a.getRecord().copy())}a.getRecord().set("urlId","")}},addEmptyItem:function(){var b=this.checkTypeList();if(b.length==0){this.setCanAddMoreFlag(false);return}else{this.setCanAddMoreFlag(true)}var a=this.getInfoContainer();var b=Ext.Array.difference(this.getTypeList(),this.getTypeListToRemove());var c=Ext.create("Personify.view.profile.contactinfo.WebsiteEditForm");c.getController().setTypeList(b);this.getTypeListToRemove().push(b[0]);a.add(c)},setRecord:function(a){if(a){if(a.EntryProfile.getAt(0).UrlsProfile.getCount()>0){this.getInfoContainer().removeAll(true,true);var b=Ext.create("Personify.view.profile.contactinfo.website.WebsiteList",{scrollable:null,docked:"top",disableSelection:true,style:"margin-left: 50px;"});b.setStore(a.EntryProfile.getAt(0).UrlsProfile);this.getInfoContainer().add(b);this.getView().setHidden(false)}else{this.getView().setHidden(true)}}},setPresenterRecord:function(e){this.getInfoContainer().removeAll(true,true);if(e&&e.get("url")&&e.get("url")!=""){this.callParent(arguments);var f=Personify.utils.ServiceManager.getStoreManager();var c=f.getProfileUrlsStore();var b=Ext.create(c);var a=Personify.utils.ServiceManager.getModelManager();websiteModelString=a.getProfileUrlsModel();websiteModel=Ext.ModelManager.getModel(websiteModelString);b.add(websiteModel);b.getAt(0).set("type","");b.getAt(0).set("value",e.get("url"));var d=Ext.create("Personify.view.profile.contactinfo.website.WebsiteList",{scrollable:null,disableSelection:true});d.setStore(b);this.getInfoContainer().add(d)}},updateParams:function(b){this.updateAllRecordsForEditItems();var a=[];var j=[];var c=this.getRecordsForDelete();var h=this.getInfoContainer().getItems().items;var g=this.getCanAddMoreFlag();var f=(g==false)?h.length:h.length-1;for(var d=0;d<f;d++){var e=h[d].getRecord();a.push(e);Ext.Array.each(c,function(k,i,l){if(k.get("urlId").toUpperCase()===e.get("urlId").toUpperCase()){j.push(k)}})}c=Ext.Array.difference(c,j);Ext.Array.each(c,function(k,i,l){k.set("markForDelete",true)});a=a.concat(c);urlsParams=this.getParameterList(a);if(urlsParams){b.Urls=urlsParams}},getParameterList:function(b){var d=new Array();for(var c=0;c<b.length;c++){var a={InternalKey:b[c].get("internalKey"),NavigationKey:b[c].get("navigationKey"),Id:b[c].get("urlId"),Value:b[c].get("value"),Type:b[c].get("type"),Primary:b[c].get("primary"),MarkForDelete:(b[c].get("markForDelete")==null)?false:b[c].get("markForDelete"),ProfileEmails:b[c].get("profileEmails"),ProfileRoles:b[c].get("profileRoles"),Urls:null,Emails:b[c].get("emails"),Roles:b[c].get("roles")};d[c]=a}return d}});