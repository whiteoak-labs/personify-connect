Ext.define("Personify.controller.profile.ContactDetailPanel",{extend:"Personify.base.Controller",requires:["Personify.view.profile.contactlisting.InquiryPanel"],config:{delegate:null,callSubjectList:null},control:{detailPanelHeaderText:{},followUpRecordsHeader:{},contactDetailView:{},followUpList:{itemtap:"onFollowUpItemTap"},callTypeCodeText:{},activityText:{},topicText:{},subjectText:{},contactedText:{},ownerText:{},editTrackingDetailButton:{tap:"onEditTrackingDetailButtonTap"},addFollowUpButton:{tap:"onAddFollowUpButtonTap"},view:{hide:"onHide"}},onEditTrackingDetailButtonTap:function(){var a=Ext.create("Personify.view.profile.contactlisting.InquiryPanel");this.passDataToChildView(a);a.getController().setOptionsForPickLists();a.getController().setDelegate(this.getDelegate());if(this.getView().getCurrentContact()){a.setRecord(this.getView().getCurrentContact())}if(this.getView().getRecord()&&this.getView().getRecord().ContactDetailStore){a.setTrackingDetailRecord(this.getView().getRecord().ContactDetailStore.getAt(0));a.getController().setUIForEditTrackingDetail()}else{a.setTrackingDetailRecord(this.getView().getRecord());a.setParentActivityId(this.getView().getRecord().get("parentActivityId"));a.getController().setUIForEditFollowUpRecord()}this.getView().destroy();Ext.Viewport.add(a);a.show()},onAddFollowUpButtonTap:function(){var a=Ext.create("Personify.view.profile.contactlisting.InquiryPanel");this.passDataToChildView(a);a.getController().setOptionsForPickLists();a.getController().setDelegate(this.getDelegate());a.getController().setHeaderText("Add Follow-up record");a.getController().setSubmitButtonText("Create");if(this.getView().getRecord()){a.setParentActivityId(this.getView().getRecord().ContactDetailStore.getAt(0).get("activityId"))}if(this.getView().getCurrentContact()){a.getController().setRecord(this.getView().getCurrentContact())}this.getView().destroy();Ext.Viewport.add(a);a.show()},setRecord:function(g){if(this.getView()){if(g.ContactDetailStore){var e=g.ContactDetailStore.getAt(0)}else{var e=g}var i=this;i.getActivityText().setHtml(e.get("activityText"));i.getTopicText().setHtml('<span class="p-text-trackingDetail-label">Topic:</span>');i.getSubjectText().setHtml('<span class="p-text-trackingDetail-label">Subject:</span>');i.getContactedText().setHtml('<span class="p-text-trackingDetail-label">Contacted:</span><span class="p-text-trackingDetail-value">'+e.get("personContacted")+"</span>");i.getOwnerText().setHtml('<span class="p-text-trackingDetail-label">Owner:</span>');var d=this.getView().getStaffList();if(d){d.each(function(o){if(o&&o.get("staffId")==e.get("staffUserId")){i.getOwnerText().setHtml('<span class="p-text-trackingDetail-label">Owner:</span><span class="p-text-trackingDetail-value">'+o.get("staffName")+"</span>")}})}var m=this.getView().getCallTypeList();if(m){m.each(function(o){if(o&&o.get("code")==e.get("callTypeCode")){i.getCallTypeCodeText().setHtml(o.get("description"))}})}var c;var b=this.getView().getCallTopicList();if(b){b.each(function(o){if(o&&o.get("code")==e.get("topic")){i.getTopicText().setHtml('<span class="p-text-trackingDetail-label">Topic:</span><span class="p-text-trackingDetail-value">'+o.get("description")+"</span>");c=e.get("topic")}})}if(c){var l=i.getView().config.callSubjectList;var k;if(l[c]){k=l[c];var j=new Array();j.push({text:"",value:""});k.each(function(o){if(o&&o.get("subcode")==e.get("subject")){i.getSubjectText().setHtml('<span class="p-text-trackingDetail-label">Subject:</span><span class="p-text-trackingDetail-value">'+o.get("description")+"</span>")}})}else{var i=this;var j=new Array();j.push({text:"",value:""});var a=Personify.utils.ServiceManager.getStoreManager();var n=a.getCallSubjectStore();var k=Ext.create(n);var h={type:"rest",url:Personify.utils.ServiceManager.getUrlWS("utilCallSubject")+"?$filter=Subsystem eq 'MRM' and Type eq ('CALL_TOPIC') and Code eq ('"+c+"')",headers:Personify.utils.ServiceManager.getHeaders(),reader:{implicitIncludes:true,type:"json",rootProperty:"d"}};k.setProxy(h);k.load({callback:function(p,o,q){if(q){if(k){k.each(function(r){if(r&&r.get("subcode")==e.get("subject")){i.getSubjectText().setHtml('<span class="p-text-trackingDetail-label">Subject:</span><span class="p-text-trackingDetail-value">'+r.get("description")+"</span>")}})}i.getView().config.callSubjectList[c]=k}Ext.Viewport.setMasked(false)}})}}if(g.FollowupStore){var f=g.FollowupStore;f.each(function(o){if(b){b.each(function(p){if(p&&p.get("code")==o.get("topic")){o.set("topicString",p.get("description"))}})}});this.getFollowUpList().setStore(f)}}},onFollowUpItemTap:function(g,c,i,b,h,d){var f=this;var a=Ext.create("Personify.view.profile.contactlisting.ContactDetailPanel");a.getController().setUIForViewFolloupDetail();a.getController().setDelegate(f.getDelegate());f.passDataToChildView(a);if(b){a.setRecord(b)}a.setCurrentContact(f.getView().getCurrentContact());this.getView().destroy();Ext.Viewport.add(a);a.show()},passDataToChildView:function(a){a.setStaffList(this.getView().getStaffList());a.setCallTopicList(this.getView().getCallTopicList());a.setCallTypeList(this.getView().getCallTypeList());a.setCallSubjectList(this.getView().getCallSubjectList())},setUIForViewFolloupDetail:function(){this.getDetailPanelHeaderText().setHtml("Follow-up Record's Detail");this.getAddFollowUpButton().setHidden(true);this.getEditTrackingDetailButton().setText("Edit Follow-up Record");this.getFollowUpRecordsHeader().setHidden(true)},onHide:function(){this.getView().destroy()}});