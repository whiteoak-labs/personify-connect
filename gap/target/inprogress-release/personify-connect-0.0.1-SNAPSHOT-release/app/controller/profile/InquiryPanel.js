Ext.define("Personify.controller.profile.InquiryPanel",{extend:"Personify.base.Controller",control:{activityText:{},topicSelectField:{change:"onTopicSelectFieldChange"},subjectSelectField:{},assignToSelectField:{},callTypeSelectField:{},buttonSubmit:{tap:"onTapButtonSubmit"},addNewPanelHeaderText:{}},config:{record:null,delegate:null,currentSubjectSelectField:null},onTapButtonSubmit:function(){if(this.getActivityText().getValue()!=""){var g;if(this.getView().getTrackingDetailRecord()){g=this.getView().getTrackingDetailRecord()}else{g=this.getRecord()}var c=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);var h=this;var d=Personify.utils.Configuration.getCurrentUser();var a=Personify.utils.ServiceManager.getStoreManager();var i=Ext.create(a.getInquiryStore());var b=new Date();var f=b.getMonth()+1+"/"+b.getDate()+"/"+b.getFullYear()+" "+b.getHours()+":"+b.getMinutes()+":"+b.getSeconds();var e={InternalKey:null,NavigationKey:null,MasterCustomerId:g.get("masterCustomerId"),SubCustomerId:g.get("subCustomerId"),ActivityId:(this.getView().getTrackingDetailRecord()!=null)?g.get("activityId"):0,ActivityDate:(this.getView().getTrackingDetailRecord()!=null)?g.get("activityDate"):f,ActivityText:this.getActivityText().getValue(),CallTypeCode:this.getCallTypeSelectField().getValue(),StaffUserId:this.getAssignToSelectField().getValue(),PersonContacted:(this.getView().getTrackingDetailRecord())?g.get("personContacted"):g.get("preferredName"),KeyCode:null,MarketCode:null,ListCode:null,ResolvedFlag:null,ResolvedDate:null,Topic:this.getTopicSelectField().getValue(),Subject:this.getSubjectSelectField().getValue(),PrivateFlag:null,OrgID:d?d.get("organizationId"):c.get("orgId"),OrgUnitID:d?d.get("organizationUnitId"):c.get("orgUnitId"),ParentActivityId:this.getView().getParentActivityId(),ContactDetail:null,Followup:null};i.setDataRequest(e);i.load({callback:function(k,j,l){if(l){Ext.Msg.alert("Inquiry","Successfully.",Ext.emptyFn);if(h.getDelegate()){h.getDelegate().resetParams();if(h.getView().getTrackingDetailRecord()){h.getDelegate().loadContactData(h.getView().getRecord(),true);if(h.getView().getTrackingDetailRecord().get("parentActivityId")!=h.getView().getTrackingDetailRecord().get("activityId")||h.getView().getParentActivityId()!=null){h.getDelegate().onItemTap(null,null,null,null,null,null)}}else{h.getDelegate().loadContactData(h.getRecord(),true);if(h.getView().getParentActivityId()){h.getDelegate().onItemTap(null,null,null,null,null,null)}}}}else{Ext.Msg.alert("Inquiry","Failed.",Ext.emptyFn)}h.getView().destroy()}})}else{Ext.Msg.alert("Inquiry","Please input activity text.",Ext.emptyFn)}},setOptionsForPickLists:function(){var d=this.getView().getCallTopicList();var c=this.getView().getCallTypeList();var f=this.getView().getStaffList();if(d){var a=new Array();d.each(function(g){if(g!=null){a.push({text:g.get("description"),value:g.get("code")})}});this.getTopicSelectField().setOptions(a)}if(c){var e=new Array();c.each(function(g){if(g!=null){e.push({text:g.get("description"),value:g.get("code")})}});this.getCallTypeSelectField().setOptions(e)}if(f){var b=new Array();f.each(function(g){if(g!=null){b.push({text:g.get("staffName"),value:g.get("staffId")})}});this.getAssignToSelectField().setOptions(b)}},setHeaderText:function(a){this.getAddNewPanelHeaderText().setHtml(a)},setSubmitButtonText:function(a){this.getButtonSubmit().setText(a)},setTrackingDetailToEdit:function(a){this.setCurrentSubjectSelectField(a.get("subject"));this.getActivityText().setValue(a.get("activityText"));this.getTopicSelectField().setValue(a.get("topic"));this.getAssignToSelectField().setValue(a.get("staffUserId"));this.getCallTypeSelectField().setValue(a.get("callTypeCode"))},loadCallSubjectStore:function(d){if(d){var b=this;b.getView().setMasked({xtype:"loadmask"});var c=new Array();c.push({text:"",value:""});var g=Personify.utils.ServiceManager.getStoreManager();var f=g.getCallSubjectStore();var e=Ext.create(f);var a={type:"rest",url:Personify.utils.ServiceManager.getUrlWS("utilCallSubject")+"?$filter=Subsystem eq 'MRM' and Type eq ('CALL_TOPIC') and Code eq ('"+d+"')",headers:Personify.utils.ServiceManager.getHeaders(),reader:{implicitIncludes:true,type:"json",rootProperty:"d"}};e.setProxy(a);e.load({callback:function(i,h,j){if(j){b.getView().config.callSubjectList[d]=e;e.each(function(k){if(k!=null){c.push({text:k.get("description"),value:k.get("subcode")})}});if(b.getTopicSelectField().getValue()===d){b.getSubjectSelectField().setOptions(c)}if(b.getCurrentSubjectSelectField()){b.getSubjectSelectField().setValue(b.getCurrentSubjectSelectField());b.setCurrentSubjectSelectField(null)}}b.getView().setMasked(false)}})}},onTopicSelectFieldChange:function(d,f,a){if(f){var c=this;var g=this.getView().config.callSubjectList;if(g[f]){var b=g[f];var e=new Array();e.push({text:"",value:""});b.each(function(h){if(h!=null){e.push({text:h.get("description"),value:h.get("subcode")})}});c.getSubjectSelectField().setOptions(e);if(c.getCurrentSubjectSelectField()){c.getSubjectSelectField().setValue(c.getCurrentSubjectSelectField());c.setCurrentSubjectSelectField(null)}}else{this.loadCallSubjectStore(f)}}},setUIForEditTrackingDetail:function(){this.setHeaderText("Edit Tracking Detail");this.setSubmitButtonText("Save")},setUIForEditFollowUpRecord:function(){this.setHeaderText("Edit Follow-up Record");this.setSubmitButtonText("Save")}});