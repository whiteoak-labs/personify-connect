Ext.define("Personify.controller.profile.Address",{extend:"Personify.controller.profile.template.InfoTemplate",requires:["Personify.view.profile.contactinfo.address.AddressList","Personify.view.profile.contactinfo.AddressEditForm"],config:{countryListStore:null,stateDictionary:{},typeList:null,typeListToRemove:null,recordsForDelete:new Array(),errorMessage:"\n- Wrong address format:",blankErrorMessage:"- Street address field cannot be empty",primaryAddressCountry:null,primaryAddressRegion:null},control:{infoContainer:{typelistchange:"onTypeListChange",deleteCommand:"onDeleteCommand"},infoContainerReadOnly:true,buttonAddAddress:{tap:"onTapButtonAddAddress"}},onTypeListChange:function(a,b){this.callParent(arguments);a.getRecord().set("type",b)},updateEditMode:function(i,j){this.callParent(arguments);var g=this;if(j){g.setCountryListStore(j)}g.getInfoContainer().removeAll(true,true);g.getInfoContainerReadOnly().removeAll(true,true);if(i==true){this.getView().setHidden(false);var d=new Array();var h=g.getView().getRecord();g.setTypeList(h.get("addressTypeList").split(","));g.setPrimaryAddressCountry(h.get("defaultCountry"));var b=Personify.utils.ServiceManager.getStoreManager();var e=b.getProfileAddressesStore();var c=Ext.create(e);var k=Ext.create(e);var a=h.EntryProfile.getAt(0).AddressesProfile;if(a){a.each(function(l){d.push(l.get("type"));if(l.get("canEdit")==true){c.add(l)}else{k.add(l)}if(l.get("primary")&&l.get("primary")==true){if(l.get("country")==g.getPrimaryAddressCountry()){g.setPrimaryAddressRegion(l.get("region"))}}});g.setTypeListToRemove(d)}if(k&&k.getCount()>0){var f=Ext.create("Personify.view.profile.contactinfo.address.AddressList",{scrollable:null,disableSelection:true,style:"margin-left: 50px; margin-bottom: 20px;"});f.setStore(k);f.on({itemtap:{fn:g.onTapAddressList,scope:g}});g.getInfoContainerReadOnly().add(f)}if(c&&c.getCount()>0){if(c){c.each(function(l){var m=Ext.create("Personify.view.profile.contactinfo.AddressEditForm",{style:"margin-bottom: 20px;"});m.setStateDictionary(g.getStateDictionary());m.getController().hideCountryList(false,j);m.getController().setTypeList(g.getTypeList());m.setRecord(l);g.getInfoContainer().add(m);m.getController().onCountryListChange(null,l.get("country"),l.get("country"))});g.updateTypeListForAllEditItems()}}g.getButtonAddAddress().setHidden(g.checkTypeList().length==0)}else{g.setRecord(g.getView().getRecord());g.getButtonAddAddress().setHidden(true)}},onTapButtonAddAddress:function(){this.addEmptyItem();this.updateTypeListForAllEditItems();this.getButtonAddAddress().setHidden(this.checkTypeList().length==0)},onDeleteCommand:function(a,b){if(a.get("addressesId")!=""){this.getRecordsForDelete().push(a)}Ext.Array.remove(this.getTypeListToRemove(),a.get("type"));this.updateTypeListForAllEditItems();this.getButtonAddAddress().setHidden(this.checkTypeList().length==0);this.getInfoContainer().remove(b,true)},validation:function(){return""},addEmptyItem:function(){var g=this.checkTypeList();if(g.length==0){return}var f=this.getInfoContainer();var h=Ext.create("Personify.view.profile.contactinfo.AddressEditForm",{style:"margin-bottom: 20px;"});h.getController().setEmptyItem(true);h.getController().hideCountryList(false,this.getCountryListStore());var c=Personify.utils.ServiceManager.getModelManager();var b=c.getProfileAddressesModel();var d=Ext.create(b);d.set("type",g);h.getController().setTypeList(g);h.setRecord(d);this.getTypeListToRemove().push(g[0]);f.add(h);var e=this.getPrimaryAddressCountry();if(e){h.getController().setCountryForEmptyItem(e)}var a=this.getPrimaryAddressRegion();if(a){h.getController().setRegionForEmptyItem("")}},setRecord:function(a){var c=this;if(a){if(a.EntryProfile.getAt(0).AddressesProfile.getCount()>0){this.getInfoContainer().removeAll(true,true);this.getInfoContainerReadOnly().removeAll(true,true);var b=Ext.create("Personify.view.profile.contactinfo.address.AddressList",{scrollable:null,disableSelection:true,style:"margin-left: 50px;"});b.setStore(a.EntryProfile.getAt(0).AddressesProfile);b.on({itemtap:{fn:c.onTapAddressList,scope:c}});this.getInfoContainer().add(b);this.getButtonAddAddress().setHidden(true);this.getView().setHidden(false)}else{this.getView().setHidden(true)}}else{this.getButtonAddAddress().setHidden(false)}},updateParams:function(f){this.updateAllRecordsForEditItems();var b=new Array();var e=this.getRecordsForDelete();var d=this.getInfoContainer().getItems().items;for(var c=0;c<d.length;c++){var a=d[c].getRecord();b.push(a);Ext.Array.each(e,function(h,g,i){if(h.get("addressesId")===a.get("addressesId")){Ext.Array.remove(i,h)}})}Ext.Array.each(e,function(h,g,i){h.set("markForDelete",true)});b=b.concat(this.getRecordsForDelete());addressesParams=this.getParameterList(b);if(addressesParams){f.Addresses=addressesParams}},getParameterList:function(b){var d=new Array();for(var c=0;c<b.length;c++){var a={InternalKey:b[c].get("internalKey"),NavigationKey:b[c].get("navigationKey"),Id:b[c].get("addressesId"),Type:b[c].get("type"),StreetAddress:b[c].get("streetAddress"),Address2:b[c].get("address2"),Address3:b[c].get("address3"),Address4:b[c].get("address4"),Locality:b[c].get("locality"),Region:b[c].get("region"),PostalCode:b[c].get("postalCode"),Country:b[c].get("country"),Formatted:b[c].get("formatted"),CanEdit:true,Primary:b[c].get("primary"),MarkForDelete:(b[c].get("markForDelete")==null)?false:b[c].get("markForDelete"),Address:b[c].get("address"),ProfileAddresses:b[c].get("profileAddress"),Addresses:null,Geo:null};d[c]=a}return d},onTapAddressList:function(h,c,g,b,f,d){var a="";if(b.get("fomatted")){a=b.get("formatted")}else{a=Personify.utils.ItemUtil.getAddress(b)}Personify.utils.ItemUtil.showAddressOnMaps(a)}});