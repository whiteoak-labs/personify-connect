Ext.define("Personify.controller.login.LoginForm",{extend:"Personify.base.Controller",control:{usernameTextfield:{keyup:"onFieldKeyUp"},passwordTextfield:{keyup:"onFieldKeyUp"},goButton:{tap:"onLogin"},forgotPassword:{tap:"onForgotPassword"},rememberMeCheckbox:true},onFieldKeyUp:function(a,c){var b=this;if(c.event.keyCode==13){b.onLogin()}},onLogin:function(){if(!Personify.utils.PhoneGapHelper.checkConnection()){Ext.Msg.alert("Connection","Please check your internet connection.",Ext.emptyFn);return}var d=this,e=d.getUsernameTextfield(),c=d.getPasswordTextfield();if(e.getValue()&&c.getValue()){var a={UserName:e.getValue(),Password:c.getValue()};var g=Personify.utils.ServiceManager.getStoreManager(),f=g.getUserStore(),b=Ext.create(f,{dataRequest:a});Personify.utils.Configuration.setUserNameAndPassword(e.getValue(),c.getValue());b.load({callback:function(j,i,k){if(k&&j.length){var h=j[0];h.setUserName(e.getValue());h.setPassword(c.getValue());Ext.callback(d.onLoginSuccess,d,[h])}else{Ext.callback(d.onLoginFailure,d)}},scope:this})}else{Ext.Viewport.setMasked(false);Ext.Msg.alert("Login","Username and password are required.",Ext.emptyFn)}},onLoginSuccess:function(b){var c=this;var d=c.getView();if(!b){c.onLoginFailure();return false}this.getView().fireEvent("loginsuccess",b);if(window.plugins.applicationPreferences){if(c.getRememberMeCheckbox().isChecked()){window.plugins.applicationPreferences.set("keepUserLogin",b.raw,function(){},function(){});window.plugins.applicationPreferences.set("checked","1",function(){},function(){});window.plugins.applicationPreferences.set("username",c.getUsernameTextfield().getValue(),function(){},function(){});window.plugins.applicationPreferences.set("password",c.getPasswordTextfield().getValue(),function(){},function(){})}else{window.plugins.applicationPreferences.set("keepUserLogin","",function(){},function(){});window.plugins.applicationPreferences.set("checked","0",function(){},function(){});window.plugins.applicationPreferences.set("username","",function(){},function(){});window.plugins.applicationPreferences.set("password","",function(){},function(){})}}if(window.plugins.pushNotification){var a=window.plugins.pushNotification;a.setAlias(b.data.userKey)}d.hide();c.getUsernameTextfield().setValue("");c.getPasswordTextfield().setValue("")},onLoginFailure:function(){Ext.Msg.alert("Login","Username or password is invalid.",Ext.emptyFn)},onLoginButtonTap:function(b){var a=document.createEvent("Event");a.initEvent("lockoutView",true,true);document.dispatchEvent(a)},onForgotPassword:function(){var b=this,c=b.getView();c.fireEvent("forgotPassword");if(Ext.os.is.Android){var a=Personify.utils.Configuration.getConfiguration().getAt(0).ProfileStore.get("forgotPasswordUrl");window.open(a,"_blank","location=yes,enableViewportScale=yes")}else{Ext.Msg.alert("Personify","Please contact your association representative for assistance in changing your password",Ext.emptyFn)}}});