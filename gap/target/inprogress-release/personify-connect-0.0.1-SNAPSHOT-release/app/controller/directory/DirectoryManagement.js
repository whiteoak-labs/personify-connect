Ext.define("Personify.controller.directory.DirectoryManagement",{extend:"Personify.base.Controller",inject:["personify","currentUser"],config:{personify:null,currentUser:null,params:null,flagNeedLoad:null,itemPerPage:null,totalDirectoryResult:0},control:{searchDirectoryPanel:true,directorylist:true,view:{painted:"onPaint"}},init:function(){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Directory List")}Ext.Viewport.setMasked({xtype:"loadmask"});var a=this;Ext.callback(a.onGetData,a,[],1)},onPaint:function(){var a=this;if(a.getFlagNeedLoad()){a.getDirectorylist().getStore().removeAll(true);Ext.Viewport.setMasked({xtype:"loadmask"});Ext.callback(a.onGetData,a,[],1)}},onGetData:function(){Ext.Viewport.setMasked({xtype:"loadmask"});var c=this,a=Personify.utils.Configuration.getCurrentUser(),b=Personify.utils.Configuration.getConfiguration().getAt(0).ConfigStore.DefaultListingParamsStore.getAt(0);Ext.callback(function(){var e=Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("defaultSearchTerm");var f=Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("itemPerPage");var d=Ext.ComponentQuery.query("#directorySearchField");if(d[0]){var g=c.getView().getController().getDirectorySearchField();if(g&&g.getValue()!=""){e=g.getValue()}}var h={MasterCustomerID:a.get("masterCustomerId"),SubCustomerID:a.get("subCustomerId"),OrgID:a?a.get("organizationId"):b.get("orgId"),OrgUnitID:a?a.get("organizationUnitId"):b.get("orgUnitId"),SearchTerm:e,StartIndex:1,ItemsPerPage:f,IsStaffMember:a.isStaffMember().toString(),IsMember:a.isMember().toString()};c.setParams(h);c.loadDirectoryMangementModel();Ext.Viewport.setMasked(false);c.setFlagNeedLoad(null)},c,[],1)},onSearchTextChanged:function(c){if(window.plugins.app47){window.plugins.app47.sendGenericEvent("Directory Search")}var b=this;if(c){var a=Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("minSearchCharacters");if(c.length>=a){if(b.getDirectorylist().getSelectionCount()>0){b.getDirectorylist().deselectAll()}b.getParams()["SearchTerm"]=c;b.getParams()["StartIndex"]=1;b.getDirectorylist().getStore().removeAll(true);b.loadDirectoryMangementModel()}else{Ext.Msg.alert("","Please enter at least "+a+" characters to search")}}},loadDirectoryMangementModel:function(){var a=this;a.getView().setMasked({xtype:"loadmask"});var d=Personify.utils.ServiceManager.getStoreManager();var c=d.getDirectoryStore();var b=Ext.create(c,{dataRequest:a.getParams()});b.load({callback:function(h,g,i){if(i&&h.length){var f=h[0];var e=a.getDirectorylist().getStore();if(e){e.suspendEvents();f.DirectoryStore.each(function(j){if(j){e.add(j)}},a);e.sync();e.resumeEvents(true);a.getDirectorylist().setStore(e);a.getDirectorylist().refresh()}else{a.getDirectorylist().setStore(f.DirectoryStore);e=f.DirectoryStore}if(f){a.setTotalDirectoryResult(f.get("totalResults"))}}a.getView().setMasked(false)},scope:a})},onClearIconTap:function(){if(this.getDirectorylist().getSelectionCount()>0){this.getDirectorylist().deselectAll()}this.getParams()["SearchTerm"]="";this.getParams()["StartIndex"]=1;this.getDirectorylist().getStore().removeAll(true);this.loadDirectoryMangementModel()},setStore:function(a){this.getDirectorylist().setStore(a)},updateContactDetails:function(a){this.getDirectorylist().getSelection()[0]["data"]["details"]=a},onNextButtonTap:function(){var a=this.getDirectorylist().getStore();var b=0;if(a){b=a.getCount()}if(b<this.getTotalDirectoryResult()){this.getParams()["StartIndex"]=this.getParams()["StartIndex"]+(Personify.utils.Configuration.getConfiguration().getAt(0).DirectoryStore.get("itemPerPage"));this.loadDirectoryMangementModel()}},getSelection:function(){return this.getDirectorylist().getSelection()[0]}});